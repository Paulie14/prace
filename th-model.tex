
% \include{snippet_preamble}
% \usepackage{enumitem}

In this chapter we develop mathematical background for our model.
The model formulation is built from a~simple 2d Dirichlet problem to a~fully coupled 1d-2d and 1d-3d problem.

% We start with some general notation and considerations. 

% \cite{koppl_vidotto_2018}
% \notePE{(according to MOX-Report No. 36/2017
% Mathematical modelling, analysis and numerical approximation of second order elliptic problems with inclusions,
% Koeppl, T.; Vodotto, E.; Wohlmuth, B.; Zunino, P.)}
% \begin{equation}
%     \vc v\cdot\vc n = \avg{\vc v\cdot \vc n}_w + \{\vc v\cdot \vc n\}_w \quad \textrm{on } \Gamma_w,
% \end{equation}
% where
% \begin{eqnarray}
%     \avg{\vc v\cdot \vc n}_w &=& \frac{1}{{\abs{\Gamma_w}}} \int_{\Gamma_w} \vc v\cdot \vc n, \\
%     \int_{\Gamma_w} \{\vc v\cdot \vc n\}_w &=& 0. \\
% \end{eqnarray}
\section{Mixed formulation}
The theory of mixed and mixed-hybrid finite element method is described in general in the well known book by 
Brezzi and Fortin~\cite{brezzi_mixed_1991}. 
The formulation, its stability and error estimates are studied there.

The actual application of the mixed-hybrid method in the model of flow in fractured porous 
media with combined mesh dimensions is studied in several articles.
In \cite{brezina_mixed-hybrid_2010} the weak formulation and its discretization using the lowest-order Raviart-Thomas finite 
elements is written. The linear system is then reduced using the Schur complement (original idea in~\cite{maryska_mixed-hybrid_1995})
and solved efficiently with preconditioned conjugate gradients method.
In \cite{sistek_bddc_2015} the theoretic part includes the weak and the discrete formulation and also shows
the uniqueness of the discrete solution. Further, the authors discuss application and results of BDDC 
(Balancing Domain Decomposition by Constraints) method used for solution of the linear system.

In \cite{brezina_2012} a~mortar-like method is used to deal with the discrete coupling between equations on incompatible 1D-2D meshes 
of different dimensions. The drawback of this approach is that it uses continuous approximation of velocity, so
it cannot approximate the discontinuity of the velocity over the fractures accurately enough.


\section{Mixed Dirichlet Problem}

At the beginning, we consider a steady 2d problem with a single singularity present in a~domain $\Omega\subset\R^2$.
We take Problem \ref{thm:problem_2d} and restrain ourselves to a~single aquifer, therefore ommitting the index $m$,
and a~single well $w$ perpendicular to the aquifer. Further we fix the pressure in the well,
so we do not solve the 1d part of the problem
and we can focus on the properties of the mixed form in the aquifer domain.
We consider the aquifer thickness $\delta_2=1$ for simplicity.
Due to this assumption we also ommit the dimension index further in this section (we consider only $d=2$).

We let the exterior boundary be  $\Gamma_{ext}=\Gamma_D$, where we prescribe the Dirichlet boundary condition, for simplicity.
The boundary of the domain $\prtl\Omega=\Gamma_D \cup \Gamma_w$ then consists of only two parts: the exterior boundary $\Gamma_D$
and the interior boundary $\Gamma_w$.

Let us now solve
\thmproblem{ \label{thm:prob_mixed_simple}
Find $\vc u$ and $p$ satisfying
\begin{subequations}
\begin{align}
    \vc K^{-1} \vc u + \nabla p &= 0 && \textrm{in } \Omega, \label{eqn:mixed_form_1}\\
    \div\, \vc u &= f && \textrm{in } \Omega, \label{eqn:mixed_form_2}\\
    \avg{\vc u \cdot \vc n}_w &= \sigma_w (\avg{p}_w - P_w) && \textrm{on } \Gamma_w, \label{eqn:mixed_form_3}\\
    \fluct{p_2}_w &= g_w && \forall w\in\mathcal{W}, \label{eqn:mixed_form_press_fluct}\\
    p &= g_{D} && \textrm{on } \Gamma_{D} \label{eqn:mixed_form_4}.
\end{align}
\end{subequations}
}

We consider similar assumptions on the input data as in the primary form in Section \ref{sec:primary_form}.
In particular, the hydraulic conductivity tensor $\vc K$ is an invertible
positive definite 2x2 matrix, for which we denote
\begin{equation}
    \underline{k}^{-1} = \inf\limits_{\bx\in\Omega}\lambda_{\min}(\vc K^{-1}), \quad
    \overbar{k}^{-1}   = \sup\limits_{\bx\in\Omega}\lambda_{\max}(\vc K^{-1}), \qquad
     0 < \underline{k}^{-1} \leq \overbar{k}^{-1}.
\end{equation}
% \begin{eqnarray}
%     0 < \underline{k} &=& \inf\limits_{x\in\Omega}\lambda_{\min}(\vc K^{-1}),\\
%     \underline{k} \leq \overbar{k} &=& \sup\limits_{x\in\Omega}\lambda_{\max}(\vc K^{-1})
% \end{eqnarray}
the minimum and maximum eigenvalues of the inverse matrix.
% We consider $f\in L_2(\Omega)$ to be the source term and
The constant $P_w\in\R$ is the fixed pressure inside the well, $\sigma_w\in\R$, $\sigma_w>0$ is the
permeability coefficient between the well and the 2d domain.
% Function $g_D\in L_2(\Gamma_D)$ is the 
% prescribed Dirichlet boundary condition for pressure on the exterior boundary.
The condition \eqref{eqn:mixed_form_3} relates the average of the normal flux over $\Gamma_w$ in the outward direction
to the pressure difference. Due to the fixed pressure $P_w$, this equation resembles a~Robin type boundary condition.

\subsection{Weak Form of Mixed problem}
We define the spaces for velocity and pressure,
so we can derive the weak form of Problem \ref{thm:prob_mixed_simple}:
\begin{eqnarray}    
    V &=& H(\div,\Omega), \label{eqn:space_V}\\
    Q &=& L_2(\Omega). \label{eqn:space_Q}
\end{eqnarray}
We test the equations \eqref{eqn:mixed_form_1} and \eqref{eqn:mixed_form_2}
\begin{align}
    \int_\Omega \vc u \vc K^{-1} \vc v \dd\bx
    + \int_{\prtl\Omega} p \,(\vc v \cdot \vc n) \dd s
    - \int_\Omega p\,\div\, \vc v \dd\bx &= 0 && \forall \vc v\in V, \label{eqn:mixed_weak_1}\\
    - \int_\Omega q\,\div\, \vc u \dd\bx &= - \int_\Omega fq \dd\bx &&  \forall q\in Q. \label{eqn:mixed_weak_2}
\end{align}
%
In the first equation, we split the boundary integral and on the interior boundary we apply the average decomposition
\begin{align}
    \int_{\Gamma_w} p \,(\vc v \cdot \vc n) \dd s
    = \int_{\Gamma_w} \avg{p}_w \avg{\vc v \cdot \vc n}_w + \fluct{p}_w \fluct{\vc v \cdot \vc n}_w \dd s.
%     = \avg{p}_w \avg{\vc v \cdot \vc n}_w \abs{\Gamma_w}
\end{align}
% where we can substitute from the boundary condition \eqref{eqn:mixed_form_3}
Next, the boundary conditions \eqref{eqn:mixed_form_3}-\eqref{eqn:mixed_form_4} are applied, 
% \begin{equation}
%     \avg{p}_w = \frac{1}{\sigma_w}\avg{\vc u\cdot \vc n}_w + P_w.
% \end{equation}
to obtain a~saddle point problem
%
\thmproblem{ \label{thm:prob_mixed_weak_simple}
Find $\vc u\in V$ and $p\in Q$ satisfying
\begin{subequations}
\begin{align}
    a(\vc{u},\vc v) + b(\vc v, p) &= \langle G, \vc v\rangle_{V'\times V} &&
        \forall \vc v\in V, \label{eqn:mixed_saddle1}\\
    b(\vc{u}, q) &= \langle F, q \rangle_{Q'\times Q} &&\forall q \in Q
        \label{eqn:mixed_saddle2},
\end{align}
\end{subequations}
with the bilinear forms $a: V\times V \rightarrow \R$, $b: V\times Q \rightarrow \R$
\begin{subequations}
\begin{align}
 a(\vc u, \vc v)=& \int_\Omega \vc u \vc K^{-1} \vc v \dd\bx
                   + \frac{1}{\sigma_w}\avg{\vc u\cdot \vc n}_w \avg{\vc v\cdot \vc n}_w \abs{\Gamma_w},\\
%
 b(\vc v, p)=& - \int_\Omega p \,\div\, \vc v \dd\bx,\\
%
 \langle G, \vc v\rangle_{V'\times V} =&
        -\int_{\Gamma_D} g_{D} (\vc v \cdot \vc n) \dd s - P_w\avg{\vc v\cdot\vc n}_w \abs{\Gamma_w}
        -\int_{\Gamma_w} g_w \fluct{\vc v \cdot \vc n}_w \dd s,\\
 \langle F, q\rangle_{Q'\times Q} =& - \int_{\Omega} f q \dd\bx.
\end{align}
\end{subequations}
}

\noindent We denote $\langle \cdot, \cdot \rangle_{V'\times V}$ duality between $V$ and its dual space $V'$.
The bilinear forms $a,b$ then define the operators
\begin{equation}
\begin{aligned}
A:\;\;&   V \rightarrow V', & \langle A\vc u,\vc v \rangle_{V'\times V} =&\; a(\vc u,\vc v) && \forall \vc u \in V,\, \forall \vc v \in V,\\ 
B:\;\;&   V \rightarrow Q', & \langle B \vc v,q    \rangle_{Q'\times Q} =&\; b(\vc v,q)     && \forall \vc v\in V,\, \forall q \in Q,\\
B^T:\;\;& Q \rightarrow V', & \langle \vc v, B^T q \rangle_{V\times V'} =&\; b(\vc v,q)     && \forall \vc v\in V,\, \forall q \in Q,
\end{aligned}
\end{equation}
and \eqref{eqn:mixed_saddle1}-\eqref{eqn:mixed_saddle2} can be rewritten in
\begin{subequations}
\begin{align}
 A\vc{u} + B^Tp &= G \;\textrm{  in } V', \label{eqn:mixed_saddle_operator1} \\
 B\vc u &= F  \;\textrm{  in } Q'. \label{eqn:mixed_saddle_operator2}
\end{align}
\end{subequations}

% TODO: move to discretization, comment on neglecting the term on rhs and NONCONFORMITY
In the space $V$, notice the assumption on the normal trace where the fluctuation part is neglected: $\{\vc v\cdot \vc n\}_w \approx 0$.
This comes with the idea of a real situation where the well radius is considered very small and the pressure, and so the flux,
is considered nearly constant along the well edge.

\begin{lemma} \label{lem:mixed_continuity_ab}
The bilinear forms $a,b$ in Problem \ref{thm:prob_mixed_weak_simple} are continuous.
\end{lemma}
\begin{proof}
To bound the average terms in the form $a$,
we define auxiliary smooth function $\psi\in C^{\infty}(\overbar\Omega)$ with boundary values
\begin{equation}
  \psi(\bx) =
  \begin{cases}
    1 & \textrm{ on } \Gamma_w, \\
    0 & \textrm{ on } \Gamma_D.
  \end{cases}
\end{equation}
Then for $\vc v\in V$ we have
\begin{align}
  \avg{\vc v \cdot\vc n}_w = \int_{\Gamma_w} \vc v \cdot\vc n \psi \dd s = 
    \int_{\partial\Omega} \left( \psi \vc v \right) \cdot\vc n \dd s & \nonumber\\
    = \int_{\Omega} \div\left( \psi \vc v \right) \dd\bx
    = \int_{\Omega} \psi\, \div\, &\vc v \dd\bx + \int_{\Omega} \vc v \cdot \grad\psi \dd\bx \nonumber\\
    \leq \norm{\psi}_{L_2(\Omega)} \norm{\div\,\vc v}_{L_2(\Omega)}& + \norm{\grad\psi}_{L_2(\Omega)} \norm{\vc v}_{L_2(\Omega)}
    \leq C_w \norm{\vc v}_{H(\div,\Omega)}
\end{align}
with a constant $C_w(\partial\Omega)$. Then we obtain the following bound
\begin{multline} \label{eqn:form_a_bound}
    \abs{a(\vc u,\vc v)} \leq \overbar{k}^{-1}\, \norm{\vc u}_{L_2(\Omega)} \norm{\vc v}_{L_2(\Omega)}
        + \sigma_w \abs{\Gamma_w} \avg{\vc u\cdot\vc n}_w \avg{\vc v\cdot\vc n}_w\\
        \leq \alpha_2 \norm{\vc u}_{H(\div,\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall \vc u,\vc v\in V,
\end{multline}
with a constant $\alpha_2 \left(\overbar{k}^{-1}, \sigma_w, \partial\Omega\right)$.
%\notePE{I don't understand the last step of Theorem 90 proof, p.103, 'numpde.pdf' to bound the average terms.
% easy: the phi terms must be <= 1 and for the result we use  (a+b)^2 <= 2(a^2+b^2)
%}
The continuity of $b$ is straightforward
\begin{equation} \label{eqn:form_b_bound}
    \abs{b(\vc v,p)} \leq \norm{p}_{L_2(\Omega)} \norm{\div\,\vc v}_{L_2(\Omega)}
        \leq \norm{p}_{L_2(\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall q\in Q,\;\forall \vc v\in V.
\end{equation}
% putting the constant $\beta_2=1$.
\end{proof}

The bilinear form $a$ is coercive on kernel space $V_0=\{\vc v\in V: b(\vc v,q)=0\;\forall q\in Q\}$, i.e.
a subspace of $V$ where $\div\,\vc v=0$,
\begin{multline} \label{eqn:form_a_coercivity_V0}
    a(\vc v,\vc v) \geq \underline{k}^{-1} \norm{\vc v}^2_{L_2(\Omega)}
                + \sigma_w^{-1}\abs{\Gamma_w}\avg{\vc v\cdot\vc n}_w^2 \\
        \geq  \alpha_1 \norm{\vc v}^2_{L_2(\Omega)} = \alpha_1 \norm{\vc v}^2_{H(\div,\Omega)} \quad \forall \vc v\in V_0,
\end{multline}
with $\alpha_1=\underline{k}^{-1}$ and having the average term greater than zero.

We now show that our problem is inf-sup stable, i.e. it satisfies 
the so-called Ladyshenskaja-Babu{\v s}ka-Brezzi (LBB) condition, see \cite{brezzi_mixed_1991}, p. 42.

\begin{lemma} \label{lem:mixed_lbb}
The Problem \ref{thm:prob_mixed_weak_simple} satisfies the LBB condition
\begin{equation} \label{eqn:form_b_lbb}
    \sup_{\vc v\in V} \frac{b(\vc v,q)}{\norm{\vc v}_{H(\div,\Omega)}} \geq \beta_1 \norm{q}_{L_2(\Omega)}.
\end{equation}
\end{lemma}

\begin{proof}
We construct for given $q\in Q$ function $\vc v$, satisfying the inequality.
We solve the artificial Poisson problem
\begin{equation} \label{eqn:lbb_artificial_poisson}  
\begin{aligned}
    -\Delta\varphi &= q && \textrm{in } \Omega\\
    \varphi &= 0 && \textrm{on } \Gamma_D \\
    \grad\varphi\cdot\vc n &= 0 && \textrm{on } \Gamma_w
\end{aligned}
\end{equation}
with homogenous Dirichlet b.c. on $\Gamma_D$ and homogenous Neumann b.c. on $\Gamma_w$.
From the ellipticity of the artificial problem we get
\begin{equation}
    \norm{\grad\varphi}_{L_2(\Omega)} \leq \norm{\varphi}_{H^1(\Omega)}
        \leq C_F^2 \norm{q}_{L_2(\Omega)},
\end{equation}
with $C_F(\Omega,\Gamma_D)$ from Friedrich's inequality.
Next we set $\vc v = -\grad \varphi$, holding $\fluct{\vc v\cdot\vc n}=0$ for this particular $\varphi$,
and so $\div\,\vc v = -\Delta\varphi=q$. Then we can bound the norm
\begin{equation}
    \norm{\vc v}^2_{H(\div,\Omega)} = \norm{\vc v}^2_{L_2(\Omega)} 
        + \norm{\div\,\vc v}^2_{L_2(\Omega)}
        \leq (1+C_F^4) \norm{q}^2_{L_2(\Omega)}.
\end{equation}
Using it in the LBB condition, we obtain
\begin{equation} \label{eqn:form_b_lbb_proof}
    \sup_{\vc v\in V} \frac{b(\vc v,q)}{\norm{\vc v}_{H(\div,\Omega)}} \geq
    \frac{\norm{q}^2_{L_2(\Omega)}}{\norm{\grad\varphi}_{H(\div,\Omega)}}
    \geq \frac{1}{(1+C_F^4)^{1/2}} \norm{q}_{L_2(\Omega)} = \beta_1 \norm{q}_{L_2(\Omega)},
\end{equation}
and having the constant $\beta_1 = (1+C_F^4)^{-1/2}$.
\end{proof}

Using the Brezzi's theorem (\cite{brezzi_mixed_1991}, p. 42), we see that we have now
all necessary conditions for the existence of the unique solution $\vc u$, $p$ of Problem \eqref{thm:prob_mixed_weak_simple}.
The pressure part of the solution $p$ is according to the Brezzi's theorem defined up to an element of $\Ker B^T$.
If we use the same construction of $\vc v$ as in the auxiliary Poisson problem \eqref{eqn:lbb_artificial_poisson},
we see, that
\[
    \langle \vc v, B^T q \rangle_{V\times V'} = b(\vc v,q) = \int_\Omega q^2 \dd\bx \geq 0
\]
and so that $b(\vc v,q) = 0 \iff q=0$ and therefore $\Ker B^T=\{0\}$.

We summarize the results on the continuous spaces in Lemmas \ref{lem:mixed_continuity_ab} and \ref{lem:mixed_lbb} into the following theorem
\begin{theorem} \label{thm:brezzi_theorem}
Let $a$ be a~continuous bilinear form on $V\times V$ and $b$ be a~continuous bilinear form on $V\times Q$, i.e.
\begin{eqnarray}
    \abs{a(\vc u,\vc v)} &\leq& \alpha_2 \norm{\vc u}_{H(\div,\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall \vc u,\vc v\in V,\\
    \abs{b(\vc v,p)} &\leq& \beta_2 \leq \norm{p}_{L_2(\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall q\in Q,\;\forall \vc v\in V,
\end{eqnarray}
with the constants $\alpha_2$ from \eqref{eqn:form_a_bound} and $\beta_2=1$ from \eqref{eqn:form_b_bound}.
Let us suppose that $a$ is coercive on the kernel $V_0$ of the space $V$, i.e. there holds
\begin{equation}
    a(\vc v,\vc v) \geq \alpha_1 \norm{\vc v}^2_{H(\div,\Omega)} \quad \forall \vc v\in V_0,
\end{equation}
with the constant $\alpha_1$ from \eqref{eqn:form_a_coercivity_V0},
and that there holds the LBB condition
\begin{equation} \label{eqn:brezzi_theorem_lbb}
    \sup_{\vc v\in V} \frac{b(\vc v,q)}{\norm{\vc v}_{H(\div,\Omega)}} \geq \beta_1\norm{q}_{L_2(\Omega)} \quad \forall q\in Q,
\end{equation}
with $\beta_1$ from \eqref{eqn:form_b_lbb_proof}.\\
Then there exists a~unique solution $\vc u$, $p$ to Problem \eqref{thm:prob_mixed_weak_simple} for any $F\in V'$ and $G\in Q'$
such that the solution fullfills the stability estimate
\begin{eqnarray}
    \norm{\vc u}_{H(\div,\Omega)} &\leq& \frac{1}{\alpha_1} \norm{F}_{V'} + \left( \frac{\alpha_2}{\alpha_1} + 1\right)\frac{1}{\beta_1} \norm{G}_{Q'},\\
    \norm{p}_{L_2(\Omega)} &\leq& \frac{1}{\beta_2} \left(1+ \frac{\alpha_2}{\alpha_1} \right) \norm{F}_{V'}
            + \frac{\alpha_2}{\beta_1^2} \left( 1+ \frac{\alpha_2}{\alpha_1}\right) \norm{G}_{Q'}.
\end{eqnarray}
\end{theorem}
% \theorem{ \label{thm:brezzi_theorem}
% Let $a$ be a~continuous bilinear form on $V\times V$ and $b$ be a~continuous bilinear form on $V\times Q$, i.e.
% \begin{eqnarray}
%     \abs{a(\vc u,\vc v)} &\leq& \alpha_2 \norm{\vc u}_{H(\div,\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall \vc u,\vc v\in V,\\
%     \abs{b(\vc v,p)} &\leq& \beta_2 \leq \norm{p}_{L_2(\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall q\in Q,\;\forall \vc v\in V.
% \end{eqnarray}
% Let us suppose that $a$ is coercive on the kernel $V_0$ of the space $V$, i.e. there holds
% \begin{equation}
%     a(\vc v,\vc v) \geq \alpha_1 \norm{\vc v}^2_{H(\div,\Omega)} \quad \forall \vc v\in V_0,
% \end{equation}
% and that there holds the LBB (Ladyshenskaja-Babu{\v s}ka-Brezzi) condition
% \begin{equation}
%     \sup_{\vc v\in V} \frac{b(\vc v,q)}{\norm{\vc v}_{H(\div,\Omega)}} \geq \beta_1\norm{q}_{L_2(\Omega)} \quad \forall q\in Q.
% \end{equation}
% Then there exists a \notePE{unique} solution to problem \eqref{thm:prob_mixed_simple} for any $F\in V'$ and $G\in Q'$
% \notePE{where velocity $u$ is unique and pressure $p$ is defined up to an element of $Ker B'$}
% such that the solution fullfills the stability estimate
% \begin{eqnarray}
%     \norm{\vc u}_{H(\div,\Omega)} &\leq& \frac{1}{\alpha_1} \norm{F}_{V'} + \left( \frac{\alpha_2}{\alpha_1} + 1\right)\frac{1}{\beta_1} \norm{G}_{Q'}\\
%     \norm{p}_{L_2(\Omega)} &\leq& \frac{1}{\beta_2} \left(1+ \frac{\alpha_2}{\alpha_1} \right) \norm{F}_{V'}
%             + \frac{\alpha_2}{\beta_1^2} \left( 1+ \frac{\alpha_2}{\alpha_1}\right) \norm{G}_{Q'}.
% \end{eqnarray}
% }

% \notePE{There is also some lemma in Brezzi, which says: if B is surjective (and $\div$ is) then the LBB condition holds.}
% 


\subsection{Discretization of Mixed Problem}

The discretization applied in the flow model in Flow123d is followed in this section
and it is enhanced using an~enrichment of the velocity space.
In contrast to the first part of this work, simplicial meshes are considered from now on.
At the beginning a~mixed-hybrid discretization approach is described,
then a~proper enrichment of the discrete velocity space is introduced.


For the approximation of the $H(\div,\Omega)$ space, we use the lowest order Raviart-Thomas space
\begin{equation}
    \mathbb{RT}^0(T^i) = \{\vc\psi_j\}_{j=1}^{n_F}, 
\end{equation}
on the element $T^i$, $i\in\mathcal{I}_E$. The vector basis functions of $\mathbb{RT}^0(T^i)$
are defined in the standard way
\begin{equation}
    \vc\psi_j(\bx) = \frac{\abs{F^j}}{\abs{T^i}} \left( \bx - \bx_k \right), \qquad \bx\in T^i,\, j=1\ldots n_F,
\end{equation}
with $\bx_k$ being the opposite node of face $F^j$ and $n_F$ the number of faces of the element $T^i$
(holds in all dimensions, putting $\abs{F^j}:=1$ in 1d for point faces).
Note that $j$ is the index in local faces numbering on the element; we assume this implicitly further in text, 
if it is apparent from the range, e.g. $1\ldots n_F$.
The degrees of freedom are interpreted as the fluxes over the corresponding faces
\begin{equation} \label{eqn:rt0_delta_property}
    \int_{F_i} \vc\psi_j \cdot \vc n \dd s = \delta_{ij} \qquad i,j=1\ldots n_F.
\end{equation}
Let us denote the standard discrete space for velocity
\begin{equation}
    \tilde V_h = \{\vc v_h\in V: \vc v_h|_{T^i} \in \mathbb{RT}^0(T^i),\; i\in\mathcal{I}_E \},
\end{equation}
% The pressure space $Q$ is discretized using the finite dimensional space
and the discrete space for pressure, consisting of piecewise constant functions
\begin{equation}
    Q_h=\{q_h\in L_2(\Omega):\; q_h|_{T^i}\in \mathbb{P}^0(T^i),\; i\in\mathcal{I}_E\}.
\end{equation}
One can then read the discrete counterpart of Problem \ref{thm:prob_mixed_weak_simple} as follows
\thmproblem{ \label{thm:prob_mixed_weak_simple_discrete}
Find $\vc u_h\in \tilde V_h$ and $p_h\in Q_h$ satisfying
\begin{subequations}
\begin{align}
    a(\vc u_h,\vc v_h) + b(\vc v_h, p_h) &= \langle G, \vc v_h\rangle_{V'\times V} &&
        \forall \vc v_h\in \tilde V_h, \label{eqn:mixed_saddle_discrete1}\\
    b(\vc u_h, q_h) &= \langle F, q_h \rangle_{Q'\times Q} &&\forall q_h \in Q_h
        \label{eqn:mixed_saddle_discrete2}.
\end{align}
\end{subequations}
}

For the mixed problem, not all the assumptions in Theorem \ref{thm:brezzi_theorem}
hold automatically on the discrete level and the existence of a~unique discrete solution is not straightforward.
Particulary the coercivity of $a$ on $\tilde V_{0h}$
and LBB condition on discrete spaces $\tilde V_h$ and $Q_h$ are not implied by the continuous inequalities
\eqref{eqn:form_a_coercivity_V0} and \eqref{eqn:form_b_lbb}.

Considering the $\mathbb{RT}^0$ and $\mathbb P^0$ finite elements,
we have $\div\,\tilde V_{h}\subset Q_h$, i.e. $\div\, \tilde V_h$ is the space of piecewise constant functions.
Thus $\tilde V_{0h} \subset V_0$ and the coercivity of $a$ holds:
\begin{equation}
a(\vc v_h,\vc v_h)\geq \norm{\vc v_h}^2_V  \qquad \forall \vc v_h\in \tilde V_{0h}.
\end{equation}

% \paragraph{Discrete LBB condition.}
%(inequation 3.14, p. 75 in \cite{brezzi_mixed_1991}

Next, we define a~local interpolation operator into $\mathbb{RT}^0(T)$ space of an arbitrary element $T$
\begin{equation}
    \pi^{RT}_T\vc v = \sum_{j=1}^{n_F} \left( \int_{F^j} \vc v \cdot \vc n \dd s \right)  \vc \psi_j
    \qquad \forall \vc v \in V \label{eqn:local_rt_interpolator}
\end{equation}
which satisfies
\begin{align}
b(\pi^{RT}_T\vc v- \vc v, q)_T &= 0 \qquad \forall q\in Q_h,\\ 
\implies \int_T \div(\pi^{RT}_T\vc v- \vc v) &= 0 \qquad \textrm{since } q|_T\in \mathbb{P}^0.
\end{align}

% According to Lemma 99 ('numpde.pdf'),
According to the proposition 2.8 in (\cite{brezzi_mixed_1991}, p. 58),
we can show the inf-sup stability via the following lemma
\begin{lemma} \label{lem:discrete_inf_sup_interpolant}
Let us have spaces $V$ and $Q$ for which the continuous LBB condition \eqref{eqn:brezzi_theorem_lbb} holds.
Let us choose discrete spaces $V_h\subset V$ and $Q_h\subset Q$.
If there exists an interpolation operator
$\pi_h: V\rightarrow V_h$ which is continuous
\begin{equation}
    \norm{\pi_h \vc v}_V \leq C_\pi \norm{\vc v}_V \qquad \forall \vc v\in V,
\end{equation}
with $C_\pi$ being independent of $h$, and which satisfies
\begin{equation}
    b(\pi_h\vc v- \vc v, q) = 0 \quad \forall q\in Q_h,\\ 
\end{equation}
then the discrete LBB condition holds:
\begin{equation}
    \sup_{\vc v_h\in V_h} \frac{b(\vc v_h,q_h)}{\norm{\vc v_h}_V}
    \geq \beta_{1h}\norm{q_h}_Q \qquad \forall q_h\in Q_h.
\end{equation}
\end{lemma}

\begin{proof}
We provide the standard proof for the chosen finite element spaces $\mathbb{RT}^0\times\mathbb{P}^0$.
We define an interpolation operator 
\begin{equation}
    (\pi^{RT}_h \vc v)|_T = \pi^{RT}_T \vc v
\end{equation}
using the local interpolation operator from \eqref{eqn:local_rt_interpolator}.
This operator is not continuous on $V=H(\div,\Omega)$ but on
smaller space we have
\begin{equation}
    \norm{\pi^{RT}_h \vc v}_V \leq C_\pi \norm{\vc v}_W \qquad \forall \vc v\in W=[H^1(\Omega)]^d \subset H(\div,\Omega)
\end{equation}
and from \eqref{eqn:brezzi_theorem_lbb}
\begin{equation}
    \sup_{\vc v\in W} \frac{(\div\,\vc v, q)}{\norm{\vc v}_W} \geq \beta_1 \norm{q}_Q \qquad \forall q\in Q.
\end{equation}
Using this we obtain for all $q_h\in Q_h$
\begin{align}
    \sup_{\vc v_h\in \tilde V_h} \frac{b(\vc v_h,q_h)}{\norm{\vc v_h}_V} \geq
    \sup_{\vc v_h\in W} \frac{\int_{\Omega} q_h \div (\pi^{RT}_h \vc v_h)}{\norm{\pi^{RT}_h \vc v}_V} \geq
    \frac{1}{C_\pi} \sup_{\vc v_h\in W} \frac{\int_{\Omega} q_h \div\,\vc v}{\norm{\vc v}_W}
    \nonumber\\ \geq \frac{\beta_1}{C_\pi}\norm{q_h}_Q
\end{align}
\end{proof}

Due to the coercivity of $a$ on discrete kernel space $\tilde V_{0h}$
and inf-sup stability by Lemma \ref{lem:discrete_inf_sup_interpolant},
discrete Problem \ref{thm:prob_mixed_weak_simple_discrete} has unique solution by Brezzi's Theorem \ref{thm:brezzi_theorem}.

\vspace{10pt}
Considering the hybridization, we define a~new discrete space
\begin{equation}
    V_h^{reg} = \prod\limits_{i\in\mathcal{I}_E} \mathbb{RT}^0(T^i)
\end{equation}
in which the functions normal components on the element faces are not continuous
in contrast to $\tilde V_h$.
Further we define a~space of traces of the normal component of $\vc v \in\tilde V_h$ on the element boundaries
\begin{eqnarray}
    \Lambda(\mathcal{F}) &=& \{\mu\in L_2(\mathcal{F}\setminus\partial\Omega): \mu=(\vc v\cdot\vc n)|_{\mathcal{F}\setminus\partial\Omega},\; \vc v\in \tilde V_h\} \\
    \Lambda_h(\mathcal{F}) &=& \{\mu\in \Lambda(\mathcal{F}): \mu|_{F^i}\in\mathbb P^0(F^i),\; \forall i\in\mathcal{I}_F\}
\end{eqnarray}
and a~space of average traces of the normal component of the flux on the well-aquifer interface
\begin{equation} \label{eqn:lambda_w_space}
    \Lambda^{enr}_h = \{\mu_w\in \mathbb P^0(\Gamma_w):\;
    \mu_w=\avg{\vc v\cdot \vc n}_w,\; \vc v\in \tilde V_h(\Omega)\}.
\end{equation}
%
Having the proper spaces, we now derive the mixed-hybrid form.
We multiply the equations \eqref{eqn:mixed_form_1}-\eqref{eqn:mixed_form_3}
by test functions and integrate them elementwise:
\begin{subequations}
\begin{align}
    \sum_{i\in \mathcal I_E} \Bigg[ & \int_{T^i}
        \vc u \vc K^{-1} \vc v \dd\bx
        - \int_{T^i} p\,\div\,\vc v \dd\bx %\nonumber\\
        + \int_{\partial T^i\setminus \prtl\Omega}
            \lambda (\vc v \cdot \vc n) \dd s
        + \int_{\Gamma_w}
            \lambda_w \avg{\vc v\cdot\vc n}_w \dd s \Bigg] \nonumber\\
        &= -\sum_{i\in \mathcal I_F} \int_{F^i\cap \Gamma_{D}}
            g_{D} (\vc v \cdot \vc n) \dd s
            -\int_{\Gamma_w} g_w \fluct{\vc v \cdot \vc n}_w \dd s
        \qquad \forall \vc v\in V^{reg}_h,
        \label{eqn:prob_mh_weak_simple_der1}
\end{align}
\begin{align}
    -\sum_{i\in \mathcal I_E}
        \int_{T^i} q\,\div\,\vc u \dd\bx
    &= -\sum_{i\in \mathcal I_E}
        \int_{T^i} f q \dd\bx
    && \forall q \in Q_h, \label{eqn:prob_mh_weak_simple_der2} \\ 
% \end{align}
% \begin{align}
    \sum_{i\in \mathcal I_F}
        \int_{F^i\setminus \prtl\Omega}
            (\vc u \cdot \vc n) \mu \dd s &= 0
        && \forall \mu \in \Lambda_h(\mathcal{F}), \label{eqn:prob_mh_weak_simple_der3}\\
% \end{align}
% \begin{align}
    \int_{\Gamma_w} \avg{\vc u\cdot\vc n}_w \mu_w \dd s
    &= \int_{\Gamma_w} \sigma_w (\lambda_w - P_w)\mu_w \dd s
    && \forall \mu_w \in \Lambda^{enr}_h. \label{eqn:prob_mh_weak_simple_der4}
\end{align}
\end{subequations}
%
We now sum up equations \eqref{eqn:prob_mh_weak_simple_der2}-\eqref{eqn:prob_mh_weak_simple_der4},
introduce the hybridized bilinear forms
and transform Problem \ref{thm:prob_mixed_weak_simple_discrete} into

\thmproblem{ \label{thm:prob_mh_weak_simple}
Find $\vc u_h \in V_h^{reg}$ and $\mathring{p_h} =[p_h, \lambda, \lambda_w] \in Q_h \times \Lambda_h(\mathcal{F}) \times \Lambda^{enr}_h$
which satisfy
% \begin{subequations}
% \label{eqn:prob_mh_weak_simple}
% \begin{align}
%     a_h(\vc{u},\vc v) + b_h(\vc v, p) + b_{\mathcal{F}}(\vc v, \lambda) &= \langle G, \vc v\rangle_{V_h^{'reg}\times V_h^{reg}} &&
%         \forall \vc v\in V_h^{reg}, \label{eqn:prob_mh_weak_simple1}\\
%     b_h(\vc{u}, q) - c_w(\lambda_w,\mu_w) &= \langle F, q \rangle_{Q_h'\times Q_h} &&\forall q \in Q_h,\, \forall \mu_w \in \Lambda^{enr}
%         \label{eqn:prob_mh_weak_simple2}\\
%     b_{\mathcal{F}}(\vc{u}, \mu) &= 0 &&\forall \mu \in \Lambda^{reg} \label{eqn:prob_mh_weak_simple3},
% \end{align}
% \end{subequations}
\begin{subequations}
\label{eqn:prob_mh_weak_simple}
    \begin{align}
    a_h(\vc u_h,\vc v_h) + b_h(\vc v_h, \mathring{p}_h) &= \langle G, \vc v_h\rangle_{V_h^{'reg}\times V_h^{reg}} &&
        \forall \vc v_h\in V^{reg}_h,
        \label{eqn:prob_mh_weak_simple1}\\
    b_h(\vc u_h, \mathring{q}_h) -c_w(\mathring{p}_h, \mathring{q}_h) &= \langle F, \mathring{q}_h \rangle_{Q_h'\times Q_h} &&
        \forall \mathring{q}_h \in Q_h \times \Lambda_h(\mathcal{F}) \times \Lambda^{enr}_h
%         \forall q \in Q_h,\, \forall \lambda \in \Lambda^{reg},\, \forall \lambda_w \in \Lambda^{enr}
        \label{eqn:prob_mh_weak_simple2}
    \end{align}
\end{subequations}
with the bilinear forms %$a: V\times V \rightarrow \R$, $b: V\times Q \rightarrow \R$
\begin{subequations}
\label{eqn:prob_mh_weak_simple_forms}
\begin{align}
 a_h(\vc u_h, \vc v_h)=&\sum_{i\in \mathcal I_E} \int_{T^i}
   \vc u \vc K^{-1} \vc v \dd\bx,\\
%    + \frac{1}{\sigma_w}\avg{\vc u\cdot \vc n}_w \avg{\vc v\cdot \vc n}_w \abs{\Gamma_w},\\
%
 b_h(\vc v_h, \mathring{p}_h)=&\sum_{i\in \mathcal I_E} \left[
        \int_{T^i} -p_h\,\div\,\vc v_h \dd\bx
%  b_{\mathcal{F}}(\vc v, \lambda)=&\sum_{i\in \mathcal I_F}        
        + \int_{\partial T^i\setminus \prtl\Omega}
                 \lambda (\vc v_h \cdot \vc n) \dd s\right]\\
        &+ \color{blue}{ \int_{\Gamma_w}
            \lambda_w \avg{\vc v_h\cdot\vc n}_w \dd s},\\
 \color{blue}
    c_w(\mathring{p}_h,\mathring{q}_h) =& \color{blue}{ \int_{\Gamma_w} \sigma_w
    \lambda_w \mu_w \dd s},\\
 \langle G, \vc v_h\rangle_{V_h^{'reg}\times V_h^{reg}} =& \sum_{i\in \mathcal I_F}
        \int_{F^i\cap \Gamma_{D}}
                 - g_{D} (\vc v_h \cdot \vc n) \dd s \nonumber\\
                 & \color{blue} -\int_{\Gamma_w} g_w \fluct{\vc v_h \cdot \vc n}_w \dd s,\\
 \langle F, \mathring{q}\rangle_{Q_h'\times Q_h} =& \sum_{i\in \mathcal I_E}
        \int_{T^i} -f q_h \dd\bx\;
        \color{blue}{ - \int_{\Gamma_w} \sigma_w P_w \mu_w \dd s}.
\end{align}
\end{subequations}
}

% \thmproblem{ \label{thm:prob_mh_weak_simple}
% Find $[\vc u, p, \lambda] \in V_h^{reg} \times Q_h \times \Lambda^{reg}$ which satisfy
% \begin{subequations}
% \label{eqn:prob_mh_weak_simple}
% \begin{align}
%     a_h(\vc{u},\vc v) + b_h(\vc v, p) + b_{\mathcal{F}}(\vc v, \lambda) &= \langle G, \vc v\rangle_{V_h^{'reg}\times V_h^{reg}} &&
%         \forall \vc v\in V_h^{reg}, \label{eqn:prob_mh_weak_simple1}\\
%     b_h(\vc{u}, q) &= \langle F, q \rangle_{Q_h'\times Q_h} &&\forall q \in Q_h,
%         \label{eqn:prob_mh_weak_simple2}\\
%     b_{\mathcal{F}}(\vc{u}, \mu) &= 0 &&\forall \mu \in \Lambda^{reg} \label{eqn:prob_mh_weak_simple3},
% \end{align}
% \end{subequations}
% with the bilinear forms %$a: V\times V \rightarrow \R$, $b: V\times Q \rightarrow \R$
% \begin{subequations}
% \label{eqn:prob_mh_weak_simple_forms}
% \begin{align}
%  a_h(\vc u, \vc \psi)=&\sum_{i\in \mathcal I_E} \int_{T^i}
%    \vc u \vc K^{-1} \vc v \dd\bx
%    + \frac{1}{\sigma_w}\avg{\vc u\cdot \vc n}_w \avg{\vc v\cdot \vc n}_w \abs{\Gamma_w},\\
% %
%  b_h(\vc v, p)=&\sum_{i\in \mathcal I_E} 
%         \int_{T^i} -p\,\div\,\vc v \dd\bx, \\
%  b_{\mathcal{F}}(\vc v, \lambda)=&\sum_{i\in \mathcal I_F}        
%         \int_{F^i\setminus \prtl\Omega}
%                  \lambda (\vc v \cdot \vc n) \dd s,\\
%  \langle G, \vc v\rangle_{V_h^{'reg}\times V_h^{reg}} =& \sum_{i\in \mathcal I_F}
%         \int_{F^i\cap \Gamma_{D}}
%                  - g_{D} (\vc v \cdot \vc n) \dd s \nonumber\\
%                 &- P_w\avg{\vc v\cdot\vc n}_w \abs{\Gamma_w}
%                  -\int_{\Gamma_w} g_w \fluct{\vc v \cdot \vc n}_w \dd s,\\
%  \langle F, q\rangle_{Q_h'\times Q_h} =& \sum_{i\in \mathcal I_E}
%         \int_{T^i} -f q \dd\bx.
% \end{align}
% \end{subequations}
% }

The continuity of the normal components on the element faces, which is missing in $V_h^{reg}$, is forced by the equation \eqref{eqn:prob_mh_weak_simple_der3},
so that the solution $\vc u_h\in \tilde V_h$. Thus the problems \ref{thm:prob_mixed_weak_simple_discrete} and \ref{thm:prob_mh_weak_simple} are equivalent.

If we take the equation \eqref{eqn:mixed_form_1} on a~single element $T^i$ (let it be an interior element),
multiply it by a~test function and integrate by parts, we obtain
\begin{align} \label{eqn:lagrange_multipliers_interpretation}
    \int_{T^i} \vc u \vc K^{-1} \vc v \dd\bx
%     + \frac{1}{\sigma_w}\avg{\vc u\cdot \vc n}_w \avg{\vc v\cdot \vc n}_w \abs{\Gamma_w}
    &- \int_{T^i} p\,\div\,\vc v \dd\bx,
    + \int_{\partial T^i} p (\vc v \cdot \vc n) \dd s \nonumber\\
    &+ \int_{\Gamma_w} \avg{p}_w \avg{\vc v\cdot\vc n}_w \dd s
    + \int_{\Gamma_w} \fluct{p} \fluct{\vc v \cdot \vc n}_w \dd s = 0.
\end{align}
Comparing \eqref{eqn:lagrange_multipliers_interpretation} with \eqref{eqn:prob_mh_weak_simple_der1}
it is apparent from the third term that the Lagrange multipliers $\lambda\in\Lambda_h(\mathcal{F})$ can be interpreted
as the trace of pressure $p$ on element faces $\mathcal F$.
Similarly we see from the forth term that the Lagrange multiplier $\lambda_w\in\Lambda^{enr}_h$ can be interpreted as
the average of trace of pressure $p$ on well-aquifer cross-section.
See \cite{lawrence_balancing_1995} for details.

The mixed-hybrid problem \ref{thm:prob_mh_weak_simple} is conceptually compatible
with the model implemented in Flow123d, see \cite{sistek_bddc_2015, flow123d}.


\subsubsection{Velocity Enrichment}
\label{sec:velocity_enrichment}

In addition to the discretization approach described above, we are now interested in finding
a~proper XFEM enrichment of the velocity space $V^{reg}_h$.
To this end we proceed in a~similar manner as in the pressure model in Section \ref{sec:prim_discretization}.
We build an enrichment space $V_h^{enr}$, such that the discrete velocity space is
\begin{equation}
    V_h = V_h^{reg} \oplus V_h^{enr}.
\end{equation}

The choice of the logarithmic pressure enrichment is explained in Section \ref{sec:enrichment_func} and
is based on solving a~local problem. The global enrichment function for velocity is then 
the derivative of pressure. We define the velocity global enrichment function
\begin{equation}
    \vc s_w(\bx) = -\frac{1}{S_e} \frac{\vc r_w}{r_w^2}, \qquad \div \vc s_w = 0 \label{eqn:global_enr_vel},
\end{equation}
where we call $S_e$ an effective (lateral) surface
\begin{equation}
S_e = 2\pi\rho_w.
\end{equation}
i.e. a~part of $\Omega^w_C$ through which the well and aquifer are communicating.
The effective surface normalizes the function, so we have the flux
\begin{equation}
\int_{\Gamma_w} \vc s_w\cdot \vc n \dd s = 1.
\end{equation}
%
For the global enrichment functions it holds on an element $T$
\begin{align}
0 = \int_{T\setminus\Omega^w_C} \div\,\vc s_w \dd\bx = & \int_{\prtl (T\setminus\Omega^w_C)} \vc s_w\cdot\vc n \dd s \nonumber\\
    &= \sum \limits_{j=1}^{n_F} \int_{F^j\setminus \Omega^w_C} \vc s_w\cdot\vc n \dd s 
      + \int_{\Gamma_w\cap T} \vc s_w\cdot\vc n \dd s,
\end{align}
which implies two important cases
\begin{align} \label{eqn:glob_flux_properties}
        \sum \limits_{j=1}^{n_F} \int_{F^j} \vc s_w\cdot\vc n \dd s &= 0
            && T \cap \Gamma_w=\emptyset, \\
        \sum \limits_{j=1}^{n_F} \int_{F^j} \vc s_w\cdot\vc n \dd s
            &= - \int_{\Gamma_w} \vc s_w\cdot\vc n \dd s
            && T \cap \Gamma_w=\Gamma_w.
\end{align}
The first case in \eqref{eqn:glob_flux_properties} means that $\vc s_w$ has zero divergence on elements
not intersecting with the well $w$ (on most of the elements). The second case means that flux of $\vc s_w$ over element faces
is equal the flux of $\vc s_w$ from the well, if the intersection lies inside of the element.

Similarly for $\mathbb{RT}^0(T)$ functions it holds
\begin{align} \label{eqn:rt0_flux_properties}
    \int_{T\setminus\Omega^w_C} \div\,\vc\psi_{j}\dd\bx
    &= \int_{\prtl T} \vc\psi_{j}\cdot\vc n \dd s = \nonumber\\
    &= \begin{cases}
        1 & \quad T \cap \Gamma_w=\emptyset, \\
        1-\abs{F^j}\abs{T}^{-1}2\pi\rho_w^2 & \quad T \cap \Gamma_w=\Gamma_w, \\
        \int_{F^j\setminus \Omega^w_C} \vc\psi_j\cdot\vc n \dd s
            +\int_{\Gamma_w\cap T} \vc\psi_j\cdot\vc n \dd s
            &\quad T \cap \Gamma_w\subset\Gamma_w. \\
        \end{cases}
\end{align}
%
% TODO
We see in \eqref{eqn:rt0_flux_properties} that the first two cases, $\Gamma_w$ outside
or fully inside the element, do not imply any significant changes in the numerical computation
in system matrix assembly. In the second case, the normal flux of $\vc\psi_j$ over $\Gamma_w$
is computed analyticaly.
Only the last case, the well intersecting an element face, means
numerical evaluation of the face integrals.

\paragraph{Velocity Enrichment with PU}
We now introduce SGFEM like enrichment for the velocity.
% \begin{equation}
%     \vc L_{w}(\bx) = \vc s_w(\bx) - \sum \limits_{j=1}^{n_E} z^{w}_j \vc\psi_j(\bx),
%     \quad z^{w}_j=\int_{E_j} \vc s_w\cdot \vc n \dd s \label{eqn:local_enr_vel},
% \end{equation}
% where $z^{w}_j$ are the fluxes of $\vc s_w$ over element faces. The values actually corresponds
% to the degrees of freedom of the Raviart-Thomas interpolator $\pi^{RT}(\vc s_w)$.
At first we mimic the steps taken in the pressure model discretization.
Let us suppose a~partition of unity
\begin{equation}
    \sum\limits_{i=1}^{n_{PU}} N_i(\bx) = 1 \qquad \forall \bx\in T.
\end{equation}
Since velocity is being enriched, we interpolate $\vc s_w$ using $\pi^{RT}_T$ on an element $T$ in the SGFEM:
\begin{equation}
    \pi^{RT}_T(\vc s_w)(\bx) = \sum \limits_{j=1}^{n_F} z^w_j \vc\psi_j(\bx),
    \qquad z^w_j=\int_{F^j} (\vc s_w\cdot \vc n)\dd s \label{eqn:sgfem_interpolant_vel}.
\end{equation}
Following Section \ref{sec:stable_gfem} we then obtain the local enrichment function
\begin{equation}
    \vc\phi_{iw}=N_i\vc L_{w}, \qquad i=1\ldots n_{PU},\;\vc L_{w}=\vc s_w - \pi^{RT}_T\vc s_w.
\end{equation}
However such $\vc\phi_{iw}$ has non zero flux over element faces, so it devalues
the advantages of the delta property of $\mathbb{RT}^0$ functions \eqref{eqn:rt0_delta_property}.
We would like to avoid this.
Thus we suggest to include the PU functions into $\vc L_w$.
The local enrichment functions for each $i=1\ldots n_{PU}$ then become
\begin{equation}
    \vc\phi_{iw} = \vc L_{iw} = N_i\vc s_w - \sum \limits_{j=1}^{n_F} z^{iw}_j \vc\psi_j,
    \quad z^{iw}_j=\int_{F^j} N_i (\vc s_w\cdot \vc n)\dd s \label{eqn:local_enr_vel_PU}.
\end{equation}
We compute the divergence of $\vc L_{iw}$ and of the whole partition of unity:
\begin{align}
    \div\,\vc L_{iw} &= \grad N_i \cdot \vc s_w - \sum \limits_{j=1}^{n_F} z^{iw}_j \div\,\vc\psi_j
    \label{eqn:local_enr_vel_div}, \\
    \sum \limits_{i=1}^{n_{PU}} \div\,\vc L_{iw} &= - \sum \limits_{j=1}^{n_F} \div\,\vc\psi_j \int_{F^j} \vc s_w\cdot\vc n \dd s.
    \label{eqn:local_enr_vel_sum_div_PU}
\end{align}
We compute also the fluxes of $\vc L_{iw}$ and of the whole partition of unity:
\begin{align}
    \int_{F_k} \vc L_{iw}\cdot\vc n \dd s = \int_{F_k} N_i \vc s_w\cdot\vc n \dd s
        - \sum \limits_{j=1}^{n_F} z^{iw}_j \int_{F_k} \vc\psi_j \cdot \vc n \dd s \nonumber\\
    = \int_{F_k} N_i \vc s_w\cdot\vc n \dd s - z^{iw}_k = 0 \qquad \forall k=1\ldots n_F
    \label{eqn:local_enr_vel_normal_PU},
\end{align}
\begin{align}
    \int_{T} \sum \limits_{i=1}^{n_{PU}} \div\,\vc L_{iw}\dd\bx =
        - \sum \limits_{j=1}^{n_F} \int_{F^j} \vc s_w\cdot\vc n \dd s
        \int_T \div\,\vc\psi_j \dd \bx %\nonumber\\
        = 0 & \qquad T \cap \Gamma_w=\emptyset.
%     = \begin{cases}
%         0 & \quad T \cap \Gamma_w=\emptyset, \\
%         \int_{\Gamma_w} \vc s_w\cdot\vc n \dd s &\quad T \cap \Gamma_w=\Gamma_w \\
%         \end{cases}
    \label{eqn:local_enr_vel_int_sum_div_PU},
\end{align}
We see from \eqref{eqn:local_enr_vel_normal_PU} that this kind of enrichment does not affect the meaning of the standard
degrees of freedom (the fluxes of $\vc \psi_j$ over element faces).
The property \eqref{eqn:local_enr_vel_int_sum_div_PU} can be checked when filling local element matrices during assembly,
and can be a~good guide for finding errors.

Finally we need to choose a~partition of unity. Since the hybrization decoupled the elements,
the simplest choice is $\mathbb P^0$, 
the enriched velocity then has the form:
\begin{equation}
    \vc u_h = 
    \sum \limits_{i=1}^{n_F\cdot N_E} a_i \vc \psi_i + 
    \sum \limits_{w\in\mathcal{W}} \sum \limits_{i\in\mathcal{J}^w_E} b_{iw} \vc \phi_{iw}.
\end{equation}
The enrichment area $Z_w$ is given by the enrichment radius $R_w$ as in the pressure model.
The enriched nodes and elements are then defined the same way by index sets $\mathcal{J}^w_N,\,\mathcal{J}^w_E$, respectively,
see \eqref{eqn:prim_enriched_nodes} and \eqref{eqn:prim_enriched_elements}.
There is a~single local enrichment function per element.
Choosing $\mathbb P^1$ as a~partition of unity,
the enriched velocity then has the form:
\begin{equation}
    \vc u_h = 
    \sum \limits_{i=1}^{n_F\cdot N_E} a_i \vc \psi_i + 
    \sum \limits_{w\in\mathcal{W}} \sum \limits_{i\in\mathcal{J}^w_N} b_{iw} \vc \phi_{iw}.
\end{equation}
There are 3 local enrichment functions per element, in case of 2d.

Unfortunately, we were unsuccessful in implementation of these PU.
In case of $\mathbb P^0$, the coupling of the enrichment functions over the element faces was too loose,
that the solution was utterly broken into pieces.
Additional enrichment of the constant Lagrange multipliers, that would strenghten the connections over faces,
might be worth trying.

The $\mathbb P^1$ partition of unity goes againts the hybridization, since we have the regular part disconnected
and the enriched part continuous over element faces. We were looking for proper Lagrange multiplicators
for hybridization of the enriched part, but we were unsuccessful in this matter.

A step back to solving the mixed model \ref{thm:prob_mixed_weak_simple_discrete} and implementing an enrichment
for that problem would be reasonable. However the non-hybridized model is not implemented currently in Flow123d
and it would require significant changes from mesh proccessing to output routines.
Testing the enrichment in the mixed form is one of our future aims.


\paragraph{Velocity Enrichment without PU}
We simplify the enrichment so that we have only single enrichment function per singularity.
On each enriched element $T^i,\, i\in\mathcal{J}^w_E$, we subtract the interpolation
of the global enrichment function, see \eqref{eqn:sgfem_interpolant_vel},
% \begin{equation}
%     \vc \phi_w(\bx) = \vc L_{w}(\bx)|_{T^i} = \vc s_w(\bx) - \sum \limits_{j=1}^{n_F} z^{w}_j \vc\psi_j(\bx),
%     \quad z^{w}_j=\int_{F^j} \vc s_w\cdot \vc n \dd s\;  F^j\subset\partial T^i
%     \label{eqn:local_enr_vel},
% \end{equation}
\begin{equation}
    \vc \phi_w(\bx)|_{T^i} = \vc L_{w}(\bx)|_{T^i} = \vc s_w(\bx) - \pi^{RT}_{T^i}(\vc s_w)(\bx).
    \label{eqn:local_enr_vel}
\end{equation}
%
For such enrichment it holds:   
\begin{align}
    \div\,\vc L_w &= - \sum \limits_{j=1}^{n_F} z^w_j \div\,\vc\psi_j,
    \label{eqn:local_enr_vel_div_single}
\end{align}
\begin{align}
    \int_{F_k} \vc L_w\cdot\vc n \dd s = \int_{F_k} &\vc s_w\cdot\vc n \dd s
        - \sum \limits_{j=1}^{n_F} z^w_j \int_{F_k} \vc\psi_j \cdot \vc n \dd s \nonumber\\
    &= \int_{F_k} \vc s_w\cdot\vc n \dd s - z^w_k = 0 \qquad \forall k=1\ldots n_F
    \label{eqn:local_enr_vel_normal},
\end{align}
%
Finally we define the enriched velocity in the form:
\begin{equation}
    \vc u_h = 
    \sum \limits_{i=1}^{n_F\cdot N_E} a_i \vc \psi_i + 
    \sum \limits_{w\in\mathcal{W}} b_w \vc \phi_w.
    \label{eqn:velocity_enriched_approximation}
\end{equation}

We use this kind of enrichment later on, in our implementation in Flow123d and in all our test cases.

\notePE{Below following the proof in 'numpde.pdf' from page 108, 'Brezzi' p.42}
\paragraph{Coercivity of $a$ on $V_{0h}=\ker B_h$.}
Since we enriched space $V_h$, we no longer have $\div\,V_{h}\subset Q_h$
($\div\,V_{h}$ is not the space of piecewise constant functions anymore).
Therefore the simple restriction $V_{0h}\not\subset V_0$ does not hold and 
we need to check the coercivity
\[a(\vc v_h,\vc v_h)\geq \norm{\vc v_h}^2_V  \qquad \forall \vc v_h\in V_{0h}\].

\notePE{
    Instead it might be sufficient to proove one of the weaker conditions:
    \begin{eqnarray}
    \inf_{\vc u_h\in V_{0h}}\sup_{\vc v_h\in V_{0h}}
        \frac{a(\vc u_h, \vc v_h)}{\norm{\vc u_h}_V \norm{\vc u_h}_V}
    \geq \alpha_{1h}, \\
    \inf_{\vc v_h\in V_{0h}}\sup_{\vc u_h\in V_{0h}}
        \frac{a(\vc u_h, \vc v_h)}{\norm{\vc u_h}_V \norm{\vc u_h}_V}
    \geq \alpha'_{1h},
    \end{eqnarray}
    (Brezzi p.52, for finite-dimensional case, surjectivity and injectivity are equivalent).
}

\paragraph{Numeric verification of LBB condition.}
\notePE{We can do the LBB numericaly but we must somehow show that the form $a_h$ is coercive on kernel of $B$.}

Proving the discrete LBB condition for such enrichment is non-trivial,
therefore we use a~kind of numeric indicator on the inf-sup stability on our test cases.
The numeric validation is done on the discrete level, inspecting the eigenvalues of the system matrix.
We rewrite equations \eqref{eqn:prob_mh_weak_simple} using the matrix notation
\begin{align}
    \mat A \mat u + \mat B^T\mat p &= \mat f, \\
    \mat B \mat u - \mat C  \mat p &= \mat g.
\end{align}
The matrix $\mat C$ is zero in this case, although later it will represent the coupling terms between dimensions.
We derive the Schur complement of $\mat A$ by elimination of velocity $\mat u$ from the system:
\begin{equation}
    (\mat C + \mat B\mat A^{-1}\mat B^T) \mat p = \mat B \mat A^{-1} \mat f - \mat g.
\end{equation}
We construct a~generalized eigenvalue problem
\begin{equation}
%     (\mat C + \mat B\mat A^{-1}\mat B^T) \mat v_i = k_i \mat v_i
    (\mat B\mat A^{-1}\mat B^T) \mat v_i = \eta^2_i \mat C \mat v_i
\end{equation}
where $\eta_i$ are the singular values of $\mat B$.
The smallest non-zero singular value corresponds to the discrete inf-sup constant $\eta_{min} = \beta_{1h}$
according to \cite{brezzi_mixed_1991}, p.76.

%
\begin{figure}[!htb]
    \centering    
    \includegraphics[width=0.85\textwidth]{\results mh_dirichlet_inf-sup.pdf} 
    \caption[numerical verification of inf-sup condition]
  {Graph representing numerical verification of inf-sup condition of Dirichlet problem.
  The red line is for the case without singularity, the blue line is for the case including the singularity.
  The smallest eigenvalue $\eta$ does not decrease with mesh refinement, indicating the problem is inf-sup stable.}
  \label{fig:enrichment_zone_in_3d}
\end{figure}
%

\section{Coupled 1d-2d model (Mixed Hybrid model)}
\label{sec:coupled_12d}
Let us consider Problem \ref{thm:problem_2d}, including multiple wells and aquifers.
For the sake of simplicity, we only assume homogenous Neumann boundary condition $g_{dN}=0$, if $\Gamma_{dN}\neq\emptyset$.
The saddle point problem is derived using the same steps
as in derivation of Problem \ref{thm:prob_mh_weak_simple} with an additional treatment of the coupling terms.

Let us first define the weak spaces and their discrete counterparts.
We denote
\begin{equation}
    \tilde V(\Omega_d) = \{\vc v_d \in H(\div,\Omega_d):\; \vc v_d \cdot \vc n = 0 \textrm{ on } \Gamma_{dN}\}
\end{equation}
the velocity subspace of $H(\div)$ that satisfy the zero flux condition on Neumann boundary
and its discrete subset
\begin{equation}
    \tilde V_h(\Omega_d) = \{\vc v_d \in \tilde V(\Omega_d):\; \vc v_d|_{T^i_d} \in\mathbb{RT}^0(T^i_d),\; i\in\mathcal{I}_{dE}\}.
\end{equation}
% In the standard mixed problem, the pressure space contains piecewise constant functions
% \begin{equation}
%     \tilde Q_h(\Omega_d) = \{q_d \in L_2(\Omega_d):\; q_d|_{T^i_d}\in\mathbb{P}^0(T^i_d),\; i\in\mathcal{I}_{dE}\}.
% \end{equation}
% \begin{equation}
%     V^{reg}_h = \prod_{\substack{i\in\mathcal{I}_{dE} \\ d=1,2}} \mathbb{RT}^0(T^i_d). \qquad
%     Q_h = \prod_{\substack{i\in\mathcal{I}_{dE} \\ d=1,2}} \mathbb{P}^0(T^i_d).
% \end{equation}
% Considering the hybridization, the disconnected spaces are defined
% \begin{equation}
%     V^{reg}_h(\Omega_d) = \prod_{i\in\mathcal{I}_{dE}} \mathbb{RT}^0(T^i_d), \qquad
%     Q_h(\Omega_d) = \prod_{i\in\mathcal{I}_{dE}} \mathbb{P}^0(T^i_d)
% \end{equation}
% and a~corresponding velocity space with zero flux condition
% \begin{equation}
%     V^{reg}_{0h}(\Omega_d) = \{\vc \psi \in V^{reg}_h(\Omega_d):\; \vc \psi \cdot \vc n = 0 \textrm{ on } \Gamma_{dN}\}.
% \end{equation}
Considering the hybridization, the disconnected spaces are defined
\begin{align}
    V^{reg}_{h}(\Omega_d) &= \{\vc v_d \in \prod_{i\in\mathcal{I}_{dE}} \mathbb{RT}^0(T^i_d):\;
        \vc v_d \cdot \vc n = 0 \textrm{ on } \Gamma_{dN}\}, \\
    Q_h(\Omega_d) &= \prod_{i\in\mathcal{I}_{dE}} \mathbb{P}^0(T^i_d).
\end{align}
It holds $\tilde V_h(\Omega_d) \subset \tilde V(\Omega_d)$ and $\tilde V_h(\Omega_d) \subset V^{reg}_h(\Omega_d)$.
The enriched part of velocity space is defined using the functions from \eqref{eqn:local_enr_vel},
including all wells and aquifers
\begin{equation}
    V^{enr}_h = \spn\{\vc \phi^m_w:\, m\in\mathcal{M}, w\in\mathcal{W}\}.
\end{equation}
Thus we have on the 2d domain the velocity space
\begin{equation}
    V_h(\Omega_2) = V^{reg}_{h}(\Omega_2) \oplus V^{enr}_h.
\end{equation}
In all domains we define the spaces of traces of the normal component of the flux on the element boundaries
\begin{equation}
    \Lambda(\mathcal{F}_d) = \{\mu_d \in L_2(\mathcal{F}_d\setminus\partial\Omega_d):\;
        \mu_d=(\vc v\cdot \vc n)|_{\mathcal{F}_d\setminus\partial\Omega_d},\; \vc v\in \tilde V_h(\Omega_d)\}
\end{equation}
and its discrete subset
\begin{equation}
    \Lambda_h(\mathcal{F}_d) = \{\mu_d \in \Lambda(\mathcal{F}_d):\;
        \mu_d|_{F^i_d}\in\mathbb{P}^0(F^i_d),\; \forall i\in\mathcal{I}_{dF}\}.
\end{equation}
For handling the coupling terms, let us define a~space of average traces of fluxes normal components on well edges
\begin{equation} \label{eqn:lambda_w_space_2d}
    \Lambda^{enr}_h = \{\mu^m_w\in \mathbb P^0(\Gamma^m_w):\;
    \mu^m_w=\avg{\vc v\cdot \vc n}^m_w,\; m\in\mathcal{M}, w\in\mathcal{W},\, \vc v\in V_h(\Omega_2)\}.
\end{equation}
%
Finally let us denote the discretization spaces for the 1d-2d coupled problem:
\begin{align}
    V_h &= V^{reg}_h(\Omega_1) \times V_h(\Omega_2), \label{eqn:vel_h_space}\\
    Q_h &= Q_h(\Omega_1) \times Q_h(\Omega_2) \label{eqn:press_h_space} \\
    \Lambda_h &= \Lambda_h(\mathcal{F}_1)\times \Lambda_h(\mathcal{F}_2) \times \Lambda^{enr}_h, \label{eqn:lambda_h_space}
\end{align}

% The third equation is obtained by testing the equation \eqref{eqn:problem_2d_flux_avg} by $\mu^m_w$
% and integrating over $\Gamma^m_w$.
\thmproblem{ \label{thm:prob_saddle_12d}
Find $\vc u_h=[\vc u_d] \in V_h$ and $p_h = [p_d, \lambda_d, \lambda^m_w] \in Q_h \times \Lambda_h$, 
$d=1,2,\, m\in\mathcal{M},\, w\in\mathcal{W}$ which satisfy
\begin{subequations}
\label{eqn:prob_saddle_coupled_12d}
    \begin{align}
    a_h(\vc u_h,\vc v_h) + b_h(\vc v_h, p_h) &= \langle G, \vc v_h\rangle_{V_h'\times V_h} &&
        \forall \vc v_h\in V_h,
        \label{eqn:prob_saddle_coupled_12d_1}\\
    b_h(\vc u_h, q_h) -c_w(p_h,q_h) &= \langle F, q_h \rangle_{Q_h'\times Q_h} &&
        \forall q_h \in Q_h \times \Lambda_h
        \label{eqn:prob_saddle_coupled_12d_2}
    \end{align}
\end{subequations}
where the forms are
\begin{align*}
a_h(\vc u_h, \vc v_h)=& \sum_{\substack{d=1,2 \\ i\in \mathcal I_{dE}}} \int_{T_d^i}
   \delta_d^{-1} \vc u_d \vc K_d^{-1} \vc v_d \dd\bx, \\
%
b_h(\vc v_h, p_h)=&\sum_{\substack{d=1,2 \\ i\in \mathcal I_{dE}}}\left[
        \int_{T_d^i} -p_d\,\div\,\vc v_d \dd\bx, 
        + \int_{\partial T^i_d\setminus \prtl\Omega}
                 \lambda_d (\vc v_d \cdot \vc n) \dd s\right]\\
        &\color{blue}{ + \sum_{\substack{w\in \mathcal{W} \\ m\in\mathcal{M}}}
            \int_{\Gamma^m_w} \lambda^m_w \avg{\vc v_2 \cdot \vc n}^m_w \dd s},\\
%
\color{blue}
 c_w(p_h,q_h) =& \color{blue}{ \sum_{\substack{w\in \mathcal{W} \\ m\in\mathcal{M}}} \int_{\Gamma^m_w} \delta_2(\bx^m_w)\sigma^m_w
    \big(p_1(\bx^m_w)-\lambda_w\big) \big(q_1(\bx^m_w)-\mu_w\big) \dd s},\\
 \langle G, \vc v_h\rangle_{V_h'\times V_h} =& \sum_{d=1,2}\sum_{i\in \mathcal T_d}
        \int_{\prtl T_d^i\cap \Gamma_{dD}}
                 - g_{dD} (\vc v_d \cdot \vc n) \dd s,\\
 \langle F, q_h\rangle_{Q_h'\times Q_h} =& \sum_{d=1,2}\sum_{i\in \mathcal T_d}%\left(
        \int_{T_d^i} - \delta_d f_d q_d \dd\bx,
%         - \int_{\prtl T_d^i\cap \Gamma_{dN}}
%                  g_{dN} \mu_d\right),
\end{align*}
}
The coupling terms are again emphasized in blue color.

% \begin{subequations}
% \label{eqn:prob_mh_weak_coupled_12}
%     \begin{align}
%     a_h(\vc{u},\vc v) + b_h(\vc v, p) + b_{\mathcal{F}}(\vc v, \lambda) &= \langle G, \vc v\rangle_{V_h\times V_h} &&
%         \forall \vc v\in V_h, \label{eqn:prob_mh_weak_coupled_12_1}\\
%     b_h(\vc{u}, q) - c(p,q) - c_{\mathcal{W}}(q,\lambda) &= \langle F, q \rangle_{Q_h'\times Q_h} &&\forall q \in Q_h,
%         \label{eqn:prob_mh_weak_coupled_12_2}\\
%     b_{\mathcal{F}}(\vc{u}, \mu) - c_{\mathcal{W}}(p,\mu) -\tilde c(\lambda,\mu )&= 0  &&\forall \lambda \in \Lambda_h
%     \label{eqn:prob_mh_weak_coupled_12_3},
%     \end{align}
% \end{subequations}
% where the forms are
% \begin{align*}
% a_h(\vc u, \vc v)=& \sum_{d=1,2}\sum_{i\in \mathcal I_{dE}} \int_{T_d^i}
%    \delta_d^{-1} \vc u_d \vc K_d^{-1} \vc v_d \dd\bx, \\
% %
% b_h(\vc v, p)=&\sum_{d=1,2}\sum_{i\in \mathcal I_{dE}} 
%         \int_{T_d^i} -p_d\,\div\,\vc v_d \dd\bx, \\
% b_{\mathcal{F}}(\vc v, \lambda)=&\sum_{d=1,2}\sum_{i\in \mathcal I_{dF}}
%         \int_{F^i_d\setminus \prtl\Omega}
%                  \lambda_d (\vc v_d \cdot \vc n) \dd s\\
%         &\color{blue}{
%             + \int_{\Gamma_w} \lambda_w \avg{\vc v_2 \cdot \vc n}_w \dd s},\\
% %
% \color{blue}
%  c(p,q) =& \color{blue}{
%           \abs{\Gamma_w} \delta_2(\bx^m_w)\sigma^m_w \avg{p_2}^m_w \avg{q_2}^m_w},\\
% c_\mathcal{W}(p,\mu) =& \color{blue}{
%           -\abs{\Gamma_w} \delta_2(\bx^m_w)\sigma^m_w p_1(\bx^m_w)\mu^m_w},\\
% c(\lambda,\mu) =& \color{blue}{
%           \abs{\Gamma_w} \delta_2(\bx^m_w)\sigma^m_w \lambda^m_w \mu^m_w},\\
%  \langle G, \vc \psi\rangle =& \sum_{d=1,2}\sum_{i\in \mathcal T_d}
%         \int_{\prtl T_d^i\cap \Gamma_{dD}}
%                  - g_{dD} (\vc \psi_d \cdot \vc n),\\
%  \langle F, q\rangle =& \sum_{d=1,2}\sum_{i\in \mathcal T_d}\left(
%         \int_{T_d^i} - \delta_d f_d q_d
%         - %\sum_{d=1,2}\sum_{i\in \mathcal T_d}
%         \int_{\prtl T_d^i\cap \Gamma_{dN}}
%                  g_{dN} \mu_d\right),
% \end{align*}

We note that the nonzero Neumann boundary condition is also implemented.
It technically means changing the right hand side to
\begin{equation} \label{eqn:saddle_point_2d_nonzero_neumann}
 \langle F, q\rangle = \sum_{d=1,2}\sum_{i\in \mathcal T_d}\left(
        \int_{T_d^i} - \delta_d f_d q_d
        - \int_{\prtl T_d^i\cap \Gamma_{dN}}
                 g_{dN} \mu_d\right) \dd s.
\end{equation}
and searching for $\vc u_h = \vc u_{0h} + \vc u_{hN}$,
where $\vc u_h, \vc u_{hN}$ are from larger space than $V_h$,
dismissing the zero flux condition, $\vc u_{hN}$ satisfying the Neumann condition
and $\vc u_{0h} \in V_h$.
% In the Dirichlet problem (setting constant pressure $P_w$ in 1d and supposing only 2d mesh, Dirichlet boundary condition, the thickness $\delta_2=1$) we replace
% \begin{align*}
% \color{blue}
% c(p,\phi) =& \color{blue} \sigma_w\lambda_w\mu_w\abs{\Gamma_w} \\
% \langle F, \vc \phi\rangle =& \sum_{i\in \mathcal T_2}
%         \left(\int_{T_2^i} - f_2 \phi_2\right) \color{blue} -{\int_{\Gamma_w}\sigma_w P_w \mu_w}
% \end{align*}




\section{Coupled 1d-3d model}
\label{sec:coupled_13d}
Let us consider Problem \ref{thm:problem_3d}, including multiple wells.
For the sake of simplicity, we only assume homogenous Neumann boundary condition $g_{dN}=0$, if $\Gamma_{dN}\neq\emptyset$.
Before we define the saddle point form, we must specify how the enrichment functions are computed in 3d,
how the enriched elements are selected and what is the actual support of the enrichment functions.


\subsection{Enrichment Function in 3d}
% https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line
We define the velocity global enrichment function in the same form as in 2d case in \eqref{eqn:global_enr_vel}
\begin{equation}
    \vc s_w(\bx) = -\frac{1}{S_e} \frac{\vc r_w}{r_w^2}, \qquad S_e = 2\pi\rho_w z
    , \qquad \div \vc s_w = \frac{1}{r_w^2}.
    \label{eqn:global_enr_vel_3d}
\end{equation}
%
where the effective surface $S_e$ is the lateral surface of a~cylinder of lenght $z$.
The global enrichment functions have these properties on an element $T$:
\begin{align} \label{eqn:glob_flux_properties_3d}
    \int_{T\setminus \Omega^w_C} \div\,\vc s_w \dd\bx
    &= \int_{\prtl T\setminus\Omega^w_C} \vc s_w\cdot\vc n \dd s = \nonumber\\
    &= \begin{cases}
        \sum \limits_{j=1}^{n_F} \int_{F^j\setminus\Omega^w_C} \vc s_w\cdot\vc n \dd s = 
            \int_{\Gamma_w} \vc s_w\cdot\vc n \dd s
            &\quad T \cap \Gamma_w=\emptyset, \\
        \sum \limits_{j=1}^{n_F} \int_{F^j\setminus \Omega^w_C} \vc s_w\cdot\vc n \dd s 
        = \int_{\Gamma_w\cap T} \vc s_w\cdot\vc n \dd s &\quad T \cap \Gamma_w\subset\Gamma_w. \\
    \end{cases}
\end{align}
% The first case in \eqref{eqn:glob_flux_properties} means that $\vc s_w$ has zero divergence on elements
% not intersecting with the well $w$. The second case means that flux of $\vc s_w$ over element faces
% is equal the flux of $\vc s_w$ from the well, if the intersection lies inside of the element.
% The third case is when the well is intersecting an element face.
% 
Similarly for $\mathbb{RT}^0(T)$ functions it holds
\begin{align} \label{eqn:rt0_flux_properties}
    \int_{T\setminus \Omega^w_C} \div\,\vc\psi_{j}\dd\bx
    &= \int_{\prtl T\setminus \Omega^w_C} \vc\psi_{j}\cdot\vc n \dd s = \nonumber\\
    &= \begin{cases}
        1 & \quad T \cap \Gamma_w=\emptyset, \\
        \int_{F^j\setminus \Omega^w_C} \vc\psi_j\cdot\vc n \dd s
            +\int_{\Gamma_w\cap T} \vc\psi_j\cdot\vc n \dd s
            &\quad T \cap \Gamma_w\subset\Gamma_w. \\
        \end{cases}
\end{align}
%
%
The evaluation of the global enrichment function $\vc s_w$ in 3d is little bit more involved than in the 2d case.
The logarithmic (in pressure) and hyperbolic (in velocity) singularity is concentrated along a~1d line,
so $r_w$ in \eqref{eqn:global_enr_vel_3d} is the distance function from the line.

Let us have the direction vector $\vc d = \vc b - \vc a$ of an abscissa, $\vc a, \vc b$ being its endpoints. 
The abscissa corresponds to an 1d element of $\mathcal{T}_1$.
Let us further have an arbitrary point $\bx$ and compute its 
shortest distance vector $\vc r_w$ from $\vc d$, see \fig{fig:distance_vector_3d}.
%
\begin{figure}[!htb]
  \vspace{5pt}
  \centering
  \def\svgwidth{0.5\textwidth}
  \input{\figpath distance_function_3d.pdf_tex}
  \caption{Distance vector $\vc r_w$ in 3d.}
  \label{fig:distance_vector_3d}
\end{figure}
%
The angle $\alpha$ between $(\bx - \vc a)$ and $\vc d$ is 
\[
\cos(\alpha) = \frac{(\bx - \vc a)\cdot\vc d}{\abs{\bx - \vc a}\abs{\vc d}} = \frac{\abs{\vc d_p}}{\abs{\bx - \vc a}}.
\]
From there we use $\abs{\vc d_p}$ to obtain the projection of $(\bx-\vc a)$ onto $\vc d$
\[
\vc d_p = \abs{\vc d_p}\frac{\vc d}{\abs{\vc d}} = \frac{(\bx - \vc a)\cdot\vc d}{\abs{\vc d}^2} \vc d.
\]
Then the distance vector is
\begin{equation}
  \vc r_w(\bx) = (\bx - \vc a) - \vc d_p = (\bx - \vc a) - \frac{(\bx - \vc a)\cdot\vc d}{\abs{\vc d}^2} \vc d.
\end{equation}

Next let us consider a~mesh of a~single well $\Omega^w_1$ consisting of elements $T^i_1$.
For each element a~global enrichment function $\vc s_{iw}$ is defined as in \eqref{eqn:global_enr_vel_3d},
where $\vc r_w$ is the distance vector to the particular element $T^i_1$.
For each $\vc s_{iw}$ a~cylindrical enrichment zone $Z^i_w$ around the corresponding element $T^i_1$ is determined, 
using the enrichment radius $R_w$, see \fig{fig:enrichment_zone_in_3d}.
%
\begin{figure}[!htb]
    \centering    
    \includegraphics[width=0.6\textwidth]{\figpath 3d_enrichment_zone.pdf} 
    \caption[enrichment zone in 3d]
  {The figure shows cylindrical enrichment zone in 3d.}
  \label{fig:enrichment_zone_in_3d}
\end{figure}
%
The enrichment functions $\vc s_{iw}$ are in fact the same on all the elements,
since we assume the wells to be straight (elements lie on a~line). However their enrichment zones differ from one element to another,
so the enriched degrees of freedom can capture different singularity strenght, if the pressure difference between
the well and the bulk differs along the well.
The enrichment zones $Z^i_w$ can have different enrichment radii, but we do not see any practical advantage for that at the moment.

Finally we define the enriched velocity solution
\begin{align}
    \vc u_h &= 
    \sum \limits_{i=1}^{n_F\cdot N_E} a_i \vc \psi_i + 
    \sum \limits_{w\in\mathcal{W}} \sum \limits_{\substack{i\in\mathcal{I}_{1E} \\ T^i_1\subset\Omega^w_1}}
    b_{iw} \vc \phi_{iw} \label{eqn:velocity_enriched_approximation_3d}
\end{align}
where the local enrichment function is
\begin{align} \label{eqn:local_enr_vel_3d}
    \vc \phi_{iw}(\bx) = \vc L_{iw}(\bx) &= \vc s_{iw}(\bx) - \pi^{RT}_{T^j_3}(\vc s_{iw})(\bx), \qquad j\in\mathcal{J}^w_E.
\end{align}
We see in \eqref{eqn:velocity_enriched_approximation_3d} that there is
one enriched degree of freedom $\beta_{iw}$ per element of each well.


\subsection{Saddle Point Problem in 3d}
We build the saddle point problem like we did in 1d-2d coupled model,
we use the established notation of function spaces in Section \ref{sec:coupled_12d}, where possible.
Let us redefine the velocity space for 3d domain
\begin{equation}
    V_h(\Omega_3) = V^{reg}_{h}(\Omega_3) \oplus V^{enr}_h
\end{equation}
where the enriched part includes the enrichment functions specified in \eqref{eqn:local_enr_vel_3d}:
\begin{equation}
    V^{enr}_h = \spn\{\vc \phi_{iw}: w\in\mathcal{W},\, i\in\mathcal{I}_{1E}\}.
\end{equation}
%
In the 3d case the pressure average along the $\Omega^w_1$ is computed according to \eqref{eqn:average_definition_3d}.
Considering a~mesh $\mathcal{T}_1$ of the 1d domain, see \fig{fig:enrichment_zone_in_3d},
the interior boundary term on cylinder lateral surface $\Gamma_w$ is:
\begin{align} \label{eqn:average_definition_3d_elementwise}
    \int_{\Gamma_w} p_3(\vc v_3 &\cdot \vc n)\dd s =\int_0^1 \int_0^{2\pi} p_3 (\vc v_3\cdot \vc n) \rho_w\abs{\Omega^w_1} \dd \theta \dd t \nonumber\\
     &= \int_0^1 \int_0^{2\pi} \Big[ \avg{p_3}_w(t) \avg{\vc v_3\cdot \vc n}_w(t) +
        \fluct{p_3}_w(t) \fluct{\vc v_3\cdot \vc n}_w(t) \Big]  \rho_w\abs{\Omega^w_1} \dd \theta \dd t \nonumber\\
    &\approx 2\pi\rho_w\abs{\Omega^w_1} \int_0^1 \avg{p_3}_ w(t) \avg{\vc v_3\cdot \vc n}_w(t) \dd t \nonumber\\
    &= 2\pi\rho_w\abs{\Omega^w_1} \sum_{\substack{i\in\mathcal{I}_{1E} \\ T^i_1\subset\Omega^w_1}}
        \int_{T^i_1} \avg{p_3}_w(t) \avg{\vc v_3\cdot \vc n}_w(t) \dd t.
\end{align}
%
In \eqref{eqn:average_definition_3d_elementwise} we neglected the fluctuation part.
We now create a~new space of Lagrange multipliers similar to \eqref{eqn:lambda_w_space_2d},
i.e. a~space of average traces of fluxes normal components on $\Gamma_w$:
\begin{equation}
    \Lambda^{enr} = \{\mu_w\in L_2(\Gamma_w):\;
    \mu_w(t)=\avg{\vc v\cdot \vc n}_w(t),\; w\in\mathcal{W},\, \vc v\in V_h(\Omega_3)\}.
\end{equation}
We further denote $\Omega^{iw}_C = \Omega^w_C|_{t\in T^i_1}$, a~part of $\Omega^w_C$ along the element $T^i_1$,
and define the discrete subset of $\Lambda^{enr}$
\begin{equation}
    \Lambda^{enr}_h = \{\mu_w\in \Lambda^{enr}:\;
    \mu_w|_{\Omega^{iw}_C}=\mathbb P^0(\Omega^{iw}_C),\; w\in\mathcal{W}\}.
\end{equation}

Using the spaces
\begin{align}
    V_h &= V^{reg}_h(\Omega_1) \times V_h(\Omega_3), \label{eqn:vel_h_space_3d}\\
    Q_h &= Q_h(\Omega_1) \times Q_h(\Omega_3) \label{eqn:press_h_space_3d} \\
    \Lambda_h &= \Lambda_h(\mathcal{F}_1)\times \Lambda_h(\mathcal{F}_3) \times \Lambda^{enr}_h, \label{eqn:lambda_h_space_3d}
\end{align}
we formulate the saddle point problem for 1d-3d coupling
\thmproblem{ \label{thm:prob_saddle_13d}
Find $\vc u_h=[\vc u_d] \in V_h$ and $p_h = [p_d, \lambda_d, \lambda_w] \in Q_h \times \Lambda_h$, 
$d=1,3,\, w\in\mathcal{W}$ which satisfy
\begin{subequations}
\label{eqn:prob_saddle_coupled_12d}
    \begin{align}
    a_h(\vc u_h,\vc v_h) + b_h(\vc v_h, p_h) &= \langle G, \vc v_h\rangle_{V_h'\times V_h} &&
        \forall \vc v_h\in V_h,
        \label{eqn:prob_saddle_coupled_13d_1}\\
    b_h(\vc u_h, q_h) -c_w(p_h,q_h) &= \langle F, q_h \rangle_{Q_h'\times Q_h} &&
        \forall q_h \in Q_h \times \Lambda_h
        \label{eqn:prob_saddle_coupled_13d_2}
    \end{align}
\end{subequations}
where the forms are
\begin{align*}
a_h(\vc u_h, \vc v_h)=& \sum_{\substack{d=1,3 \\ i\in \mathcal I_{dE}}} \int_{T_d^i}
   \delta_d^{-1} \vc u_d \vc K_d^{-1} \vc v_d \dd\bx, \\
%
b_h(\vc v_h, p_h)=&\sum_{\substack{d=1,3 \\ i\in \mathcal I_{dE}}}\left[
        \int_{T_d^i} -p_d\,\div\,\vc v_d \dd\bx, 
        + \int_{\partial T^i_d\setminus \prtl\Omega}
                 \lambda_d (\vc v_d \cdot \vc n) \dd s\right]\\
        &\color{blue}{ + \sum_{w\in \mathcal{W}} \Bigg[ 2\pi\rho_w\abs{\Omega^w_1} \sum_{\substack{i\in\mathcal{I}_{1E} \\ T^i_1\subset\Omega^w_1}}
            \int_{T^i_1} \lambda_w(t) \avg{\vc v_3\cdot \vc n}_w(t) \dd t \Bigg]},\\
%             \int_{\Gamma_w} \lambda_w \avg{\vc v_3 \cdot \vc n}_w \dd s\Bigg]},\\
%
\color{blue}
 c_w(p_h,q_h) =& \color{blue}{ \sum_{w\in \mathcal{W}}
        \Bigg[ 2\pi\rho_w\abs{\Omega^w_1} \sum_{\substack{i\in\mathcal{I}_{1E} \\ T^i_1\subset\Omega^w_1}}
        \int_{T^i_1} \sigma_w \big(p_1(t)-\lambda_w(t)\big) \big(q_1(t)-\mu_w(t)\big) \dd t} \Bigg],\\
 \langle G, \vc v_h\rangle_{V_h'\times V_h} =& \sum_{d=1,3}\sum_{i\in \mathcal T_d}
        \int_{\prtl T_d^i\cap \Gamma_{dD}}
                 - g_{dD} (\vc v_d \cdot \vc n) \dd s,\\
 \langle F, q_h\rangle_{Q_h'\times Q_h} =& \sum_{d=1,3}\sum_{i\in \mathcal T_d}%\left(
        \int_{T_d^i} - \delta_d f_d q_d \dd\bx.
%         - \int_{\prtl T_d^i\cap \Gamma_{dN}}
%                  g_{dN} \mu_d\right),
\end{align*}
}

\noindent
The coupling terms are again emphasized in blue color.
Analogically to the 1d-2d model, see \eqref{eqn:saddle_point_2d_nonzero_neumann}, nonzero
Neumann boundary condition can be prescribed.



% \subsection{SGFEM enrichment (single enrichment)}
% We use SGFEM like approach to enrich velocity.
% The enriched velocity has the form:
% \[\sum \limits_{w\in\mathcal{W}} b_w \vc L_w, \]
% where every well $w$ is enriched exactly by one DoF $b_w$.
% % \[
% %   \vc L_w(\vc x) = \textcolor{red}{\vc s_w(\vc x)} - \sum \limits_{j=1}^3 \textcolor{ForestGreen}{z_j} \vc\psi_j(\vc x),
% %   \quad \textcolor{ForestGreen}{z_j=\int_{E_j} \vc s_w(\vc x)\cdot \vc n_j},
% %   \quad \textcolor{red}{\vc s_w(\vc x) = -\frac{1}{2\pi} \frac{\vc r_w}{r_w^2}}
% % \]
% 
% % Accurate integration on sides is needed to compute for coefficients $\color{ForestGreen}z_j$ of the $RT_0$ interpolation of $s_w$.
% 
% The SGFEM enriched shape function on an element $T$ has the form
% \[
%   \vc L_w(\vc x) = \textcolor{red}{\vc s_w(\vc x)} - \sum \limits_{j=1}^{n_E} \textcolor{ForestGreen}{z_j} \vc\psi_j(\vc x),
%   \quad \textcolor{ForestGreen}{z_j=\int_{E_j} \vc s_w(\vc x)\cdot \vc n_j},
%   \quad \textcolor{red}{\vc s_w(\vc x) = -\frac{1}{S_e} \frac{\vc r_w}{r_w^2}},
% \]
% where $n_E$ is the number of sides in 2D, or faces in 3D, $z_j$ is the flux of the global enrichment function $\vc s_w$ over side or face $E_j$ of $T$
% and $S_e$ is the so called effective surface
% %$S_e$ is a portion of the surface of the singularity that communicates with the element $T$
% \[
% S_e = \begin{cases}2\pi\rho_w, \qquad \textrm{in 2d (circle)}, \\ 2\pi\rho_w v \qquad \textrm{in 3d (cylinder of length }v).\end{cases}
% \]
% 
% The flux $z_j$ is computed using adaptive quadrature on sides and faces. The quadrature rules are analogical to the rules
% for adaptive quadrature in elements. These values are computed only once and saved in a vector for further usage (assembly, error computation, output).
% 
% 
% Such local velocity enrichment function has the following important properties:
%   \begin{enumerate}[label=\alph*)]
% %     \setlength{\itemsep}{5pt}
%     \item
%       $\displaystyle \int_T \div\, \vc L_w = \begin{cases}
%         0 & \forall T, T \cap \Gamma_w = \emptyset \\
%         -\sum \limits_{j=1}^3 z_j, & \forall T, T \cap \Gamma_w \neq \emptyset
%     \end{cases}$
%     \item $\displaystyle \int_{E_i} \vc L_w \cdot \vc n_i = 0$
%     \item $\displaystyle \int_{\Gamma_w} \vc L_w \cdot \vc n_w = 1$
%     \item $\displaystyle \int_{\Gamma_w} \vc \psi \cdot \vc n_w = 0, T \cap \Gamma_w = \Gamma_w$\\
%         Not so important. (integral of flux of RT functions over the well edge is zero,
%         if the well edge is included in a single element)
%   \end{enumerate}


