
% \include{snippet_preamble}
% \usepackage{enumitem}

In this chapter we develop mathematical background for our model.
The model formulation is built from a~simple 2d Dirichlet problem to a~fully coupled 1d-2d and 1d-3d problem.

% We start with some general notation and considerations. 

% \cite{koppl_vidotto_2018}
% \notePE{(according to MOX-Report No. 36/2017
% Mathematical modelling, analysis and numerical approximation of second order elliptic problems with inclusions,
% Koeppl, T.; Vodotto, E.; Wohlmuth, B.; Zunino, P.)}
% \begin{equation}
%     \vc v\cdot\vc n = \avg{\vc v\cdot \vc n}_w + \{\vc v\cdot \vc n\}_w \quad \textrm{on } \Gamma_w,
% \end{equation}
% where
% \begin{eqnarray}
%     \avg{\vc v\cdot \vc n}_w &=& \frac{1}{{\abs{\Gamma_w}}} \int_{\Gamma_w} \vc v\cdot \vc n, \\
%     \int_{\Gamma_w} \{\vc v\cdot \vc n\}_w &=& 0. \\
% \end{eqnarray}

\section{Mixed Dirichlet Problem}

At the beginning, we consider a steady 2d problem with a single singularity present in a~domain $\Omega\subset\R^2$.
We take Problem \ref{thm:problem_2d} and restrain ourselves to a~single aquifer, therefore ommitting the index $m$,
and a~single well $w$ perpendicular to the aquifer. Further we fix the pressure in the well,
so we do not solve the 1d part of the problem
and we can focus on the properties of the mixed form in the aquifer domain.
We consider the aquifer thickness $\delta_2=1$ for simplicity.
Due to this assumption we also ommit the dimension index further in this section (we consider only $d=2$).

We let the exterior boundary be  $\Gamma_{ext}=\Gamma_D$, where we prescribe the Dirichlet boundary condition, for simplicity.
The boundary $\Gamma_w$ is created by the (circular) cross-section of the domain $\Omega$
and the wells cylinder envelope $\prtl\Omega^w_C$.
The boundary of the domain $\prtl\Omega=\Gamma_D \cup \Gamma_w$ then consists of only two parts: the exterior boundary $\Gamma_D$
and the interior boundary $\Gamma_w$.

% On $\Gamma_w$, we define the following decomposition of an arbitrary function $g$ on average and fluctuation parts, 
% in the same manner as it can be found in \cite{koppl_vidotto_2018},
% \begin{equation}\label{eqn:average_definition}
%     w = \avg{g}_w + \{g\}_w \quad \textrm{on } \Gamma_w,
% \end{equation}
% where
% \begin{equation}
%     \avg{g}_w = \frac{1}{{\abs{\Gamma_w}}} \int_{\Gamma_w} g \dd s.
% \end{equation}
% From the definition \eqref{eqn:average_definition}, we have immediately the zero mean property of the fluctuation term
% \begin{equation}
% \int_{\Gamma_w} \{g\}_w \dd s = \int_{\Gamma_w} g - \avg{g}_w \dd s = 0.
% \end{equation}

The flow in the domain $\Omega$ is governed by the Darcy's law, the continuity equation and
boundary conditions, gathered in the following definition
\thmproblem{ \label{thm:prob_mixed_simple}
Find $\vc u$ and $p$ satisfying
\begin{eqnarray}
    \vc K^{-1} \vc u + \nabla p &=& 0 \qquad \textrm{in } \Omega, \label{eqn:mixed_form_1}\\
    \div\, \vc u &=& f \qquad \textrm{in } \Omega, \label{eqn:mixed_form_2}\\
    \avg{\vc u \cdot \vc n}_w &=& \sigma_w (\avg{p}_w - P_w) \qquad \textrm{on } \Gamma_w, \label{eqn:mixed_form_3}\\
    p &=& g_{D} \qquad \textrm{on } \Gamma_{D} \label{eqn:mixed_form_4}.
\end{eqnarray}
}
We consider $f\in L_2(\Omega)$ to be the source term and the hydraulic conductivity tensor $\vc K$ to be an invertible
positive definite 2x2 matrix, for which we denote
\begin{eqnarray}
    0 < \underline{k} &=& \inf\limits_{x\in\Omega}\lambda_{\min}(\vc K^{-1}),\\
    \underline{k} \leq \overbar{k} &=& \sup\limits_{x\in\Omega}\lambda_{\max}(\vc K^{-1})
\end{eqnarray}
the minimum and maximum eigenvalues of the inverse matrix.
The constant $P_w\in\R$ is the fixed pressure inside the well, $\sigma_w\in\R$, $\sigma_w>0$ is the
permeability coefficient between the well and the 2d domain. Function $g_D\in L_2(\Gamma_D)$ is the 
prescribed Dirichlet boundary condition for pressure on the exterior boundary.
The condition \eqref{eqn:mixed_form_3} relates the average of the normal flux over $\Gamma_w$ in the outward direction
to the pressure difference. We consider the pressure average on the interior side of $\Gamma_w$.

\subsection{Weak Form of Mixed problem}
We define the following weak spaces for velocity and pressure,
so we can derive the weak form of the problem \eqref{thm:prob_mixed_simple}
\begin{eqnarray}    
    V &=& \{\vc v\in H(\div,\Omega):\; \fluct{\vc v\cdot\vc n} = 0\}, \label{eqn:space_V}\\
    Q &=& \{q \in L_2(\Omega) %;\; \fluct{q} = 0
          \}. \label{eqn:space_Q}
\end{eqnarray}
In the space $V$, notice the assumption on the normal trace where the fluctuation part is neglected: $\{\vc v\cdot \vc n\}_w \approx 0$.
This comes with the idea of a real situation where the well radius is considered very small and the pressure, and so the flux,
is considered nearly constant along the well edge.

The derivation of the weak form follows
\begin{align}
    \int_\Omega \vc u \vc K^{-1} \vc v \dd\bx
    + \int_{\prtl\Omega} p \,(\vc v \cdot \vc n) \dd s
    - \int_\Omega p\,\div\, \vc v \dd\bx &= 0 && \forall \vc v\in V, \label{eqn:mixed_weak_1}\\
    - \int_\Omega q\,\div\, \vc u \dd\bx &= - \int_\Omega fq \dd\bx &&  \forall q\in Q. \label{eqn:mixed_weak_2}
\end{align}
% To apply the given boundary condition on $\Gamma_w$ we define
% the following decomposition of the normal flux into average and fluctuating parts
% \notePE{(according to MOX-Report No. 36/2017
% Mathematical modelling, analysis and numerical approximation of second order elliptic problems with inclusions,
% Koeppl, T.; Vodotto, E.; Wohlmuth, B.; Zunino, P.)}
% \begin{equation}
%     \vc v\cdot\vc n = \avg{\vc v\cdot \vc n}_w + \{\vc v\cdot \vc n\}_w \quad \textrm{on } \Gamma_w,
% \end{equation}
% where
% \begin{eqnarray}
%     \avg{\vc v\cdot \vc n}_w &=& \frac{1}{{\abs{\Gamma_w}}} \int_{\Gamma_w} \vc v\cdot \vc n, \\
%     \int_{\Gamma_w} \{\vc v\cdot \vc n\}_w &=& 0. \\
% \end{eqnarray}
% Next we suppose the fluctuation part to be negligible $\{\vc v\cdot \vc n\}_w \approx 0$
% (in the real situation the well radius is considered very small and the pressure, and so the flux,
% is considered nearly constant around the well edge).
Using the property of the space $V$ we get
\begin{equation}
    \int_{\Gamma_w} p \,(\vc v \cdot \vc n) \dd s = \int_{\Gamma_w} p \,\avg{\vc v \cdot \vc n}_w \dd s
    = \avg{p}_w \avg{\vc v \cdot \vc n}_w \abs{\Gamma_w}
\end{equation}
where we can substitute from the boundary condition \eqref{eqn:mixed_form_3}
\begin{equation}
    \avg{p}_w = \frac{1}{\sigma_w}\avg{\vc u\cdot \vc n}_w + P_w.
\end{equation}
Next, splitting the boundary integral in \eqref{eqn:mixed_weak_1} and using the above,
we obtain the saddle point weak problem
%
\thmproblem{ \label{thm:prob_mixed_weak_simple}
Find $\vc u\in V$ and $p\in Q$ satisfying
% \notePE{Do I have to define the duality brackets $\langle\cdot\rangle$ ?}
\begin{align}
    a(\vc{u},\vc v) + b(\vc v, p) &= \langle G, \vc v\rangle_{V'\times V} &&
        \forall \vc v\in V, \label{eqn:mixed_saddle1}\\
    b(\vc{u}, q) &= \langle F, q \rangle_{Q'\times Q} &&\forall q \in Q
        \label{eqn:mixed_saddle2},
\end{align}
with the bilinear forms $a: V\times V \rightarrow \R$, $b: V\times Q \rightarrow \R$
\begin{align*}
 a(\vc u, \vc v)=& \int_\Omega \vc u \vc K^{-1} \vc v \dd\bx
                   + \frac{1}{\sigma_w}\avg{\vc u\cdot \vc n}_w \avg{\vc v\cdot \vc n}_w \abs{\Gamma_w},\\
%
 b(\vc v, p)=& - \int_\Omega p \,\div\, \vc v \dd\bx,\\
%
 \langle G, \vc v\rangle_{V'\times V} =&
        -\int_{\Gamma_D} g_{D} (\vc v \cdot \vc n) \dd s - P_w\avg{\vc v\cdot\vc n}_w \abs{\Gamma_w},\\
 \langle F, q\rangle_{Q'\times Q} =& - \int_{\Omega} f q \dd\bx.
\end{align*}
}
%
We denote $\langle \cdot, \cdot \rangle_{V'\times V}$ duality between $V$ and its dual space $V'$.
The bilinear forms $a,b$ then define the operators
\begin{align*}
A:\;\;&   V \rightarrow V', & \langle A\vc u,\vc v \rangle_{V'\times V} =&\; a(\vc u,\vc v) && \forall \vc u,\, \vc v \in V\\ 
B:\;\;&   V \rightarrow Q', & \langle B \vc v,q    \rangle_{Q'\times Q} =&\; b(\vc v,q)     && \forall \vc v\in V,\,q \in Q\\
B^T:\;\;& Q \rightarrow V', & \langle \vc v, B^T q \rangle_{V\times V'} =&\; b(\vc v,q)     && \forall \vc v\in V,\,q \in Q
\end{align*}
and the problem \eqref{eqn:mixed_saddle1}-\eqref{eqn:mixed_saddle2}can be rewritten in
\begin{align}
 A\vc{u} + B^Tp &= G \;\textrm{  in } V', \label{eqn:saddle3} \\
 B\vc u &= F  \;\textrm{  in } Q'. \label{eqn:saddle4}
\end{align}


% We will now show that the conditions in theorem \eqref{thm:brezzi_theorem} are fullfilled,
% beginning with the continuity of the bilinear forms.
The bilinear form $a,b$ are continuous. To bound the average terms in the form $a$,
we define auxiliary smooth function $\psi\in C^{\infty}(\overbar\Omega)$ with boundary values
\begin{equation*}
  \psi(\bx) =
  \begin{cases}
    1 & \textrm{ on } \Gamma_w, \\
    0 & \textrm{ on } \Gamma_D.
  \end{cases} \nonumber
\end{equation*}
Then for $\vc v\in V$ we have
\begin{align*}
  \avg{\vc v \cdot\vc n}_w = \int_{\Gamma_w} \vc v \cdot\vc n \psi \dd s = 
    \int_{\partial\Omega} \left( \psi \vc v \right) \cdot\vc n \dd s & \\
    = \int_{\Omega} \div\left( \psi \vc v \right) \dd\bx
    = \int_{\Omega} \psi\, \div\, &\vc v \dd\bx + \int_{\Omega} \vc v \cdot \grad\psi \dd\bx \\
    \leq \norm{\psi}_{L_2(\Omega)} \norm{\div\,\vc v}_{L_2(\Omega)}& + \norm{\grad\psi}_{L_2(\Omega)} \norm{\vc v}_{L_2(\Omega)}
    \leq C_w \norm{\vc v}_{H(\div,\Omega)}
\end{align*}
with a constant $C_w(\partial\Omega)$. Then we obtain the following bound
\begin{multline} \label{eqn:form_a_bound}
    \abs{a(\vc u,\vc v)} \leq \overbar{k}\, \norm{\vc u}_{L_2(\Omega)} \norm{\vc v}_{L_2(\Omega)}
        + \abs{\sigma_w} \abs{\Gamma_w} \avg{\vc u\cdot\vc n}_w \avg{\vc v\cdot\vc n}_w\\
        \leq \alpha_2 \norm{\vc u}_{H(\div,\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall \vc u,\vc v\in V,
\end{multline}
with a constant $\alpha_2 \left(\overbar{k}, \sigma_w, \partial\Omega\right)$.
%\notePE{I don't understand the last step of Theorem 90 proof, p.103, 'numpde.pdf' to bound the average terms.
% easy: the phi terms must be <= 1 and for the result we use  (a+b)^2 <= 2(a^2+b^2)
%}
The continuity of $b$ is straightforward
\begin{equation} \label{eqn:form_b_bound}
    \abs{b(\vc v,p)} \leq \norm{p}_{L_2(\Omega)} \norm{\div\,\vc v}_{L_2(\Omega)}
        \leq \norm{p}_{L_2(\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall q\in Q,\;\forall \vc v\in V.
\end{equation}
% putting the constant $\beta_2=1$.

The bilinear form $a$ is coercive on kernel space $V_0=\{\vc v\in V: b(\vc v,q)=0\;\forall q\in Q\}$, i.e.
a subspace of $V$ where $\div\,\vc v=0$,
\begin{multline} \label{eqn:form_a_coercivity_V0}
    a(\vc v,\vc v) \geq \underline{k} \norm{\vc v}^2_{L_2(\Omega)}
                + \sigma_w^{-1}\abs{\Gamma_w}\avg{\vc v\cdot\vc n}_w^2 \\
        \geq  \alpha_1 \norm{\vc v}^2_{L_2(\Omega)} = \alpha_1 \norm{\vc v}^2_{H(\div,\Omega)} \quad \forall \vc v\in V_0,
\end{multline}
with $\alpha_1=\underline{k}$ and having the average term greater than zero.

To proove the continous $\inf$-$\sup$ condition (\cite{brezzi_mixed_1991}, p. 42),
the so-called Ladyshenskaja-Babu{\v s}ka-Brezzi (LBB) condition,
we construct for given $q\in Q$ function $\vc v$, satisfying the inequality.
We solve the artificial Poisson problem
\begin{equation} \label{eqn:lbb_artificial_poisson}
% \begin{eqnarray*}    
\begin{aligned}
    -\Delta\varphi &= q\\
    \varphi &= 0 \textrm{ on } \Gamma_D \\
    \grad\varphi\cdot\vc n &= 0 \textrm{ on } \Gamma_w
\end{aligned}
% \end{eqnarray*} 
\end{equation}
with homogenous Dirichlet b.c. on $\Gamma_D$ and homogenous Neumann b.c. on $\Gamma_w$.
From the ellipticity of the artificial problem we get
\begin{equation}
    \norm{\grad\varphi}_{L_2(\Omega)} \leq \norm{\varphi}_{H^1(\Omega)}
        \leq C_F^2 \norm{q}_{L_2(\Omega)},
\end{equation}
with $C_F(\Omega,\Gamma_D)$ from Friedrich's inequality.
Next we set $\vc v = -\grad \varphi$, holding $\fluct{\vc v\cdot\vc n}=0$ for this particular $\varphi$,
and so $\div\,\vc v = -\Delta\varphi=q$. Then we can bound the norm
\begin{equation}
    \norm{\vc v}^2_{H(\div,\Omega)} = \norm{\vc v}^2_{L_2(\Omega)} 
        + \norm{\div\,\vc v}^2_{L_2(\Omega)}
        \leq (1+C_F^4) \norm{q}^2_{L_2(\Omega)}.
\end{equation}
Using it in the LBB condition, we obtain
\begin{equation} \label{eqn:form_b_lbb}
    \sup_{\vc v\in V} \frac{b(\vc v,q)}{\norm{\vc v}_{H(\div,\Omega)}} \geq
    \frac{\norm{q}^2_{L_2(\Omega)}}{\norm{\grad\varphi}_{H(\div,\Omega)}}
    \geq \frac{1}{(1+C_F^4)^{1/2}} \norm{q}_{L_2(\Omega)} = \beta_1 \norm{q}_{L_2(\Omega)},
\end{equation}
and having the constant $\beta_1 = (1+C_F^4)^{-1/2}$.

Using the Brezzi's theorem (\cite{brezzi_mixed_1991}, p. 42), we see that we have now
all necessary conditions for the existence of the unique solution $\vc u$, $p$ of Problem \eqref{thm:prob_mixed_weak_simple}.
The pressure part of the solution $p$ is according to the Brezzi's theorem defined up to an element of $\Ker B^T$.
If we use the same construction of $\vc v$ as in the auxiliary Poisson problem \eqref{eqn:lbb_artificial_poisson},
we see, that
\[
    \langle \vc v, B^T q \rangle_{V\times V'} = b(\vc v,q) = \int_\Omega q^2 \dd\bx \geq 0
\]
and so that $b(\vc v,q) = 0 \iff q=0$ and therefore $\Ker B^T=\{0\}$.

We summarize this result on the continuous spaces in the following theorem
\theorem{ \label{thm:brezzi_theorem}
Let $a$ be a~continuous bilinear form on $V\times V$ and $b$ be a~continuous bilinear form on $V\times Q$, i.e.
\begin{eqnarray}
    \abs{a(\vc u,\vc v)} &\leq& \alpha_2 \norm{\vc u}_{H(\div,\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall \vc u,\vc v\in V,\\
    \abs{b(\vc v,p)} &\leq& \beta_2 \leq \norm{p}_{L_2(\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall q\in Q,\;\forall \vc v\in V,
\end{eqnarray}
with the constants $\alpha_2$ from \eqref{eqn:form_a_bound} and $\beta_2=1$ from \eqref{eqn:form_b_bound}.
Let us suppose that $a$ is coercive on the kernel $V_0$ of the space $V$, i.e. there holds
\begin{equation}
    a(\vc v,\vc v) \geq \alpha_1 \norm{\vc v}^2_{H(\div,\Omega)} \quad \forall \vc v\in V_0,
\end{equation}
with the constant $\alpha_1$ from \eqref{eqn:form_a_coercivity_V0},
and that there holds the LBB condition
\begin{equation}
    \sup_{\vc v\in V} \frac{b(\vc v,q)}{\norm{\vc v}_{H(\div,\Omega)}} \geq \beta_1\norm{q}_{L_2(\Omega)} \quad \forall q\in Q,
\end{equation}
with $\beta_1$ from \eqref{eqn:form_b_lbb}.\\
Then there exists a~unique solution $\vc u$, $p$ to Problem \eqref{thm:prob_mixed_weak_simple} for any $F\in V'$ and $G\in Q'$
such that the solution fullfills the stability estimate
\begin{eqnarray}
    \norm{\vc u}_{H(\div,\Omega)} &\leq& \frac{1}{\alpha_1} \norm{F}_{V'} + \left( \frac{\alpha_2}{\alpha_1} + 1\right)\frac{1}{\beta_1} \norm{G}_{Q'},\\
    \norm{p}_{L_2(\Omega)} &\leq& \frac{1}{\beta_2} \left(1+ \frac{\alpha_2}{\alpha_1} \right) \norm{F}_{V'}
            + \frac{\alpha_2}{\beta_1^2} \left( 1+ \frac{\alpha_2}{\alpha_1}\right) \norm{G}_{Q'}.
\end{eqnarray}
}
% \theorem{ \label{thm:brezzi_theorem}
% Let $a$ be a~continuous bilinear form on $V\times V$ and $b$ be a~continuous bilinear form on $V\times Q$, i.e.
% \begin{eqnarray}
%     \abs{a(\vc u,\vc v)} &\leq& \alpha_2 \norm{\vc u}_{H(\div,\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall \vc u,\vc v\in V,\\
%     \abs{b(\vc v,p)} &\leq& \beta_2 \leq \norm{p}_{L_2(\Omega)} \norm{\vc v}_{H(\div,\Omega)} \quad \forall q\in Q,\;\forall \vc v\in V.
% \end{eqnarray}
% Let us suppose that $a$ is coercive on the kernel $V_0$ of the space $V$, i.e. there holds
% \begin{equation}
%     a(\vc v,\vc v) \geq \alpha_1 \norm{\vc v}^2_{H(\div,\Omega)} \quad \forall \vc v\in V_0,
% \end{equation}
% and that there holds the LBB (Ladyshenskaja-Babu{\v s}ka-Brezzi) condition
% \begin{equation}
%     \sup_{\vc v\in V} \frac{b(\vc v,q)}{\norm{\vc v}_{H(\div,\Omega)}} \geq \beta_1\norm{q}_{L_2(\Omega)} \quad \forall q\in Q.
% \end{equation}
% Then there exists a \notePE{unique} solution to problem \eqref{thm:prob_mixed_simple} for any $F\in V'$ and $G\in Q'$
% \notePE{where velocity $u$ is unique and pressure $p$ is defined up to an element of $Ker B'$}
% such that the solution fullfills the stability estimate
% \begin{eqnarray}
%     \norm{\vc u}_{H(\div,\Omega)} &\leq& \frac{1}{\alpha_1} \norm{F}_{V'} + \left( \frac{\alpha_2}{\alpha_1} + 1\right)\frac{1}{\beta_1} \norm{G}_{Q'}\\
%     \norm{p}_{L_2(\Omega)} &\leq& \frac{1}{\beta_2} \left(1+ \frac{\alpha_2}{\alpha_1} \right) \norm{F}_{V'}
%             + \frac{\alpha_2}{\beta_1^2} \left( 1+ \frac{\alpha_2}{\alpha_1}\right) \norm{G}_{Q'}.
% \end{eqnarray}
% }

% \notePE{There is also some lemma in Brezzi, which says: if B is surjective (and $\div$ is) then the LBB condition holds.}
% 


\subsection{Discretization of Mixed Problem}

The discretization applied in the flow model in Flow123d is followed in this section
and it is enhanced using an~enrichment of the velocity space.
In contrast to the first part of this work, simplicial meshes are considered from now on.
At the beginning a~mixed-hybrid discretization approach is described,
then a~proper enrichment of the discrete velocity space is introduced.


For the approximation of the $H(\div,\Omega)$ space, we use the lowest order Raviart-Thomas space
\begin{equation}
    \mathbb{RT}^0(T^i) = \{\vc\psi_j\}_{j=1}^{n_F}, 
\end{equation}
on the element $T^i$, $i\in\mathcal{I}_E$. The vector basis functions of $\mathbb{RT}^0(T^i)$
are defined in the standard way
\begin{equation}
    \vc\psi_j(\bx) = \frac{\abs{F^j}}{\abs{T^i}} \left( \bx - \bx_k \right), \qquad \bx\in T^i,\, j=1,\ldots,n_F
\end{equation}
with $\bx_k$ being the opposite node of face $F^j$ and $n_F$ the number of faces of the element $T^i$
(holds in all dimensions, having $\abs{F^j}:=1$ in 1d for point faces).
The degrees of freedom are interpreted as the fluxes over the corresponding faces
\begin{equation}
    \int_{F_i} \vc\psi_j \cdot \vc n \dd s = \delta_{ij} \qquad i,j=1,\ldots,n_F.
\end{equation}
Let us denote the standard discrete space for velocity
\begin{equation}
    \tilde V_h^{reg} = \{\vc v\in V: \vc v|_{T^i} \in \mathbb{RT}^0(T^i),\; i\in\mathcal{I}_E \},
\end{equation}
% The pressure space $Q$ is discretized using the finite dimensional space
and the discrete space for pressure, consisting of piecewise constant functions
\begin{equation}
    Q_h=\{q\in L_2(\Omega):\; q|_{T^i}\in \mathbb{P}^0(T^i),\; i\in\mathcal{I}_E\}.
\end{equation}
One can then read the discrete counterpart of Problem \ref{thm:prob_mixed_weak_simple} as follows
\thmproblem{ \label{thm:prob_mixed_weak_simple_discrete}
Find $\vc u\in \tilde V_h^{reg}$ and $p\in Q_h$ satisfying
\begin{align}
    a(\vc{u},\vc v) + b(\vc v, p) &= \langle G, \vc v\rangle_{V'\times V} &&
        \forall \vc v\in \tilde V_h^{reg}, \label{eqn:mixed_saddle1}\\
    b(\vc{u}, q) &= \langle F, q \rangle_{Q'\times Q} &&\forall q \in Q_h
        \label{eqn:mixed_saddle2}.
\end{align}
}


Considering the hybridization, we define a~new discrete space
\begin{equation}
    V_h^{reg} = \prod\limits_{i\in\mathcal{I}_E} \mathbb{RT}^0(T^i)
\end{equation}
in which the functions normal components on the element faces are not continuous
in contrast to $\tilde V_h^{reg}$.
Further we define the space of Lagrange multipliers
\begin{equation}
    \Lambda^{reg} = \{\mu\in L_2(\mathcal{F}\setminus\partial\Omega): \mu=(\vc v\cdot\vc n)|_{\mathcal{F}\setminus\partial\Omega},\; \vc v\in \tilde V_h^{reg}\}.
\end{equation}

% The discrete pressure space $Q_h$ is not enriched.
By splitting the integrals in the bilinear forms onto elements and using the spaces above,
Problem \ref{thm:prob_mixed_weak_simple_discrete} is then transformed to

\thmproblem{ \label{thm:prob_mh_weak_simple}
Find $(\vc u, p, \lambda) \in V_h^{reg} \times Q_h \times \Lambda^{reg}$ which satisfy
\begin{subequations}
\label{eqn:prob_mh_weak_simple}
\begin{align}
    a_h(\vc{u},\vc v) + b_h(\vc v, p) + b_{\mathcal{F}}(\vc v, \lambda) &= \langle G, \vc v\rangle_{V_h^{'reg}\times V_h^{reg}} &&
        \forall \vc v\in V_h^{reg}, \label{eqn:prob_mh_weak_simple1}\\
    b_h(\vc{u}, q) &= \langle F, q \rangle_{Q_h'\times Q_h} &&\forall q \in Q_h,
        \label{eqn:prob_mh_weak_simple2}\\
    b_{\mathcal{F}}(\vc{u}, \mu) &= 0 &&\forall \mu \in \Lambda^{reg} \label{eqn:prob_mh_weak_simple3},
\end{align}
\end{subequations}
with the bilinear forms %$a: V\times V \rightarrow \R$, $b: V\times Q \rightarrow \R$
\begin{subequations}
\label{eqn:prob_mh_weak_simple_forms}
\begin{align}
 a_h(\vc u, \vc \psi)=&\sum_{i\in \mathcal I_E} \int_{T^i}
   \vc u \vc K^{-1} \vc v \dd\bx
   + \frac{1}{\sigma_w}\avg{\vc u\cdot \vc n}_w \avg{\vc v\cdot \vc n}_w \abs{\Gamma_w},\\
%
 b_h(\vc v, p)=&\sum_{i\in \mathcal I_E} 
        \int_{T^i} -p\,\div\,\vc v \dd\bx, \\
 b_{\mathcal{F}}(\vc v, \lambda)=&\sum_{i\in \mathcal I_F}        
        \int_{F^i\setminus \prtl\Omega}
                 \lambda (\vc v \cdot \vc n) \dd s,\\
 \langle G, \vc v\rangle_{V_h^{'reg}\times V_h^{reg}} =& \sum_{i\in \mathcal I_F}
        \int_{F^i\cap \Gamma_{D}}
                 - g_{D} (\vc v \cdot \vc n) \dd s,\\
 \langle F, q\rangle_{Q_h'\times Q_h} =& \sum_{i\in \mathcal I_E}
        \int_{T^i} -f q \dd\bx.
\end{align}
\end{subequations}
}

The continuity of the normal components on the element faces, which is missing in $V_h^{reg}$, is forced by the equation \eqref{eqn:prob_mh_weak_simple3},
so that the solution $\vc u\in V$. Thus the problems \ref{thm:prob_mixed_weak_simple_discrete} and \ref{thm:prob_mh_weak_simple} are equivalent.
The Lagrange multipliers $\lambda$ represent the trace of pressure $p$ on element faces $\mathcal F$. See \cite{lawrence_balancing_1995} for details.

% Lagrange multiplicators represent pressure trace on element faces
% Cowsar LC, Mandel J, Wheeler MF. Balancing domain decomposition for mixed finite elements. Mathematics of
% Computation 1995; 64(211):989–1015.


In addition to this standard discretization approach, we are now interested in a~proper XFEM enrichment of the velocity space.
To this end we introduce space $V_h^{enr}$ in a~similar manner as in the pressure model in Section \ref{sec:prim_discretization},
such that the discrete velocity space is
\begin{equation}
    V_h = V_h^{reg} + V_h^{enr}.
\end{equation}


At first, we suppose the simpler case when the well cross section is
inside the elements $T\cap\Gamma_w = \Gamma_w$ in 2d case.
This means the edges are not cut by the well edge.
We define an interpolation operator into $\mathbb{RT}^0(T)$ space of an arbitrary element $T$
\begin{equation}
    \pi^{RT}_T\vc v = \sum_{j=1}^{n_F} \left( \int_{F_j} \vc v \cdot \vc n \dd s \right)  \vc \psi_j
    \qquad \forall \vc v \in V, \label{eqn:local_rt_interpolator}
\end{equation}
which satisfies
\begin{align}
b(\pi^{RT}_T\vc v- \vc v, q)_T &= 0 \qquad \forall q\in Q_h\\ 
\int_T \div(\pi^{RT}_T\vc v- \vc v) &= 0 \qquad \textrm{since } q|_T\in \mathbb{P}^0.
\end{align}

% \begin{eqnarray}
%     V_T = \mathbb{RT}^0(T) &=& \{\vc\psi_j\}_j^{nE}\\
%     V_h &=& \{\vc v: \vc v|_T\in V_T,\; \}\\
% \end{eqnarray}

We now introduce SGFEM like enrichment for the velocity.
The global enrichment function is
\begin{equation}
    \vc s_w(\vc x) = -\frac{1}{S_e} \frac{\vc r_w}{r_w^2} \label{eqn:global_enr_vel},
\end{equation}
where $S_e$ is the so called effective surface
\[
S_e = \begin{cases}2\pi\rho_w, \qquad \textrm{in 2d (circle)}, \\ 2\pi\rho_w v \qquad \textrm{in 3d (cylinder of length }v).\end{cases}
\]
The global enrichment functions have these flux properties
\begin{align}
    \int_{\prtl T} \vc s_w\cdot\vc n \dd s = - \int_T \div\,\vc s_w \dd\vc x = \nonumber\\
    = \begin{cases}
        \sum \limits_{j=1}^{n_E} \int_{E_j} \vc s_w\cdot\vc n \dd s = 0
            & \quad T \cap \Gamma_w=\emptyset, \\
        \sum \limits_{j=1}^{n_E} \int_{E_j} \vc s_w\cdot\vc n \dd s = 
            - \int_{\Gamma_w} \vc s_w\cdot\vc n \dd s
            &\quad T \cap \Gamma_w=\Gamma_w, \\
        \sum \limits_{j=1}^{n_E} \int_{E_j\setminus B_w} \vc s_w\cdot\vc n \dd s 
        = - \int_{\Gamma_w\cap T} \vc s_w\cdot\vc n \dd s &\quad T \cap \Gamma_w\subset\Gamma_w. \\
    \end{cases}
\end{align}

The local enrichment functions have a form
\begin{equation}
    \vc L_{iw}(\vc x) = N_i(\vc x)\vc s_w(\vc x) - \sum \limits_{j=1}^{n_E} \textcolor{ForestGreen}{z^{iw}_j} \vc\psi_j(\vc x),
  \quad \textcolor{ForestGreen}{z^{iw}_j=\int_{E_j} N_i (\vc s_w\cdot \vc n)\dd s} \label{eqn:local_enr_vel},
\end{equation}
and the following divergence properties
\begin{equation}
    \div\,\vc L_{iw} = \grad N_i \cdot \vc s_w - \sum \limits_{j=1}^{n_E} z^{iw}_j \div\,\vc\psi_j
    \label{eqn:local_enr_vel_div},
\end{equation}
\begin{equation}
    \sum \limits_{i=1}^{n_N} \div\,\vc L_{iw} = - \sum \limits_{j=1}^{n_E} \div\,\vc\psi_j \int_{E_j} \vc s_w\cdot\vc n \dd s
    \label{eqn:local_enr_vel_sum_div},
\end{equation}
and following flux properties
\begin{align}
    \int_{E_k} \vc L_{iw}\cdot\vc n \dd s = \int_{E_k} N_i \vc s_w\cdot\vc n \dd s
        - \sum \limits_{j=1}^{n_E} z^{iw}_j \int_{E_k} \vc\psi_j \cdot \vc n \dd s \nonumber\\
    = \int_{E_k} N_i \vc s_w\cdot\vc n \dd s - z^{iw}_k = 0
    \label{eqn:local_enr_vel_normal},
\end{align}
\begin{align}
    \int_{T} \sum \limits_{i=1}^{n_E} \div\,\vc L_{iw}\dd\vc x =
        - \sum \limits_{j=1}^{n_E} \int_{E_j} \vc s_w\cdot\vc n \dd s
        \int_T \div\,\vc\psi_j \dd \vc x \nonumber\\
    = \begin{cases}
        0 & \quad T \cap \Gamma_w=\emptyset, \\
        \int_{\Gamma_w} \vc s_w\cdot\vc n \dd s &\quad T \cap \Gamma_w=\Gamma_w \\
        \end{cases}
    \label{eqn:local_enr_vel_int_sum_div},
\end{align}
since for $\mathbb{RT}^0(T)$ functions it holds
\begin{align}
    -\int_{T} \div\,\vc\psi_{j}\dd\vc x
    = \int_{\prtl T} \vc\psi_{j}\cdot\vc n \dd s
    = \int_{E_j\setminus B_w} \vc\psi_j\cdot\vc n \dd s
      +\int_{\Gamma_w\cap T} \vc\psi_j\cdot\vc n \dd s \\
    = \begin{cases}
        1 & \quad T \cap \Gamma_w=\emptyset, \\
        1 & \quad T \cap \Gamma_w=\Gamma_w, \\
        \int_{E_j\setminus B_w} \vc\psi_j\cdot\vc n \dd s
            +\int_{\Gamma_w\cap T} \vc\psi_j\cdot\vc n \dd s
            &\quad T \cap \Gamma_w\subset\Gamma_w. \\
        \end{cases}
    \label{eqn:local_reg_vel_int_div}
\end{align}

The enriched velocity has the form:
\[
    \vc u = 
    \sum \limits_{i\in\mathcal{I}} a_i \vc \psi_i + 
    \sum \limits_{w\in\mathcal{W}} \sum \limits_{i\in\mathcal{I}_w} b_{iw} \vc L_{iw},
\]
where every well $w$ enriches all nodes in index set $\mathcal{I}_w$.

\notePE{Below following the proof in 'numpde.pdf' from page 108, 'Brezzi' p.42}
\paragraph{Coercivity of $a$ on $V_{0h}=\ker B_h$.}
Since we enriched space $V_h$, we no longer have $\div\,V_{h}\subset Q_h$
($\div\,V_{h}$ is not the space of piecewise constant functions anymore).
Therefore the simple restriction $V_{0h}\not\subset V_0$ does not hold and 
we need to check the coercivity
\[a(\vc v_h,\vc v_h)\geq \norm{\vc v_h}^2_V  \qquad \forall \vc v_h\in V_{0h}\].

\notePE{
    Instead it might be sufficient to proove one of the weaker conditions:
    \begin{eqnarray}
    \inf_{\vc u_h\in V_{0h}}\sup_{\vc v_h\in V_{0h}}
        \frac{a(\vc u_h, \vc v_h)}{\norm{\vc u_h}_V \norm{\vc u_h}_V}
    \geq \alpha_{1h}, \\
    \inf_{\vc v_h\in V_{0h}}\sup_{\vc u_h\in V_{0h}}
        \frac{a(\vc u_h, \vc v_h)}{\norm{\vc u_h}_V \norm{\vc u_h}_V}
    \geq \alpha'_{1h},
    \end{eqnarray}
    (Brezzi p.52, for finite-dimensional case, surjectivity and injectivity are equivalent).
}

\paragraph{Discrete LBB condition.}

%(inequation 3.14, p. 75 in \cite{brezzi_mixed_1991}

According to Lemma 99 ('numpde.pdf'), if there exists an interpolation operator
$\pi_h: V\rightarrow V_h$ which is continuous and satisfies
\begin{equation}
    b(\pi_h\vc v- \vc v, q) = 0 \quad \forall q\in Q_h,\\ 
\end{equation}
then the LBB condition holds.
For standard space choice $\mathbb{RT}^0\times\mathbb{P}^0$ we define
the operator 
\begin{equation}
    (\pi^{RT}_h \vc v)|_T = \pi^{RT}_T \vc v
\end{equation}
using the local interpolation operator from \eqref{eqn:local_rt_interpolator}.
This operator is not continuous on $V=H(\div,\Omega)$ but on
smaller space we have
\begin{equation}
    \norm{\pi^{RT}_h \vc v}_V \leq C_\pi \norm{\vc v}_W \qquad \forall \vc v\in W=[H^1(\Omega)]^d
\end{equation}
and
\begin{equation}
    \sup_{\vc v\in W} \frac{(\div\,\vc v, q)}{\norm{\vc v}_W} \geq \tilde{k}_0 \norm{q}_Q \qquad \forall q\in Q.
\end{equation}
Using this we obtain for all $q_h\in Q_h$
\begin{align}
    \sup_{\vc v_h\in V_h} \frac{b(\vc v_h,q_h)}{\norm{\vc v_h}_V} \geq
    \sup_{\vc v_h\in W} \frac{\int_{\Omega} q_h \div (\pi^{RT}_h \vc v_h)}{\norm{\pi^{RT}_h \vc v}_V} \geq
    \frac{1}{C_\pi} \sup_{\vc v_h\in W} \frac{\int_{\Omega} q_h \div\,\vc v}{\norm{\vc v}_W}
    \nonumber\\ \geq \frac{\tilde{k}_0}{C_\pi}\norm{q_h}_Q
\end{align}




\section{Coupled 1d-2d model (Mixed Hybrid model)}

In ambient 3d space, induces point sources (0d-2d problem).
  
  Mixed form:
  \begin{eqnarray}
\frac{1}{\delta_d} \vc K_d^{-1}\vc u_d + \nabla p_d &=& 0 \qquad \textrm{in } \Omega_d,\; d=1,2  \\
\nabla \cdot \vc u_2 &=& \delta_2 f_2 \qquad \textrm{in } \Omega_2\\
\nabla \cdot \vc u_1 &=& \delta_1 f_1 + {\color{blue}\sigma_w(\avg{p_2}_w-p_1)}\qquad \textrm{in } \Omega_1\\
\color{blue}\avg{\vc u_2 \cdot \vc n}_w &=& \color{blue}\sigma_w (\avg{p_2}_w - p_{1}) \qquad \textrm{on } \Gamma_w\\
p_d &=& g_{dD} \qquad \textrm{on } \Gamma_{dD},\; d=1,2 \\
-\vc u_d \cdot \vc n &=& g_{dN} \qquad \textrm{on } \Gamma_{dN},\; d=1,2
  \end{eqnarray}
  
where $\delta_d$ is the cross section coefficient in respective dimension (thickness
of a~fracture in 2d,cross-section of a~channel in 1d). The total flux boundary condition $g_{dN}$ is considered as an inflow.


  Mixed-Hybrid form (saddle point problem): 
\begin{align}
        \label{Saddle1}
 a(\vc{u},\vc \psi) + b(\vc\psi, p) &= \langle G, \vc \psi\rangle &&\forall 
\vc\psi\in V,\\
        \label{Saddle2}
 b(\vc{u}, \phi) - c(p,\phi) &= \langle F, \phi \rangle &&\forall \phi \in Q,
\end{align}
where bilinear forms on the left-hand side are
\begin{align*}
 a(\vc u, \vc \psi)=&\sum_{d=1,2}\sum_{i\in \mathcal T_d} \int_{T_d^i}
   \frac{1}{\delta_d} \vc u_d \vc K_d^{-1} \vc \psi_d,\\
%
 b(\vc \psi, p)=&\sum_{d=1,2}\sum_{i\in \mathcal T_d} 
        \left(
        \int_{T_d^i} -p_d\div\,\vc \psi_d
        +\int_{\prtl T_d^i\setminus \prtl\Omega}
                 \lambda_d (\vc \psi_d \cdot \vc n)
        \right) \\
%         &\color{blue}{
%                  + \lambda_w \avg{\vc \psi_2 \cdot \vc n}_w \abs{\Gamma_w}},\\
        &\color{blue}{
            + \int_{\Gamma_w} \lambda_w \avg{\vc \psi_2 \cdot \vc n}_w},\\
%
\color{blue}
 c(p,\phi) =& \color{blue}
          \int_{\Gamma_w}
               \sigma_w(p_{1}-\lambda_w)(\phi_{1}-\mu_w),\\
 \langle G, \vc \psi\rangle =& \sum_{d=1,2}\sum_{i\in \mathcal T_d}
        \int_{\prtl T_d^i\cap \Gamma_{dD}}
                 - g_{dD} (\vc \psi_d \cdot \vc n),\\
 \langle F, \vc \phi\rangle =& \sum_{d=1,2}\sum_{i\in \mathcal T_d}\left(
        \int_{T_d^i} - \delta_d f_d \phi_d
        - %\sum_{d=1,2}\sum_{i\in \mathcal T_d}
        \int_{\prtl T_d^i\cap \Gamma_{dN}}
                 g_{dN} \mu_d\right),
\end{align*}
where $p=(p_d,\lambda_d, \lambda_w)$, $\phi=(\phi_d,\mu_d, \mu_w)$.

In the Dirichlet problem (setting constant pressure $P_w$ in 1d and supposing only 2d mesh, Dirichlet boundary condition, the thickness $\delta_2=1$) we replace
\begin{align*}
\color{blue}
c(p,\phi) =& \color{blue} \sigma_w\lambda_w\mu_w\abs{\Gamma_w} \\
\langle F, \vc \phi\rangle =& \sum_{i\in \mathcal T_2}
        \left(\int_{T_2^i} - f_2 \phi_2\right) \color{blue} -{\int_{\Gamma_w}\sigma_w P_w \mu_w}
\end{align*}


We shall use the following FE discrete spaces:
$\vc u_d$ (velocity) - discontinuous $RT_0$ elements + \textcolor{blue}{\bf singular enrichment}\\
$p_d$ (pressure head)- piecewise constant, $P_0$ on elements \\
$\lambda_d$ (pressure head traces) - piecewise constant, $P_0$ on edges \\
\textcolor{blue}{$\lambda_w$ (pressure head traces) - piecewise constant, $P_0$ on $\Gamma_w$}



% \begin{equation}
%   \begin{pmatrix}
%      u_1 & u_2 & u_3 & b_w & p & \lambda & \lambda_w
%   \end{pmatrix}
% \end{equation}

% \section{Branch PE xfem innovations}
% 
% \subsection{Output Mesh and quadrature refinement}
% The refinement of elements for the output mesh is done using edge splitting technique (so called red refinement).
% Since we use this only for better output visualization of non-polynomial solutions, we do not
% care for existence of hanging nodes.
% 
% In 2D case, it is straightforward process: find the midpoints of all sides, connect them and generate 4 triangles.
% These triangles are congruent and have equal surface areas.
% 
% On the other hand, the 3D case is more complicated. After splitting the edges, we obtain 4 tetrahedra at the vertices
% of the original one. The octahedron that remains in the middle can be subdivided according to one of its three diagonals.
% Only the choice of the shortest octahedron diagonal leads to a regular tetrahedra decomposition.
% This algorithm originally comes from Bey~\cite{}.

% Bey's algorithm (red refinement of tetrahedron):
%p.29 https://www5.in.tum.de/pub/Joshi2016_Thesis.pdf
%p.108 http://www.bcamath.org/documentos_public/archivos/publicaciones/sergey_book.pdf
%https://www.math.uci.edu/~chenlong/iFEM/doc/html/uniformrefine3doc.html#1
%J. Bey. Simplicial grid refinement: on Freudenthal's algorithm and the optimal number of congruence classes. Numer. Math. 85(1):1--29, 2000. p11 Algorithm: RedRefinement3D.
%p.4 http://www.vis.uni-stuttgart.de/uploads/tx_vispublications/vis97-grosso.pdf


\subsection{Coupled 1d-3d model}
Mixed form:
  \begin{eqnarray*}
\vc K_d^{-1}\vc u_d + \nabla p_d &=& 0 \qquad \textrm{in } \Omega_d,\; d=1,3  \\
\nabla \cdot \vc u_3 &=& f_3 \qquad \textrm{in } \Omega_3\\
\nabla \cdot \vc u_1 &=& f_1 + {\color{blue}\sigma_w(\avg{p_3}_w-p_1)}\qquad \textrm{in } \Omega_1\\
\color{blue}\avg{\vc u_3 \cdot \vc n}_w &=& \color{blue}\sigma_w (\avg{p_3}_w - p_{1}) \qquad \textrm{on } \Gamma_w\\
p_d &=& g_{dD} \qquad \textrm{on } \Gamma_{dD},\; d=1,3 \\
\vc u_d \cdot \vc n &=& g_{dN} \qquad \textrm{on } \Gamma_{dN},\; d=1,3
  \end{eqnarray*}

  
% \subsection{SGFEM enrichment (single enrichment)}
% We use SGFEM like approach to enrich velocity.
% The enriched velocity has the form:
% \[\sum \limits_{w\in\mathcal{W}} b_w \vc L_w, \]
% where every well $w$ is enriched exactly by one DoF $b_w$.
% % \[
% %   \vc L_w(\vc x) = \textcolor{red}{\vc s_w(\vc x)} - \sum \limits_{j=1}^3 \textcolor{ForestGreen}{z_j} \vc\psi_j(\vc x),
% %   \quad \textcolor{ForestGreen}{z_j=\int_{E_j} \vc s_w(\vc x)\cdot \vc n_j},
% %   \quad \textcolor{red}{\vc s_w(\vc x) = -\frac{1}{2\pi} \frac{\vc r_w}{r_w^2}}
% % \]
% 
% % Accurate integration on sides is needed to compute for coefficients $\color{ForestGreen}z_j$ of the $RT_0$ interpolation of $s_w$.
% 
% The SGFEM enriched shape function on an element $T$ has the form
% \[
%   \vc L_w(\vc x) = \textcolor{red}{\vc s_w(\vc x)} - \sum \limits_{j=1}^{n_E} \textcolor{ForestGreen}{z_j} \vc\psi_j(\vc x),
%   \quad \textcolor{ForestGreen}{z_j=\int_{E_j} \vc s_w(\vc x)\cdot \vc n_j},
%   \quad \textcolor{red}{\vc s_w(\vc x) = -\frac{1}{S_e} \frac{\vc r_w}{r_w^2}},
% \]
% where $n_E$ is the number of sides in 2D, or faces in 3D, $z_j$ is the flux of the global enrichment function $\vc s_w$ over side or face $E_j$ of $T$
% and $S_e$ is the so called effective surface
% %$S_e$ is a portion of the surface of the singularity that communicates with the element $T$
% \[
% S_e = \begin{cases}2\pi\rho_w, \qquad \textrm{in 2d (circle)}, \\ 2\pi\rho_w v \qquad \textrm{in 3d (cylinder of length }v).\end{cases}
% \]
% 
% The flux $z_j$ is computed using adaptive quadrature on sides and faces. The quadrature rules are analogical to the rules
% for adaptive quadrature in elements. These values are computed only once and saved in a vector for further usage (assembly, error computation, output).
% 
% 
% Such local velocity enrichment function has the following important properties:
%   \begin{enumerate}[label=\alph*)]
% %     \setlength{\itemsep}{5pt}
%     \item
%       $\displaystyle \int_T \div\, \vc L_w = \begin{cases}
%         0 & \forall T, T \cap \Gamma_w = \emptyset \\
%         -\sum \limits_{j=1}^3 z_j, & \forall T, T \cap \Gamma_w \neq \emptyset
%     \end{cases}$
%     \item $\displaystyle \int_{E_i} \vc L_w \cdot \vc n_i = 0$
%     \item $\displaystyle \int_{\Gamma_w} \vc L_w \cdot \vc n_w = 1$
%     \item $\displaystyle \int_{\Gamma_w} \vc \psi \cdot \vc n_w = 0, T \cap \Gamma_w = \Gamma_w$\\
%         Not so important. (integral of flux of RT functions over the well edge is zero,
%         if the well edge is included in a single element)
%   \end{enumerate}

\subsubsection{Computation of the distance function $\vc r$ in 3d}
% https://en.wikipedia.org/wiki/Distance_from_a_point_to_a_line
The computation of the global enrichment function in 3d is little bit more involved than in 2d case
due to the evaluation of the distance function from the line.
%
\begin{figure}[!htb]
  \centering
  \def\svgwidth{0.5\textwidth}
  \input{\figpath distance_function_3d.pdf_tex}
  \caption{Distance function $\vc r$ in 3d.}
  \label{fig:distance_function_3d}
\end{figure}

Let us have the direction vector $\vc u = \vc b - \vc a$ of an 1d element (a singularity)
and an arbitrary point $\vc x$.
We need to compute the shortest distance $r$ between $\vc x$ and $\vc u$, see \fig{fig:distance_function_3d}.
The angle $\alpha$ between $(\vc x - \vc a)$ and $\vc u$ is 
\[
\cos(\alpha) = \frac{(\vc x - \vc a)\cdot\vc u}{\abs{\vc x - \vc a}\abs{\vc u}} = \frac{\abs{\vc u_p}}{\abs{\vc x - \vc a}}.
\]
From there we use $\abs{\vc u_p}$ to obtain the projection of $(\vc x-\vc a)$ onto $\vc u$
\[
\vc u_p = \abs{\vc u_p}\frac{\vc u}{\abs{\vc u}} = \frac{(\vc x - \vc a)\cdot\vc u}{\abs{\vc u}^2} \vc u.
\]
Then the distance vector is
\[
  \vc r(\vc x) = (\vc x - \vc a) - \vc u_p = (\vc x - \vc a) - \frac{(\vc x - \vc a)\cdot\vc u}{\abs{\vc u}^2} \vc u.
\]
