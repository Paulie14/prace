\section{Model of Well-Aquifer System} 
\label{sec:model_aquifer}
In this section we narrow the problem to solving pressure only and study different enrichment methods and singular enrichments.
Several important numerical aspects are inspected, mainly an adaptive quadrature and
a~choice of an enrichment radius with respect to the convergence of the methods.
% Some problems with convergence towards the most refined meshes are addressed in the article,
% however these have been resolved since then.
The core of this section is established in our publication \cite{exner_2016}.

At first the problem for the primary unknown is defined and its weak form is derived. Then
XFEM discretizations for several enrichment methods are described for the singular problems.
Later several numerical experiments are computed and the results are investigated in detail.


\subsection{Coupled 1d-2d model (Primary weak form)}

We rearrange Problem \ref{thm:problem_2d} and we substitute for $\vc u_d$ from the Darcy's law and solve the problem
with pressure $p_d$ as the primary unknown quantity. Thus we obtain the following

\thmproblem{ \label{thm:problem_2d_prim}
Find $[p_1,\,p_2]$ satisfying
\begin{align}
% \begin{alignat}{4}
\div \left( -\delta_2 \vc K_2 \grad p_2 \right) &= \delta_2 f_2 && \textrm{in } \Omega_2,\;  \label{eqn:prim_problem_2d_2d} \\
\div \left( -\delta_1 \vc K_1 \grad p_1 \right) &= \delta_1 f_1 + {\color{blue}\sum_{m\in\mathcal{M}}\abs{\Gamma^m_w}\Sigma^m_w\delta(\vc x - \vc x^m_w)} && \textrm{in } \Omega^w_1,\;\forall w\in\mathcal{W} \label{eqn:prim_problem_2d_1d_source}\\
\color{blue}\avg{-\delta_2 \vc K_2 \grad p_2 \cdot \vc n}^m_w &= \color{blue}\Sigma^m_w && \forall w\in\mathcal{W},\; \forall m\in\mathcal{M} \label{eqn:prim_problem_2d_flux}\\
p_d &= g_{dD} && \textrm{on } \Gamma_{dD},\; d=1,2 \label{eqn:prim_problem_2d_dirichlet}\\
\delta_d \vc K_d \grad p_d \cdot \vc n &= g_{dN} && \textrm{on } \Gamma_{dN},\; d=1,2 \label{eqn:prim_problem_2d_neumann}
%   \end{alignat}
\end{align}
where
\[ 
{\color{blue}
    \Sigma^m_w = \delta_2(\vc x^m_w)\sigma^m_w\big(\avg{p_2}^m_w-p_1(\vc x^m_w)\big).
} 
\label{eqn:prim_1d_2d_sigma_source}
\]
}

We add the following assumptions and notation. We consider the hydraulic conductivity tensor $\vc K_d$
to be an invertible positive definite $d\times d$ matrix, for which we denote
\begin{equation}
    \underline{k_d} = \inf\limits_{\bx\in\Omega}\lambda_{\min}(\vc K_d), \quad
    \overbar{k_d}   = \sup\limits_{\bx\in\Omega}\lambda_{\max}(\vc K_d), \qquad
     0 < \underline{k_d} \leq \overbar{k_d}.
\end{equation}
We denote the minimal and maximal cross-section $\delta_d$ of the domains $\Omega_d$
\begin{eqnarray}
    \underline{\delta_2} = \inf\limits_{\bx\in\Omega_2} \delta_2(\vc x), \quad
    \overbar{\delta_2}   = \sup\limits_{\bx\in\Omega_2} \delta_2(\vc x), \qquad
     0 < \underline{\delta_2} \leq \overbar{\delta_2},\\
     \underline{\delta_1} = \min\limits_{w\in\mathcal{W}} (\pi\rho_w^2), \quad
    \overbar{\delta_1}    = \max\limits_{w\in\mathcal{W}} (\pi\rho_w^2), \qquad
     0 < \underline{\delta_1} \leq \overbar{\delta_1}.
\end{eqnarray}
We suppose the boundary $\Gamma_{dD} \neq \emptyset$ for simplicity, so that we can later apply 
the Friedrich's inequality to show the coercivity of the assembled bilinear form.
Otherwise for $\Gamma_{2D} = \emptyset$, the proof would be more complicated and it would require following
the proof of the Friedrich's inequality itself.


We define the trial space $V$ and the test space $V_0$:
\begin{eqnarray} \label{eqn:spaces}
  V &=& H^1(\Omega_1)\times H^1(\Omega_2), \\
  V_0 &=& H^1_0(\Omega_1)\times H^1_0(\Omega_2),
\end{eqnarray}
where $H^1(\Omega_d)$, $d=1,2$, is the standard Sobolev space and 
\[ H^1_0(\Omega_d)=\{\varphi\in H^1(\Omega_d); \varphi|_{\Gamma_{dD}}=0\} \]
takes into account the Dirichlet boundary condition.
We now introduce the weak solution $p=[p_1,p_2]\in V$ and the test function $q=[q_1,q_2]\in V_0$.
The spaces $V,\,V_0$ are equipped with the norm
\begin{equation}
    \norm{q}_V = \big( \norm{q_2}^2_{H^1(\Omega_2)} + \norm{q_1}^2_{H^1(\Omega_1)} \big)^{1/2}.
\end{equation}
% \begin{eqnarray} \label{eqn:solution}
%    u &=& (h^1,\ldots, h^M, H^1_1,\ldots,H^{M+1}_W)\in V, \\
%    v &=& (\varphi^1,\ldots, \varphi^M, \Phi^1_1,\ldots,\Phi^M_W)\in V_0.
% \end{eqnarray}
%We understand $V_0$ as a~subspace of $V$.

Below the weak form of Problem \ref{thm:problem_2d_prim} is derived.
Assuming the wells are very small in diameter, $\rho_w << |\Omega^m_2|$, and the flux over the well edge $\Gamma^m_w$ is
changing minimally along the $\Gamma^m_w$, we put 
\begin{equation} \label{eqn:well_edge_fluctuation_neglect}
    \int_{\Gamma^m_w} \fluct{p_2}^m_w\fluct{q_2}^m_w \dd s \simeq 0,
\end{equation}
thus we simplify the well edge integral
\begin{equation} \label{eqn:prim_avg_assumption}
    \int_{\Gamma^m_w} p_2q_2 \dd s %= \int_{\Gamma^m_w} \big(\avg{p}\avg{q} + \avg{p}\fluct{q} + \fluct{p}\avg{q} + \fluct{p}\fluct{q} \big)\dd s
    =  \int_{\Gamma^m_w} \avg{p_2}^m_w\avg{q_2}^m_w \dd s + \int_{\Gamma^m_w} \fluct{p_2}^m_w\fluct{q_2}^m_w \dd s \simeq \abs{\Gamma^m_w} \avg{p_2}^m_w\avg{q_2}^m_w \dd s
\end{equation}
Effects of this assumption on such problems are studied in details in \cite{koppl_vidotto_2018}.
%
Next we apply the standard Galerkin method. We multiply the equations \eqref{eqn:prim_problem_2d_2d} and \eqref{eqn:prim_problem_2d_1d_source}
by test functions $q_d$, integrate by parts over $\Omega_d$ using \eqref{eqn:prim_problem_2d_flux}-\eqref{eqn:prim_problem_2d_neumann} and the assumption \eqref{eqn:prim_avg_assumption}, 
then we sum up the two equations together to get
\begin{multline} \label{eqn:prim_weak_form}
  a(p,q) =
  \int_{\Omega_2} \delta_2 \vc K_2 \grad p_2 \cdot \grad q_2 \dd\bx
  + \int_{\Omega_1} \delta_1 \vc K_1 \grad p_1 \cdot \grad q_1 \dd\bx \\
  + \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \abs{\Gamma^m_w} \delta_2 \sigma^m_w (\avg{p_2}^m_w - p_1(\vc x^m_w)) (\avg{q_2}^m_w - q_1(\vc x^m_w)) \\
  = \int_{\Omega_2} \delta_2 f_2 q_2 \dd\bx + \int_{\Omega_1} \delta_1 f_1 q_1 \dd\bx
  + \int_{\Gamma_{2N}} g_{2N}q_2 \dd s + \int_{\Gamma_{1N}} g_{1N}q_1 \dd s \\
  = l(q).
\end{multline}

Considering the Dirichlet boundary condition, we split the solution into two parts $p=p_0 + p_D$, while
$p_0\in V_0$ and $p_D\in V$ is a~function chosen such that is satisfies \eqref{eqn:prim_problem_2d_dirichlet}.
Then we define the weak problem
\thmproblem{ \label{thm:problem_2d_prim_weak}
Find $p\in V$ such that
\begin{align}
a(p_0, q) &= l(q) - a(p_D, q) && \forall q\in V_0.
\end{align}
for given $f_2\in L_2(\Omega_2)$, $f_1\in L_2(\Omega_1)$ and $g_{2N}\in L_2(\Gamma_{2N})$, $g_{1N}\in L_2(\Gamma_{1N})$.
\vspace{10pt}
}

The bilinear form $a$ is continuous on $V_0$. To bound the average terms in the form $a$,
we define auxiliary smooth function $\psi\in C^{\infty}(\overbar\Omega)$ such that
\begin{equation*}
  \grad\psi\cdot\vc n =
  \begin{cases}
    1 & \textrm{ on } \Gamma_{int}\\
    0 & \textrm{ on } \Gamma_{ext}.
  \end{cases} \nonumber
\end{equation*}
Then we have the upper bound
\begin{eqnarray*}
  \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \avg{q}^m_w
    &=& \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \int_{\Gamma^m_w} q (\grad\psi\cdot\vc n) \dd s
    = \int_{\partial\Omega_2} q (\grad\psi\cdot\vc n) \dd s
    = \int_{\Omega} \big(q \Lapl\psi + \grad q \cdot\grad\psi \big) \dd\bx \\
    &\leq& \norm{q}_{L_2(\Omega)}\norm{\Delta\psi}_{L_2(\Omega)} + \norm{\grad q}_{L_2(\Omega)} \norm{\grad\psi}_{L_2(\Omega)} \\
    &\leq& C_{avg}(\prtl\Omega_2, \Omega_2) \Big(\norm{q}_{L_2(\Omega)} + \norm{\grad q}_{L_2(\Omega)}\Big)
\end{eqnarray*}
% \begin{align*}
%   \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \avg{q}^m_w
%     = \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \int_{\Gamma^m_w} q (\grad\psi\cdot\vc n) \dd s \\
%     = \int_{\partial\Omega_2} q (\grad\psi\cdot\vc n) \dd s &
%     = \int_{\Omega} \big(q \Lapl\psi + \grad q \grad\psi \big) \dd\bx \\
%     \leq \norm{q}_{L_2(\Omega)}&\norm{\Delta\psi}_{L_2(\Omega)} + \norm{\grad q}_{L_2(\Omega)} \norm{\grad\psi}_{L_2(\Omega)} \\
%     \leq &C_w\big(\prtl\Omega_2, \Omega_2) (\norm{q}_{L_2(\Omega)} + \norm{\grad q}_{L_2(\Omega)}\big)
% \end{align*}
Further since $q_1\in H^1_0(\Omega_1)$, $q_1$ is continuous and bounded on $\Omega_1$, and therefore $\abs{q_1(\vc x^m_w)}\leq \norm{q}_{H^1(\Omega_1)}$.
Then we obtain the final bound
\begin{align} \label{eqn:prim_form_a_bound}
    \abs{a(p,q)} &\leq \overbar{\delta_2}\overbar{k_2}\, \norm{\grad p_2}_{L_2(\Omega_2)} \norm{\grad q_2}_{L_2(\Omega_2)}
        + \overbar{\delta_1}\overbar{k_1}\, \norm{\grad p_1}_{L_2(\Omega_1)} \norm{\grad q_1}_{L_2(\Omega_1)} \\
        &\quad + \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \overbar{\delta_2} \abs{\Gamma^m_w} \sigma^m_w
            \abs{\avg{p_2}^m_w - p_1(\vc x^m_w)}\abs{\avg{q_2}^m_w - q_1(\vc x^m_w)}\\
    &\leq C \Big( \norm{p_2}_{H^1(\Omega_2)} + \norm{p_1}_{H^1(\Omega_1)} \Big) \Big( \norm{q_2}_{H^1(\Omega_2)} + \norm{q_1}_{H^1(\Omega_1)} \Big) \\
    &\leq \alpha_2 \norm{p}_V \norm{q}_V \quad \forall p,q\in V_0,
\end{align}
% \begin{multline} \label{eqn:prim_form_a_bound}
%     \abs{a(p,q)} \leq \overbar{\delta_2}\overbar{k_2}\, \norm{\grad p_2}_{L_2(\Omega_2)} \norm{\grad q_2}_{L_2(\Omega_2)}
%         + \overbar{\delta_1}\overbar{k_1}\, \norm{\grad p_1}_{L_2(\Omega_1)} \norm{\grad q_1}_{L_2(\Omega_1)} \\
%         + \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \overbar{\delta_2} \abs{\Gamma^m_w} \sigma^m_w
%             \abs{\avg{p_2}^m_w - p_1(\vc x^m_w)}\abs{\avg{q_2}^m_w - q_1(\vc x^m_w)}\\
%     \leq C \Big( \norm{p_2}_{H^1(\Omega_2)} + \norm{p_1}_{H^1(\Omega_1)} \Big) \Big( \norm{q_2}_{H^1(\Omega_2)} + \norm{q_1}_{H^1(\Omega_1)} \Big) \\
%     \leq \alpha_2 \norm{p}_V \norm{q}_V \quad \forall p,q\in V_0,
% \end{multline}
with a~constant $\alpha_2(\overbar{\delta_2},\overbar{k_2},\overbar{\delta_1},\overbar{k_1},\sigma^m_w,\abs{\Gamma^m_w},C_{avg})$.

% https://www.wias-berlin.de/people/john/LEHRE/NUM_KONV_PROB_16/num_pde_fem.pdf, example 3.55, p. 15
The bilinear form $a$ is coercive in $V_0$
\begin{align} \label{eqn:prim_form_a_coercivity_V0}
    a(q,q) &\geq
          \underline{\delta_2}\,\underline{k_2} \norm{\grad q_2}^2_{L_2(\Omega_2)}
        + \underline{\delta_1}\,\underline{k_1} \norm{\grad q_1}^2_{L_2(\Omega_1)}\\
        & \qquad + \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}}\abs{\Gamma^m_w} \underline{\delta_2} \sigma^m_w (\avg{q_2}^m_w - q_1(\vc x^m_w))^2 \\
        &\geq
          \underline{\delta_2}\,\underline{k_2} C_{F2} \norm{q_2}^2_{H^1(\Omega_2)}
        + \underline{\delta_1}\,\underline{k_1} C_{F1} \norm{q_1}^2_{H^1(\Omega_1)}.\\
        &\geq
           \alpha_1\norm{q}^2_V \quad \forall q\in V_0.
\end{align}
with a~constant $\alpha_1 = \min\{\underline{\delta_2}\,\underline{k_2}\, C_{F2}, \underline{\delta_1}\,\underline{k_1}\, C_{F1}\}$.
The first two terms of $a(q,q)$ are coercive in $V_0$
due to the Dirichlet boundary condition on the $\Gamma_{dD}$ part of the boundary and Friedrich's inequality with constants $C_{Fd}$,
the last term of $a$ is evidently non-negative.

The existence and uniqueness of the solution can be shown via the Lax-Milgram theorem due to the ellipticity
of the bilinear form $a$ and the boundedness of the problem:
\theorem{ \label{thm:prim_lax_milgram_theorem}
Let $a: V\times V \rightarrow \R$ be a~continuous coercive bilinear form on $V_0$, i.e.
\begin{align}
    \abs{a(p,q)} &\leq \alpha_2 \norm{p}_V \norm{q}_V && \forall p,q \in V_0,\\
    a(q,q) &\geq \alpha_1 \norm{q}^2_V && \forall q\in V_0,
\end{align}
with the constants $\alpha_2$ from \eqref{eqn:prim_form_a_bound} and $\alpha_1$ from \eqref{eqn:prim_form_a_coercivity_V0}.\\
Then there exists a~unique solution $p\in V$ to Problem \eqref{thm:problem_2d_prim_weak} for any
$f_2\in L_2(\Omega_2)$, $f_1\in L_2(\Omega_1)$ and $g_{2N}\in L_2(\Gamma_{2N})$, $g_{1N}\in L_2(\Gamma_{1N})$
and fixed $p_D$, such that
\begin{equation}
    \norm{p}_V \leq \frac{1}{\alpha_1} \norm{l}_{V'}.\\
\end{equation}
}



% \subsection{Model equations}
% We consider a~steady groundwater flow in a~system of aquifers (2d models of horizontal geological layers) separated by aquitards
% (based on Gracie and Craig \cite{gracie_modelling_2010,craig_using_2011}).
% In contrast to Gracie and Craig, we suppose the aquitards to be impermeable, 
% so the aquifers can communicate between each other only through the wells.
% On the other hand, we add an artificial volume source term on aquifers.
% This allows us to better study the impact of the prescribed source on the solution
% which is better suited to the numerical experiments we are going to present. 
% 
% The model is defined as a~complex multi-aquifer system to follow our implementation and to see the differences
% we made in comparison to Gracie and Craig. However before solving the complex model,
% we will constrain ourselves to a~single aquifer in several sections below.
% 
% \notePE{Is it necessary to define aquifers domain $\Omega^m_2$ somewhere?
% Probably at the numerical test with multiple aquifers, but that can be written there..}
% 
% 
% 
% Let $\Theta^m\subset \Real^2$ be the domain of the $m$-th aquifer, $m=1,\ldots M$.
% The well $w\in\mathcal{W}=\{1,\ldots,W\}$ is represented by an infinite vertical cylinder $B_w$
% with center $\bx_w$ and radius $\rho_w$.  We further denote 
% \[
%  B^m_w = B_w \cap \Theta^m, \quad \text{and} \quad
%  B^m=\bigcup_{w\in \mathcal{W}}B^m_w,
% \]
% for any aquifer $m$ and a~well $w$.
% The actual computational domain of the aquifer $m$ is $\Omega^m = \Theta^m\setminus B^m$. The boundary $\partial\Omega^m$ of 
% the domain consists of the exterior part $\partial\Theta^m=\Gamma^m_D$ and the interior part $\partial B^m$.
% 
% The aquifers are connected by the wells which act as sources or sinks in the domain of each aquifer.
% The pressure in the aquifers is further governed by a~Dirichlet or Neumann boundary condition on the exterior boundary of every aquifer.
% 
% Combining the Darcy law and the continuity equation for incompressible fluid, we get
% a Poisson equation for the pressure head in the $m$-th aquifer:
% \begin{equation} \label{eqn:poisson}
% \nabla\cdot(-\mathbf{T}^m\nabla h^m) = f^m \qquad \textrm{on } \Omega^m\subset\Real^2,\; \forall m=1,\dots,M, \\
% \end{equation}
% which has to be supplied with boundary conditions
% \begin{align}
% h^m|_{\Gamma^m_D} &= h^m_D, \\
% \label{eq:interior_bc}
% \left(-\mathbf{T}^m\nabla h^m\cdot\vc{n}\right)|_{\partial B^m_w} &= \sigma^m_w(\langle h^m \rangle - H^m_w) \qquad \forall w\in\mathcal{W},
% \end{align}
% %
% % \noteJB{Na vrtu by mel byt predepsany konstantni tok dany prumerem tlaku, tj.pomoci $Q_w^m$. 
% % Pak se nam objevi prumery i v nekterych dalsich rovnicich. Jde, jde o to s jakou implementaci to bylo pocitane. To bych tam nechal bez ohledu na to ze
% % spravne je nektera z moznych formulaci s prumerama.
% % }
% where $\mathbf{T}^m\, [\textrm{m}^2\textrm{s}^{-1}]$ denotes the transmissivity tensor,
% %(we will further consider only scalar $T^m$ for simplicity), 
% $h^m\, [\textrm{m}]$ is the pressure head, $f^m\, [\textrm{m}\textrm{s}^{-1}]$ stands for the source density,
% $\vc{n}$ is the unit outer normal vector of the interior boundary (i.e. pointing to the centers of wells),
% $\sigma^m_w\, [\textrm{m}\textrm{s}^{-1}]$ denotes the permeability coefficient between $w$-th well and 
% $m$-th aquifer, and finally $H_w^m$ is the pressure head in the well $w$ at the level of $m$-th aquifer.
% %
% \begin{figure}[!htb]
%   %\vspace{-15pt}
%   \begin{center}         
%     \def\svgwidth{0.5\textwidth}
%     \input{\figpath well_communcation.pdf_tex}
%   \end{center}
%   \caption{Flow balance in the well.}
%   \label{fig:well_flows}
% \end{figure}
% %
% The average value of pressure head along the well edge $\langle{h^m}\rangle$ is defined as
% \[\langle{h^m}\rangle = \fint_{\partial B_w} h^m  \dd\bx.\]
% The boundary condition with the average pressure head $\langle{h^m}\rangle$ forces the gradient
% of the pressure head to constant.
% 
% The total flow from the well $w$ to aquitard $m$,
% \[
%     Q^m_w =-\int_{\prtl B^m_w} \sigma^m_w(\langle h^m \rangle - H^m_w)  \dd\bx
% \]
% satisfies a~simple balance equation on the well
% \begin{align}
%     \label{eq:well_flow}
%     Q_w^m = Q^m_{w,in} - Q^m_{w,out} = c^{m+1}_w\left( H^{m+1}_w-H^m_w \right) - c_w^m\left( H^m_w-H_w^{m-1}\right),&\\
%     \notag
%     \forall\,m=1,\dots,M\text{ and }\forall\,w\in\mathcal{W},&
% \end{align}
% where $Q^m_{w,in}$ is the flow from the upper aquifer $m+1$, $Q^m_{w,out}$ is the flow to the lower aquifer $m-1$, and 
% $c^m_w\, [\textrm{m}^2\textrm{s}^{-1}]$ is the permeability of the well $w$ in the segment below the aquifer $m$.
% 
% %
% In \eqref{eq:well_flow}, we assume Darcy flow in the well for the simplicity. The bottom of the well $w$ is impermeable,
% we set $c^1_w=0$, $H^0_w=H^1_w$ there, and we prescribe given pressure $H^{M+1}_w$ at the top.
% 
% %refer to the article

% \subsection{Weak formulation}
% We define the trial space $V$ and the test space $V_0$:
% \begin{eqnarray} \label{eqn:spaces}
%   V &=& \left(H^1(\Omega^m)\right)^M\times\Real^{W(M+1)}, \\
%   V_0 &=& \left(H^1_0(\Omega^m)\right)^M\times\Real^{WM},
% \end{eqnarray}
% where $H^1(\Omega^m)$ is the standard Sobolev space and 
% \[ H^1_0(\Omega^m)=\{\varphi\in H^1(\Omega^m); \varphi|_{\Gamma^m_D}=0\}. \]
% We can now introduce the weak solution $u$ and the test function $v$
% \begin{eqnarray} \label{eqn:solution}
%    u &=& (h^1,\ldots, h^M, H^1_1,\ldots,H^{M+1}_W)\in V, \\
%    v &=& (\varphi^1,\ldots, \varphi^M, \Phi^1_1,\ldots,\Phi^M_W)\in V_0.
% \end{eqnarray}
% We understand $V_0$ as a~subspace of $V$ setting $\Phi^{M+1}_W=0$.
% 
% To obtain the weak form, we apply the standard Galerkin method. We multiply the equation \eqref{eqn:poisson} 
% by a~test function $\varphi^m$ and integrate by parts over $\Omega^m$, for all $m=1,\ldots,M$, to get
% \begin{equation} \label{eqn:weak_form1}
%   \int_{\Omega^m} T^m \nabla h^m \cdot \nabla \varphi^m \dd\bx
%   + \sum_{w\in \mathcal{W}} \int_{\partial B^m_w} \sigma^m_w (\langle h^m \rangle - H_w^m) \varphi^m \dd\bx
%   = \int_{\Omega^m} f^m\varphi^m \dd\bx.
%   % - \int \limits_{\Omega^m} T^m \nabla h^m_D \nabla v^m \dd\mathbf{x},
% \end{equation}
% %
% We then multiply \eqref{eq:well_flow} by $\Phi^m_w$, add it to \eqref{eqn:weak_form1} 
% and sum up over $m$ which results in
% \begin{multline} \label{eqn:weak_form}
%   \sum_{m=1}^M \; \int_{\Omega^m} T^m \nabla h^m \cdot \nabla \varphi^m \dd\bx
%         + \sum_{m=1}^M \sum_{w\in \mathcal{W}} \; 
%            \int_{\partial B^m_w} \sigma^m_w\left(\langle h^m \rangle-H^m_w\right)\left(\langle \varphi^m \rangle -\Phi^m_w\right) \dd\bx \\
%         + \sum_{m=1}^{M+1} \sum_{w\in\mathcal{W}}
%           c_w^{m}\left( H^{m}_w-H_w^{m-1}\right)\left(\Phi^{m}_w - \Phi^{m-1}_w\right)           
%   = \sum_{m=1}^M \; \int_{\Omega^m} f^m\varphi^m \dd\bx.   
% \end{multline}
% % \noteJB{Consider sum over aquifers to get square term from communication on wells.
% % Boundary conditions on wells?}
% We say that $u\in V$ is a~weak solution if it satisfies \eqref{eqn:weak_form} for all $v\in V_0$. 
% Putting $h^m=\varphi^m$ and $H^m_w=\Phi^m_w$, we can clearly see the elliptic character of all terms on the 
% left hand side of the weak form \eqref{eqn:weak_form} in the whole test space $V_0$. The existence and uniqueness of the solution can be shown 
% via the Lax-Milgram lemma due to ellipticity and boundedness of the problem.

\subsection{Discretization}
\label{sec:prim_discretization}
In this section we choose a~particular XFEM discretization, using the methods described in Section \ref{sec:enrichment_methods},
and apply it to the weak form \eqref{eqn:prim_weak_form}.

We omit the upper index $m$, denoting aquifer, till the end of this section for the sake of the simplicity of notation.
Extension to the multi-aquifer system is straightforward. In fact in case of the pressure model, we suppose the aquifers
to be parallel 2d planes, defined in the $xy$ axes in different levels of $z$-axis. 
The wells are considered perpendicular to the aquifers (i.e. in $z$-axis) and all have a~constant radius.
Therefore we use the same triangulation for every aquifer in our implementation and therefore the discrete spaces are also identical.
This simplification is of solely technical nature and does not mean any loss of generality of the used discretization schemes.
The XFEM is used to couple the 1d and 2d domains and to better approximate the singular solution in the aquifer,
so only the finite element space of the 2d domain is extended.

Now we look for the finite dimensional space $V_h$ of the continuous space $V$ introduced in the weak form \eqref{eqn:prim_weak_form},
so that $V_h\subset V$. We build the discrete space on domains of each dimension
\begin{equation}
    V_h = V_{1h} \times V_{2h}, \qquad V_{2h} = V_{2h}^{reg} + V_{2h}^{enr}
\end{equation}
where $V_{2h}$ consists of the regular part and the enriched part which we define later below.

We denote a~patch $\omega_{d\alpha}$ which is the union of elements sharing a node $\bx_\alpha\in\mathcal{T}_d$
\[
    \omega_{d\alpha} = \{ T_d^i: \bx_\alpha \in T_d^i, i\in\mathcal{I}_{dE}\}, \quad \alpha\in\mathcal{I}_{dN}.
\]
Next, let $N_{d \alpha}(\vc x)$ be the standard linear finite element shape functions associated with
nodes $\bx_\alpha$, having support on $\overbar\omega_{d,\alpha}$ and satisfying the Kronecker delta property
$N_{d \alpha}(\bx_\beta)=\delta_{\alpha\beta},\, \alpha,\beta\in\mathcal{I}_{dN}$.
% $N_{d \alpha}\in \mathcal{P}^1(T_d^i),\, i\in\mathcal{I}_{dE}$
Then we can define
\begin{equation}
    V_{dh}^{reg} = \spn\{N_\alpha\}, \quad \alpha\in\mathcal{I}_{dN},\, d=1,2,
\end{equation}
understanding that $V_{1h} = V_{1h}^{reg}$ in our problem.
Similarly we define the enriched space
\begin{equation}
    V_{2h}^{enr} = \spn\{N_{2\alpha} L_{\alpha w}\}, \quad \alpha\in\mathcal{J}^w_{2N},\, w\in\mathcal{W},
\end{equation}
where $\mathcal{J}^w_{2N}\subset\mathcal{I}_{2N}$ denotes the indices of enriched nodes in $\mathcal{T}_2$ 
by the well $w$, and
the functions $N_{2\alpha}L_{\alpha w}$ are the local enrichment functions as in \eqref{eqn:soa_xfem_standard_form_mult2},
while $N_{2\alpha}$ are playing the role of PU.
Thus we can write the enriched solution in the form
\begin{equation} \label{eqn:prim_xfem_standard_form}
  p_2(\bx) = \sum_{\alpha\in\mathcal{I}_{2N}}a_\alpha N_{2\alpha}(\bx)
    + \sum_{w\in\mathcal{W}} \sum_{\alpha\in\mathcal{J}^w_{2N}} b_{\alpha w} N_{2\alpha}(\bx) L_{\alpha w}(\bx),
\end{equation}
where $a_\alpha$ are the standard degrees of freedom and $b_{\alpha w}$ are the degrees of freedom coming from
the enrichment of the well $w$.

We now look at the choice of the enrichment function $L_{\alpha w}$ in our particular case.
Below we select a~proper global enrichment function and then define $L_{\alpha w}$ according
to one of the XFEM.

% The index set $\mathcal{I}^e_w$ includes all nodes enriched by the well $w$; on the other hand, 
% at one node one can have several enrichment functions originating from different wells.
% The local enrichment functions $\phi_{\alpha w}$ in \eqref{eqn:xfem_standard_form} are defined
% in the following way
% \begin{equation} \label{eqn:xfem_enrich}
%     \phi_{\alpha w} = N_\alpha(\bx)L_{\alpha w}(\bx), \quad \alpha\in\mathcal{I}^e_w, w\in\mathcal{W},
% \end{equation}
% where the enrichment function is simply $L_{\alpha w}(\bx) = s_w(\bx)$.


\subsubsection{Enrichment Function} \label{sec:enrichment_func}
The enrichment function can be obtained from the solution of a~local problem on the neighborhood of the well $w$.
Let $\Omega$ be an annulus with center $\vc x_w$, inner radius $\rho_w$ and arbitrary outer radius $D \gg \rho_w$.
The solution of the Laplace equation $-\Delta p = 0$ on $\Omega$ with any radially symmetric boundary conditions has a~form
%
\begin{equation} \label{eqn:solution_form}
  p = a \log(r_w)+b, %\quad \textrm{where }
\end{equation}
where $r_w$ is a~distance function
\begin{equation} \label{eqn:distance}
r_w(\bx) = \|\bx - \bx_w\|= \sqrt{(x-x_w)^2+(y-y_w)^2}.
\end{equation}
%
Thus the pressure head would go to infinity while closing to the center of the well.
Keeping in mind the radius of the well $\rho_w$ and the local solution \eqref{eqn:solution_form}, 
we introduce a~(global) enrichment function
%
\begin{equation}
\label{eqn:enrich_func}
s_w(\bx) = 
  \begin{cases}
  \log(r_w(\bx)) & r_w > \rho_w,\\
  \log(\rho_w) & r_w \le \rho_w,\\
  \end{cases}
\end{equation}
see \fig{fig:enrich_func}, and its gradient
\begin{equation} \label{eqn:enrich_grad}
\grad s_w(\bx) = 
  \begin{cases}  
    \frac{1}{r_w^2(\bx)}(\bx - \bx_w) & r_w>R_w, \\
    0 & r_w \leq R_w.
  \end{cases}
\end{equation}
In case of more aquifers in the model, it is natural to use the same $s_w$ on each aquifer 
since it depends only on $r_w(x,y)$ and the wells have constant center $\bx_w=[x_w, y_w]$ and radius $\rho_w$ along the $z$-axis.

\begin{figure}[!htb]
  %\vspace{-15pt}
  \begin{center}         
    \def\svgwidth{0.5\textwidth}
    \input{\figpath enrich_func.pdf_tex}
  \end{center}
  \caption{The enrichment function.}
  \label{fig:enrich_func}
\end{figure}


In contrast to global enrichment methods, the XFEM and the SGFEM apply the enrichment functions only locally. 
Since the enrichment function is radial, it is natural to consider the enriched domain $Z_w = B_{R_w}(\vc x_w)$
of the well $w$ given by the enrichment radius $R_w$. Thus for each well $w$ all the nodes of $\mathcal{T}_2$
in $Z_w$ are enriched and we denote the enriched element indices by
\begin{equation} \label{eqn:prim_enriched_nodes}
    \mathcal{J}^w_{2N} = \{\alpha\in\mathcal{I}_{2N}:\, \bx_\alpha\in Z_w, \, w\in\mathcal{W}\}.
\end{equation}
We also define the index set of enriched elements, i.e. elements in which at least one node is enriched
\begin{equation} \label{eqn:prim_enriched_elements}
    \mathcal{J}^w_{2E} = \{i\in\mathcal{I}_{2E}:\, \bx_\alpha\in T^i_2,\, \alpha\in\mathcal{J}^w_{2N},\, w\in\mathcal{W} \}.
\end{equation}
on elements $T_2^i$ with enriched nodes $\bx_\alpha\in{T_2^i},\, i\in\mathcal{I}_{2E}$,

We define the following enrichment schemes, according to the section \ref{sec:enrichment_methods},
which we later compare in numerical tests. At first we use the simplest scheme
\begin{equation} \label{eqn:prim_standard_xfem}
    L_{\alpha w} = s_{w}(\bx), \quad \alpha\in\mathcal{J}^w_{2N}, w\in\mathcal{W}.
\end{equation}
which we refer to as \textbf{standard XFEM} later in this section.
%
For the Corrected XFEM, we start with the ramp function $G$, see \eqref{eqn:xfem_ramp},
having the local enrichment function in the form
\begin{equation} \label{eqn:prim_xfem_ramp}
    L_{\alpha w} = G_w(\bx) s_{w}(\bx), \quad \alpha\in\mathcal{J}^{*w}_{2N}, w\in\mathcal{W}.
\end{equation}
We call this scheme \textbf{ramp function XFEM}.
Next the Corrected XFEM can also include the shifting, see \eqref{eqn:xfem_shift},
\begin{equation} \label{eqn:prim_xfem_shift}
    L_{\alpha w} = G_w(\bx) \left[s_w(\bx) - s_w(\bx_\alpha)\right],
    \quad \alpha\in\mathcal{J}^{*w}_{2N}, w\in\mathcal{W},
\end{equation} 
which we refer to as the \textbf{shifted XFEM}.
We remind that in the Corrected XFEM, the index set of the enriched nodes is extended due to the ramp function
such that every node of elements that have non-zero intersection with the area $Z_w$ is enriched:
\begin{equation} \label{eqn:prim_enriched_nodes_corr}
    \mathcal{J}^{*w}_{2N} = \{\alpha\in\mathcal{I}_{2N}: \bx_\alpha\in T^j_2,\, j\in\mathcal{J}^w_{2E},\, w\in\mathcal{W}\},
%     \mathcal{J}^{*w}_{2N} = \{\bx_\alpha: \bx_\alpha\in T^i_2,\, T^i_2\cap Z_w \neq \emptyset, \, i\in\mathcal{I}_{2E},\, \alpha\in\mathcal{I}_{2N} \} \quad \forall w\in\mathcal{W}.
\end{equation}
see \fig{fig:enrichment_zone_radial} above. Finally we have the \textbf{SGFEM} scheme, see \eqref{eqn:sgfem_enrich},
\begin{equation} \label{eqn:prim_sgfem_enrich}
    L_{\alpha w}|_{T_2^j} = \left[s_w(\bx) - \pi_{T_2^j} (s_w)(\bx)\right],
    \quad \alpha\in\mathcal{J}^w_{2N},\, j\in\mathcal{J}^w_{2E},\, w\in\mathcal{W},
\end{equation}
on enriched elements $T_2^j$,
with the interpolation operator
\begin{equation} \label{eqn:prim_sgfem_interpolation}
    \pi_{T_2^j} (s_w)(\bx) = \sum_{\beta\in\mathcal{I}_N(T_2^j)} s_w(\bx_\beta) N_\beta(\bx).
\end{equation}


\subsection{Integration on enriched elements}
\label{sec:integration}
In order to compute the entries of the system matrix, %\eqref{eqn:s_entry} and \eqref{eqn:r_entry} 
we need to integrate
the expressions containing the enrichment functions. These of course can be non-polynomial, like they are 
in our case. The standard quadrature rules are not appropriate any more, for they are constructed to integrate 
precisely only polynomials up to a~given degree. The higher requirements on the integration precision
are the price for using enrichment functions and a~coarse mesh.

There are two aspects which the integration must handle properly:
\begin{itemize}
  \item the steep gradient of enrichment shape functions in the vicinity of the singularity,
  \item the singularity cut-off edge geometry.
\end{itemize}

One of the approaches to deal with these requirements is an adaptive quadrature. The element is further subdivided 
to split the integration area into much smaller pieces (subelements), which better align with the well edge.
On the subelements, standard quadrature rules are applied, possibly of higher order.
This way the integration is more accurate, increasing the number of quadrature points per element, but not bringing
any more degrees of freedom into the linear system. In this section we discuss the adaptivity rules for the element subdivision, 
suggest an improvement and compare our strategy to the original one from which we have started, developed in \cite{gracie_modelling_2010}.

\subsubsection{Instability of adaptive quadrature}
\label{sec:refinement_element}
Gracie and Craig in \cite{gracie_modelling_2010} refine only subelements that cross the boundary of the well, using at most 12 refinements.
This catches nicely the well edge but it works only when the well is placed at the node of an element or near the center of an element. 
When the well is placed near the edge of an element, there can be
a large difference in the size of neighboring subelements, see \fig{fig:adapt_ref_a}. Although
the integrand is computed precisely enough on the element with the well inside, the quadrature points on the
neighboring elements (where the integrand has still large derivatives) are placed very sparsely 
and the integration error is large.

\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
  \subfloat[refinement due to Gracie and Craig]{\label{fig:adapt_ref_a} 
    \includegraphics[width=0.45\textwidth]{\figpath adaptive_refinement_3_old.pdf} }
  \hspace{0pt}
  \subfloat[improved refinement]{\label{fig:adapt_ref_b} 
    \includegraphics[width=0.45\textwidth]{\figpath adaptive_refinement_3_new.pdf} }
  \caption[Adaptive refinement comparison]
  {Comparison of the original and improved refinement techniques.
   Black lines denote enriched elements edges, red lines denote adaptive refinement (subelements edges) and the well
   edge is blue.
  }
  \label{fig:adapt_refinement}
\end{figure}
In order to overcome this instability of the adaptive quadrature, we have made an asymptotic analysis of the integration error presented 
in the next section.

\subsubsection{Estimate of quadrature error}

Let us assume only one well of radius $\rho_w$ situated at the origin. In the case of elliptic equation, the term with the strongest singularity is 
\begin{equation}
    \label{eq:term-of-interest}
    f(r_w)=(\nabla \log r_w )^2 \approx r_w^{-2}
\end{equation}
which is also the worst term to integrate independently of the particular XFEM enrichment variant.
Consider a~square subelement $S$ with a~side $\delta$ and 
let us denote $r_{S}$ its distance from the origin.
We want to estimate the error of the 2d tensor product Gauss quadrature rule of order $n$ ($n$ times $n$ points) on the square $S$. 
Let us denote 
$\Pi^n f$ the projection of the integrand $f$ to the space of polynomials that are integrated exactly.
We were not able to find error estimates for 2d quadratures in the literature and deriving them would be extremely technical.
However, we can make an observation that among the squares of the same $r_{S}$, the quadrature error is the highest for the squares lying on one of the axis.
Assume without loss of generality a~square on the $X$-axis. Since $\abs{y}<\delta \ll \abs{x}$, the monomials of $\Pi^n f$ containing $y$ 
are negligible and we get the quadrature
of order $n$ in the radial ($X$-axis) direction. On the other hand for the square on the diagonal of the axes, the bilinear terms of 
a 2d quadrature effectively enhance its order to $2n$ in the radial (diagonal) direction. Due to the radial nature of the integrand,
we can estimate the quadrature error on the square $S$ by the error on the square $S'$ with the same $r_S$ laying on the $X$-axis, then we can 
neglect $y$~monomials and use the error estimates for the 1d quadrature:
\begin{equation}
  \int_S \abs{f-\Pi^n f} \dd\bx \le \int_{S'}\abs{f-\Pi^n f} \dd\bx \le \delta E^n((r_{S}, r_{S}+\delta)).
\end{equation}
The $E_n$ is the error of 1d Gauss quadrature of the order $n$ ($n$ quadrature points) over the interval $(r_w,r_w+\delta)$
\begin{equation}
  E_n = \frac{\delta^{2n+1} (n!)^4}{(2n+1)((2n)!)^3} f^{(2n)}(\xi_n) 
\end{equation}
for some $\xi_n \in (r_w, r_w+\delta)$, see e.g. \cite{kahaner_numerical_1989}. 
The expression $f^{(2n)}$ denotes a~derivative of order $2n$ of a~function $f$.
Regarding the integrand \eqref{eq:term-of-interest}, we have 
\begin{equation}
  \abs{f^{(2n)}(r_w)} = (2n+1)! r_w^{-(2n+2)}.
\end{equation}
Finally, we get an estimate for the quadrature error on a~single subelement:
\begin{equation}
    \int_S \abs{f-\Pi^n f}  \dd\bx \le  \alpha_n \left( \frac{\delta}{r_{S}} \right)^{2n+2}, 
  \qquad \alpha_n = \left( \frac{(n!)^2}{(2n)!} \right)^2.
\end{equation}
This estimate implies that we have to ensure $\delta < r_S$ in order to get a~decent quadrature error 
and possibly to employ a~higher order quadrature. 


%JB%Derived criterion holds only on squares, where the integrated function is smooth.
%JB%This is not the case for squares intersecting the boundary of the well, $r_{S} \le \rho_w \le r_{max}$, where we integrate 
%JB%discontinuous function $\chi_{S \setminus W} f$. Using substitution, we can map $W$ to unit circle $B$
%JB%\[
%JB%  \int_{S} \chi_{S \setminus W} \frac{1}{r^2} \d \vc r= \int_{S'} \chi_{S' \setminus B} \frac{1}{r'^2} \d \vc {r'},
%JB%\]
%JB%where $S'$ is square with side $H=\delta/\rho_w$ and $\vc {r'} = \vc{r}/\rho_w$. Empirically determined error of the midpoint rule for later 
%JB%integral is
%JB%\[
%JB%    E(H) = c_e H^{p_e}, \quad \text{with } c_e=0.08,\ p_e=2.5.
%JB%\]
%JB%This error has to be smaller then $\epsilon h^2$, thus for $h$ we get formula:
%JB%\begin{equation} \label{eqn:h_criterion}
%JB%   h\le h_b(\epsilon) = \Big(\frac{\epsilon \rho_w^{p_e}}{c_e}\Big)^{\frac{1}{p_e-2}}. 
%JB%\end{equation}
%JB%
%\noteJB{TODO: modify test of integration on unit disk for the function $1/r^2$.}

\subsubsection{A priori adaptive quadrature rules} \label{sec:adaptive_quad_rules}
Let us denote $r_{min}$ the minimum and $r_{max}$ the maximum distance from a~particular subelement $S$ to the singularity center. 
Based on the analysis presented above, we propose following adaptive quadrature rules:
%JB%\begin{enumerate}
%JB% \item If $r_{max} < \rho_w$ the square quadrature is zero.
%JB% \item If $r_{min} < \rho_w < r_{max}$ (square cross the well boundary) we subdivide the square unless $\delta < 2^{-12}h$.
%JB% \item If $r_{min} > \rho_w$. For $\frac{h}{r_{min}} > \frac{1}{2}$ subdivide the square, else select order $n$ so that 
%JB% \begin{equation} \label{eqn:alpha_criterion}
%JB%    \frac{\alpha_n h^{2n}}{r_{min}^{2n+2}} \le \epsilon,
%JB% \end{equation}
%JB% use at least the same order as necessary for FEM.
%JB%\end{enumerate}
%JB%
%\noteJB{TODO:
%We should estimate true error numerically using one more subdivision and compare it to prescribed tolerance, we should be safely 
%below, without increasing the number of evaluation compared to current implementation.
%}



%JB%We suggest additional criterion for subelements refinement which takes into account a subelement diameter 
%JB%and its distance from the well
%JB%\begin{equation}
%JB%  h \leq C_R r_{min},
%JB%\end{equation}
%JB%\notePE{Originally, I compute $r_{min}$ between vertices and the well center, but I believe that the results would be the same.}
%JB%where $h$ is the diameter of the subelement and $r_{min}$ is the minimal distance between a vertex of 
%JB%the subelement and the well center. $C_R$ is a scaling constant, equal 0.5 by default, through which we can 
%JB%control the significance of the criterion. If satisfied, the subelement is not refined anymore.
%JB%

%JB%Eventually, we do 10 levels of improved adaptive refinement with the following rules ($r_{max}$ is the maximal
%JB%distance of a vertex of the subelement and the well center):
\begin{enumerate}
 \item If $r_{max} < \rho_w$, the subelement is not refined and the quadrature is zero.
 \item If $r_{min} < \rho_w < r_{max}$ and $\delta > 2^{-10}h$, the subelement is refined.
 \item If $r_{min} < \rho_w < r_{max}$ and $\delta \le 2^{-10}h$, $3\times3$ Gauss quadrature is used.
 The weights at quadrature points lying inside the well are set to zero.
 \item If $r_{min} > \rho_w$ and $\delta > r_{min} / 2$, the subelement is refined.
 \item If $r_{min} > \rho_w$ and $\delta \le r_{min} / 2$, $3\times3$ Gauss quadrature is used.
\end{enumerate}


These rules ensure $\delta < r_{min}/2$ outside the well, where the integrand is smooth. Subelements intersecting 
the well's boundary are refined using at most $10$ refinement levels, since the integrand is discontinuous there and we cannot employ 
estimates from the previous section. The maximum number of levels is chosen so that we get the similar total number of quadrature points 
as in the quadrature used by Gracie and Craig in \cite{gracie_modelling_2010}. Using the proposed rules, the elements that do not contain the well are refined as well,
see \fig{fig:adapt_ref_b}. 

By implementing this approach, all the variants of the XFEM enrichment methods converge with optimal order.
as the results of the numerical tests will show in section \ref{sec:results}.

\subsubsection{Quadrature in polar coordinates}

The idea for the usage of the quadrature in polar coordinates originates from the radial character of the terms
that are integrated. 
The motivation is to reduce the number of quadrature points (refinement levels) of the previously described quadrature due to
precise representation of the well edge and/or increase of accuracy.

We define a~circular neighborhood of a~well, i.e. a~band of width $\gamma$ (see \fig{fig:well_band}),
\[ \mathcal{P} = \{\vc{x}: \rho_w < \abs{\vc{x} - \vc{x}_w} < \rho_w + \gamma \}.\]
Next we define a~smooth step function (see \fig{fig:smooth_step})
\[\mu(z) = -2 z^3 +3 z^2,\quad z=\frac{r_w-\rho_w}{\gamma}.\]%
%
\begin{figure}[!htb]
  \vspace{-35pt}
  \centering    
  \subfloat[well neighborhood $\mathcal{P}$]{\label{fig:well_band} 
          \def\svgwidth{0.35\textwidth}
          \input{\figpath well_band.pdf_tex}
  }
  \hspace{0pt}
  \subfloat[smooth step function]{\label{fig:smooth_step} 
          \def\svgwidth{0.5\textwidth}
          \input{\figpath smooth_step.pdf_tex}
  }
  \caption[Smooth step function]
  {Smooth step function $\mu$ on the well neighborhood $\mathcal{P}$.
  }
  \label{fig:smooth_step_well_band}
\end{figure}    

We use $\mu$ as a~partition of unity to divide an integral into 2 parts
\begin{eqnarray} 
      \int\limits_S v(\mathbf{x}) \dd \mathbf{x} &=& \int\limits_S \mu(r_w) v(\mathbf{x}) \dd \mathbf{x} + \int\limits_S (1-\mu(r_w)) v(\mathbf{x}) \dd \mathbf{x} \nonumber\\
      &=& \int\limits_S \mu(r_w) v(\mathbf{x}) \dd \mathbf{x} + \int\limits_0^{2\pi} \int\limits_{\rho_w}^{\rho_w+\gamma} (1-\mu(r_w)) v(\mathbf{x}) r_w \dd r \dd \phi.
\end{eqnarray}
We see that the first integral vanishes when closing to the well edge, while the second grows. This corresponds
to the character of the solution which is more radial in the vicinity of the well rather than far away from it.
Therefore we transform the second integral into polar coordinates $\mathbf{x} \longleftrightarrow (r_w,\phi)$. 
The first integral is computed using the previously described quadrature, but with much less refinement
levels, since the well edge is now represented precisely (see \fig{fig:polar_quad_points} with
an example of quadrature points distribution).
%
\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
  \subfloat[$\int\limits_\Omega \mu(r_w) v(\mathbf{x}) \dd \mathbf{x}$]{\label{fig:adapt_ref_polar_a} 
         \includegraphics[width=0.47\textwidth]{\figpath adaptive_refinement_well.pdf}
  }
  \hspace{0pt}
  \subfloat[$\int\limits_0^{2\pi} \int\limits_{\rho_w}^{\rho_w+\gamma} (1-\mu(r_w)) v(\mathbf{x}) r_w \dd r \dd \phi $]{\label{fig:adapt_ref_polar_b} 
          \includegraphics[width=0.47\textwidth]{\figpath polar_band_refinement.pdf}
  }
  \caption[Polar quadrature points]
  {Distribution of quadrature points of the two integral parts.
  }
  \label{fig:polar_quad_points}
\end{figure} 

The adaptive integration in polar coordinates has been implemented and tested.
However, the results of are not satisfying as expected. The quadrature accuracy is very dependent on the choice of
the band width around the well, position of the well relative to nodes of the mesh and also to the size of nearby elements.
When playing long enough with the setting, an optimal convergence rate can be reached, but no general and robust 
setting has been found. The quadrature points generated in the band also demand more efficient mapping onto elements and a~reference element
for the shape functions to be evaluated.
The problem would need a~deeper investigation and we leave it open for now.
The previously described quadrature is stable and accurate enough and that is sufficient for our purposes. 


%JB%\subsection{Adaptive integration experiment}
%JB%We now describe the experiment from which we obtained the coefficients in the criterion 
%JB%\eqref{eqn:h_criterion}. Let us have a single element, a square $4\times4$, out of which a circle of unit radius 
%JB%is cut off -- this represents an element with a well. We now want to investigate integration error
%JB%in the vicinity of the circle on the function $f=r^{-2}$, $r$ being the distance from the center of the circle. 
%JB%
%JB%We compute the integral on the selected level of refinement only on the squares intersecting the circle. Then
%JB%we refine the squares up to the 12-th level, integrate again and compute the difference. Quadratures rules
%JB%$1\times1$, $2\times2$, $3\times3$ and $4\times4$ are used. The results are shown in 
%JB%\fig{fig:adapt_integration_conv} also with convergence trend lines equations. The conclusion can be made
%JB%that it is more efficient to refine one more level with one-point quadrature than to use higher order 
%JB%quadrature on the coarser level. As for the coefficient, these can be read from the graph -- for the one point
%JB%quadrature $c_e=12.65$ and $p_e=1.27$.
%JB%
%JB%\begin{figure}[!htb]
%JB%%   \vspace{0pt}
%JB%  \centering    
%JB%  \includegraphics[width=0.9\textwidth]{results/adapt_integration_conv.pdf}
%JB%%   \subfloat[rozdìlený element s vrtem]{\label{fig:adapt_ref_a} 
%JB%%     \includegraphics[width=70mm]{\figpath adaptive_ref.pdf} }
%JB%%   \hspace{0pt}
%JB%%   \subfloat[detail hranice vrtu]{\label{fig:adapt_ref_b} 
%JB%%     \includegraphics[width=72mm]{\figpath adaptive_ref_detail.pdf} }
%JB%  \caption[Adaptive quadrature convergence.]{Convergence graph of adaptive quadrature on function $r^{-2}$.
%JB%  \\ \notePE{thicker trend lines}}
%JB%  \label{fig:adapt_integration_conv}
%JB%\end{figure}
%JB%

\subsection{Single Aquifer Analytic Solution} \label{sec:prim_analytic_solution}
We define a~simple problem where analytical solution is available and 
on which we later test and compare the enrichment methods.
To this end, we restrict ourselves to a~single aquifer model.
In contrast to our article \cite{exner_2016}, the set of problems with analytical solution 
has been broaden to include multiple wells and to support arbitrary regular function in the source term.

We rewrite Problem \ref{thm:problem_2d_prim}, considering a~single aquifer and wells having one end point
at the cross-section with the aquifer $\bx_w$ and the other end point at the surface level denoted $\bx^w_D$.
Let us suppose the parameters of the model $\delta_2, \vc K_2, \vc K_1$ to be constants, and
the hydraulic conductivity $\vc K_2 = K_2,\, \vc K_1 = K_1$ to be scalars.
Zero source term $f_1=0$ is considered in the wells, so the flux there is governed only by the Dirichlet
boundary condition at $\bx^w_D$ and the flux to/from aquifer which forms the Neumann boundary condition at $\bx_w$.
Therefore the flux is constant and the pressure is linear in the wells:
\begin{equation} \label{eqn:linear_pressure_in_1d}
    -\delta^w_1 K^w_1 \grad p_1 = -\frac{\delta^w_1 K^w_1}{\bx^w_D-\bx_w} \big( g^w_{1D} - p_1(\bx_w) \big) \qquad \textrm{in } \Omega^w_1,\,\forall w\in\mathcal{W}
\end{equation}
The denominator $(\bx^w_D-\bx_w)$ is in fact the length of the well $\abs{\Omega^w_1}$.
The constant ${\delta^w_1 K^w_1}/\abs{\Omega^w_1}$ can be seen as the permeability of the well $c_w$ between aquitards
in the original work \cite{exner_2016}.

Then we have a~simplified problem:
\begin{thmproblem} \label{thm:prim_simple_problem}
Find $[p_1,\,p_2]$ satisfying
\begin{align}
-K_2 \Lapl p_2 &= f_2 && \textrm{ in } \Omega_2 \label{eqn:prim_simple_poisson}\\
-K_2\avg{\grad p_2 \cdot \vc n}_w &= \sigma_w\big( \avg{p_2}_w - p_1(\bx_w)\big)
    && \forall w\in\mathcal{W} \label{eqn:prim_simple_well_edge_bc} \\
p_2 &= g_{2D} && \textrm{ on } \Gamma_{ext} = \Gamma_{2D}, \label{eqn:prim_simple_dirichlet} \\
p_1(\bx^w_D) &= g^w_{1D} && \forall w\in\mathcal{W} \label{eqn:prim_simple_well_top_bc} \\
-\frac{\delta^w_1 K^w_1}{\abs{\Omega^w_1}} \big(g^w_{1D} - p_1(\bx_w)\big) &=  \abs{\Gamma_w} \delta_2 \sigma_w\big( \avg{p_2}_w - p_1(\bx_w)\big) 
    && \forall w\in\mathcal{W}\label{eqn:prim_simple_well_flow}
\end{align}
%
%
% Domain $\Omega$ is a~square with a~diagonal of length $2D$ an exterior boundary $\Gamma_D$. 
% The square is cut by a~well of radius $\rho_w$ which is placed at $\vc{x}_w$ and makes the interior boundary $\partial B_w$.
% 
% The Poisson equation \eqref{eqn:poisson} and the boundary conditions \eqref{eqn:dirichlet}-\eqref{eqn:well_edge_bc}
% govern the pressure inside the aquifer. The flow balance equation \eqref{eqn:well_flow} and the boundary condition
% \eqref{eqn:well_top_bc} govern the pressure inside the well ($H^1_w$ is the given pressure at the top of the aquifer).
% We further set $T=1.0$ for simplicity and consider permeability $c_w$ of the well between the top and the aquifer.
\end{thmproblem}

We now look for the analytic solution $[p_1, p_2]$ of Problem \ref{thm:prim_simple_problem}.
Well pressure is fully determined by finding the value $p_1(\bx_w)$.
%
% Now let us want the function
% \begin{equation} \label{eqn:poisson_solution_aux}
%   h(\vc{x}) = a\log(r) + b + U(r-\rho_w)^2 \sin(\omega x),
% \end{equation}
% to be the solution of \eqref{eqn:poisson} and find the corresponding source term $f$. Constant $U$ plays a~role
% of a~scaling parameter for the amplitude of the $\sin$ part.
% Applying Laplace operator to \eqref{eqn:poisson_solution_aux}, we obtain zero for the first logarithmic part and then
% transforming the second part we get
% \begin{equation} \label{eqn:source_term}
%   f = -U\left[\left(4 - 2 \frac{\rho_w}{r} \right) \sin(\omega x)      
%                     + 4(r-\rho_w)\frac{\vc{r}\cdot\vc{e}_1}{r} \omega\cos(\omega x)
%                     - (r-\rho_w)^2\omega^2\sin(\omega x) \right]
% \end{equation}
% 
% %TODO: describe the transform from a~ring solution to the square...
% Next we find constants $a$, $b$ and $H_w$, by letting \eqref{eqn:poisson_solution_aux} satisfy \eqref{eqn:dirichlet}-\eqref{eqn:well_flow}.
% We conclude the results in the following definition of the complete solution.
% \begin{definition} \label{def:solution}
% The solution $[h,H_w]$ of the problem \ref{thm:problem}
% with the source term $f$~equal \eqref{eqn:source_term},
% satisfying equations \eqref{eqn:poisson}-\eqref{eqn:well_top_bc}, is
% \begin{eqnarray}
%   h(\vc{x}) &=& a\log(r) + b + U(r-\rho_w)^2 \sin(\omega x), \label{eqn:poisson_solution}\\
%   H_w &=& \frac{c_w(1-t) H^1_w + \bar{\sigma}_w h_D}{c_w(1-t) + \bar{\sigma}_w}, \label{eqn:well_solution}
% \end{eqnarray}
% where
% \begin{eqnarray}
%   a &=& \frac{\rho_w\sigma_w c_w (h_D-H^1_w)}{c_w(1-t) + |\partial B_w|\sigma_w}, \nonumber \\
%   b &=& h_D - a\log D, \nonumber \\
%   t &=& \rho_w\sigma_w\log\left(\frac{\rho_w}{D}\right). \nonumber
% \end{eqnarray}
% \end{definition}
%
%The solution \eqref{eqn:poisson_solution} is then used to define the boundary function $p_{2D} = p_2|_{\Gamma_D}$.
%
Considering multiple singularities in the domain, we can obtain the solution using the superposition principle.
The solution is searched in the form
\begin{equation}
p_2 = p_{sin} + p_{reg} = \sum\limits_{j\in\mathcal{W}} a_j\log r_j + p_{reg}, \label{eqn:2d_press_sol_mult}\\
\end{equation}
where we split $p_2$ into a~singular and a~regular part. Function $p_{reg}$ is considered to be a~smooth function
which can be well approximated by standard finite elements (with optimal convergence rate).
Having the pressure in \eqref{eqn:2d_press_sol_mult}, we also derive its gradient and average terms
\begin{eqnarray}
\grad p_2 &=& \sum\limits_{j\in\mathcal{W}} a_j\frac{\vc r_j}{r_j^2} + \grad p_{reg}, \label{eqn:2d_press_grad_sol_mult}\\
\avg{p_2}_i &=& a_i\log\rho_i + \sum\limits_{\substack{j\in\mathcal{W}\\ j\neq i}} a_j \avg{\log r_j}_i + \avg{p_{reg}}_i, \label{eqn:2d_avg_press_sol_mult}\\
\avg{\grad p_2 \cdot \vc n_i}_i &=& -a_i\frac{1}{\rho_i} + \sum\limits_{\substack{j\in\mathcal{W}\\ j\neq i}} 
        a_j \avg{\frac{\vc r_j \cdot \vc n_i}{r_j^2}}_i + \avg{\grad p_{reg} \cdot \vc n_i}_i, \label{eqn:2d_avg_press_grad_sol_mult}
\end{eqnarray}

The singular part $p_{sin}$ solves \eqref{eqn:prim_simple_poisson} with zero right hand side since logarithm is a~harmonic function.
The source $f_2$ is sought such that the chosen regular part $p_{reg}$ is the solution of \eqref{eqn:prim_simple_poisson}, i.e.
\begin{equation}
    f_2 = -K_2 \Lapl p_{reg}.
\end{equation}
To find the unknowns $a_w$ and $p_1(\bx_w)$, we need to solve a~system of linear equations
which we obtain by substituting \eqref{eqn:2d_press_sol_mult}-\eqref{eqn:2d_avg_press_grad_sol_mult}
into the two conditions \eqref{eqn:prim_simple_well_edge_bc} and \eqref{eqn:prim_simple_well_flow}.
We then assemble the $2W\times 2W$ linear system $\vc M\vc a = \vc b$ where
\begin{subequations}
\label{eqn:2d_press_linear_system}
\begin{align}
M_{ij} &= \delta_{ij} K_2\avg{\frac{\vc r_j \cdot \vc n_i}{r_j^2}}_i - \sigma_i\avg{\log r_j}_i && i,j=1,\ldots,W, \\
%
M_{ii} &= \abs{\Gamma_i}\delta_2\sigma_i + \frac{\delta^i_1 K^i_1}{\bx^i_D-\bx_i} && i=W+1,\ldots,2W,\\
%
M_{ij} &= \sigma_i && i=1,\ldots,W,\\
    &&& j=W+1,\ldots,2W,\\
M_{ij} &= -\abs{\Gamma_i}\delta_2\sigma_i \avg{\log r_j} && i=W+1,\ldots,2W,\\
    &&& j=1,\ldots,W,\\
b_{i} &= K_2 \avg{\grad p_{reg}\cdot \vc n_i}_i + \sigma_i\avg{p_{reg}}_i && i=1,\ldots,W,\\
b_{i} &= \abs{\Gamma_i}\delta_2\sigma_i \avg{p_{reg}}_i + \frac{\delta^i_1 K^i_1}{\bx^i_D-\bx_i} && i=W+1,\ldots,2W.
\end{align}
\end{subequations}
We evaluate all the averages $\avg{\cdot}_i$ in the linear system numerically,
using simple composite midpoint rule integration with 1000 equidistant intervals on $\Gamma_i$.
This way we obtain pseudo-analytic solution of the multi well problem, which is accurate enough
to be used for measuring the error of our model.
The analytical solution \eqref{eqn:2d_press_sol_mult} is then used 
to define the boundary function $g_{2D} = p_2|_{\Gamma_D}$ in \eqref{eqn:prim_simple_dirichlet}.


\subsection{Test Cases with Single Well}
\label{sec:results}

In this section we suggest several numerical tests and provide comparison of different enrichments
as suggested in Section \ref{sec:enrichment_func}.

The implementation has been done in C++ language using the Deal II~\cite{bangerth_deal.ii_2007}, version 8.0, 
an open source finite element library. This library provides a well-documented code for high range of operations one needs
for solving partial differential equation: mesh generation, quadratures, different scalar and vector finite elements,
linear algebra, $h$ and $p$ adaptivity, error estimators, postprocessing and output to various formats.
However, it does not support any enrichment techniques like XFEM in the version 8.0.0,
and so it does not in the actual version 9.0.0, released in May, 2018, up to our best knowledge.

We use as much as possible of the relevant library code, although the enrichment functions, well intersections,
distribution and handling of the enriched degrees of freedom, adaptive quadrature and some output routines
must have been implemented on our own.


% We consider a~single well model with the following common input data.
% The domain $\Omega_2$ is a~square $(-2,2)\times(-2,2)$ and the well is characterized by 
% $\bx_w=[0.004,0.004]$,  $\rho_w=0.003$, $g^w_{1D}=9$, $\sigma_w=10^5$ and $c_w=10^{10}$, see geometry in \fig{fig:geometry}. 
% The enrichment radius is set $R_w=0.3$.
% The test cases differ by the regular part $p_{reg}$ and the source term $f_2$:

\subsubsection{Comparison of Enrichment Methods} \label{sec:res_comparison}

Let us now define four test cases on which we investigate the behavior of the methods, mainly their convergence properties.
We suggest four analytic solutions which differ by the regular part $p_{reg}$ 
and the corresponding source term $f_2$. Thus the quality of the approximation
of both the singular and the regular part can be later inspected to make a conclusion whether
it behaves as expected.
The list of $p_{reg}$ and $f_2$ follows:
%
\begin{itemize}
\item case 1: $p_{reg} = 0$, $f_2 = 0$,
\item case 2: $p_{reg} = U\sin(\omega x)(r_w-\rho_w)^2$,
    \begin{multline*}
        \qquad\;\, f_2 = -K_2 U\bigg[\left(4 - 2 \frac{\rho_w}{r_w} \right) \sin(\omega x)\\      
              + 4(r_w-\rho_w)\frac{\vc{r}\cdot\vc{e}_1}{r_w} \omega\cos(\omega x)
                - (r_w-\rho_w)^2\omega^2\sin(\omega x) \bigg],
    \end{multline*}
\item case 3: $p_{reg} = U r_w^2$, $f_2 = -4 K_2 U$,
\item case 4: $p_{reg} = U\sin(\omega x)$, $f_2 = K_2 U\omega^2\sin(\omega x)$.
\end{itemize}
The source term $f_2$ is visualized in \fig{fig:prim_sources}.
%
\begin{figure}[!htb]
%   \vspace{0pt}
    \centering    
%     \subfloat[test case 1]{\label{fig:source01} 
%         \includegraphics[width=0.46\textwidth]{\results source07_final.pdf} }
% %   \hspace{5pt}
%     \hfill
    \subfloat[test case 2]{\label{fig:source02} 
        \includegraphics[width=0.46\textwidth]{\results source04_final.pdf} }
    \vskip\baselineskip
    \subfloat[test case 3]{\label{fig:source03} 
        \includegraphics[width=0.46\textwidth]{\results source05_final.pdf} }
%   \hspace{5pt}
    \hfill
    \subfloat[test case 4]{\label{fig:source04} 
        \includegraphics[width=0.46\textwidth]{\results source07_final.pdf} }
    
  \caption
  {Source term $f_2$ visualization.}
  \label{fig:prim_sources}
\end{figure}
%
Test case 1 includes only the singularity and has zero source term, therefore the approximation
of the singularity itself is in the focus. 
% Later we present the original result from \cite{exner_2016} for this test case.
In Test case 2, the part of the searched solution $p_{reg}$ has both its value and gradient zero on the edge of the well $\Gamma_w$.
% we have no effects of the source term directly on $\Gamma_w$.
In Test case 3, $p_{reg}$ has constant value and gradient on $\Gamma_w$, and finally $p_{reg}$ is fluctuating on $\Gamma_w$ in Test case 4.
Thus from test cases 1 to 4 we are going from the simplest to the most complex problem
in the view of how the approximation is constructed in the vicinity of the well.
% Thus the average decomposition $\Gamma_w$ is not necessary as in the previous cases.
% and the average decomposition plays important role to achieve optimal convergence.

The parameters used in the test cases are gathered in Table \ref{tab:test_cases_data}.
In the first row, $l_\Omega$ determines the size of the domain: $\Omega=[-l_\Omega, l_\Omega]\times[-l_\Omega,l_\Omega]$.
The value of the parameter $c_w$ (well permeability) is explained in \eqref{eqn:linear_pressure_in_1d}.
As we shall see below, the approximation of the singularity by means of the standard FEM shape functions is better 
when a~node of $\mathcal{T}_{2}$ is inside the well cross-section. Therefore the center of the singularity $\bx_w$
is placed such that we do not take advantage of this feature and solve the worst scenario.
See the common geometry of the test cases in \fig{fig:test_cases_geometry}.
%
\begin{table}
\begin{center}
\begin{tabular}{c|cccc}
\toprule
% \multicolumn{2}{c}{Item} \\
% \cmidrule(r){1-2}
parameter & case 1 & case 2 & case 3 & case 4 \\
\midrule
$l_\Omega$  & 100    & 2      & 2      & 2  \\ 
$\bx_w$     & [5.43,5.43]  & [0.004,0.004]  & [0.004,0.004]  & [0.004,0.004] \\
$\rho_w$    & 0.2    & 0.003  & 0.003  & 0.003 \\
$\sigma_w$  & $10^5$ & $10^5$ & $10^5$ & $10^5$ \\
$c_w$       & $10^{10}$ & $10^{10}$ & $10^{10}$ & $10^{10}$ \\
$R_w$       & 50     & 0.3    & 0.3    & 0.3 \\
$g^w_{1D}$  & 100    & 4      & 4      & 4  \\
$\omega$    & --     & 6      & --     & 6  \\
$U$         & --     & 4      & 0.7    & 4  \\
\bottomrule
\end{tabular}
\caption{Input data for the considered test cases.}
\label{tab:test_cases_data}
\end{center}
\end{table}
%

\begin{figure}[!htb]
    \centering    
    \def\svgwidth{0.35\textwidth}
        \input{\results geometry.pdf_tex}
  \caption[Geometry of the aquifer domain.]{Geometry of the aquifer domain common to all the test cases.}
  \label{fig:test_cases_geometry}
\end{figure}

% \begin{figure}[!htb]
% %   \vspace{0pt}
%   \centering    
%   \subfloat[geometry of the problem]{\label{fig:geometry} 
% %     \begin{center}         
%       \def\svgwidth{0.325\textwidth}
%       \input{\results geometry.pdf_tex}
% %     \end{center} 
%       }
%   \hspace{5pt}
%   \subfloat[source term $f$]{\label{fig:solution} 
%     \includegraphics[width=0.58\textwidth]{\results source_term.pdf} }
%   \caption[]
%   {Geometry and the prescribed source term. Note that the cylinder representing the well is thicker then the actual well.}
% %   \label{fig:adapt_refinement}
% \end{figure}


We are interested in the behavior of the enrichment in the 2d domain.
Thus we measure the convergence of the methods only inside the aquifer.
% and we do not pay attention to the solution in the well.
The error of the solution is measured in $L^2$ norm, which is evaluated using higher order quadrature
on the unenriched elements and adaptive quadrature in the enriched area, as defined in Section \ref{sec:adaptive_quad_rules}.

\paragraph{Test case 1}
Let us start with Test case 1 and present the results achieved in \cite{exner_2016}.
Convergence of all used methods is measured on a~set of uniformly refined meshes, 
see the convergence graph in \fig{fig:convergence01}.
%
\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
  \includegraphics[width=\textwidth]{\results convergence01.pdf}
  \caption[Convergence graph in Test case 1]{Convergence of the $L^2$ norm of the approximation error in Test case 1.}
  \label{fig:convergence01}
\end{figure}
%
At first, we solve the problem by the standard FEM using $h$ adaptivity.
Kelly's error estimator from Deal II library is used to determine 30\% of the elements
with the highest error which are refined in the next step.
The element size $h$ for the convergence graph is determined as the size of the smallest element in the 
vicinity of the well.
From the graph of "FEM\_adapt" it is apparent that the convergence is slow until the size of the elements reaches the scale of the
well cross-section and one of the mesh nodes gets inside. 
Therefore the graph is divided into two parts with different convergence orders 0.56 and 1.27.
%We see that a very fine mesh is needed to capture the singularity but the error is still high.

Next we look at the convergence of the enrichment methods in the XFEM.
The standard XFEM pushes the error down by three orders of magnitude. Its convergence rate is nearly optimal with the order closing to 2.0.
On the other hand we have no results on finer meshes due to the conditioning of the linear system
which deteriorates rapidly for $h<2$ and our conjugate gradient (CG) solver does not converge.
The same problem arises using the ramp function XFEM. It deals better with the error on blending elements but the
ill-conditioning of the system matrix still corrupts the computation. We discuss the conditioning of the system 
a bit more in the next subsection \ref{sec:res_conditioning}.

The shifted XFEM and the SGFEM behave nearly the same way and give the best results as expected.
We alert the reader that the convergence graphs of ramp function XFEM, shifted XFEM and SGFEM overlap in \fig{fig:convergence01}.
We only mention that the SGFEM saves small amount of degrees of freedom on blending elements in comparison
with the shifted and the ramp function XFEM. The order of convergence in $L^2$ norm closing to 2.0 is optimal.


\paragraph{Test case 2}
Next we present the results in Test case 2, the convergence graph is in \fig{fig:convergence02}.
We expect the standard FE shape functions to optimally approximate the regular part of the solution
and the shape functions of the enrichment to capture the singularity.
%
\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
  \includegraphics[width=\textwidth]{\results convergence02.pdf}
  \caption[Convergence graph in Test case 2]{Convergence of the $L^2$ norm of the approximation error in Test case 2. The $\textrm{FEM}_{reg}$
  data comes from the problem without the well solved by standard FEM and with optimal convergence order 2.0.}
  \label{fig:convergence02}
\end{figure}
%
Therefore we solve the problem on the aquifer domain only with the source term $f_2$ but omitting the singularity
to have a reference solution -- an~approximation of $p_{reg}$. We plot this solution labeled as $\textrm{FEM}_{reg}$ in the convergence graph.
Since the source term $f_2$ is a~smooth and bounded function, the FEM is supposed to converge optimally with order 2.0
which is confirmed in the graph.
The error in XFEM is then expected to be of the same magnitude as the error $\textrm{FEM}_{reg}$.

Using the standard FEM approximation, see the line FEM in \fig{fig:convergence02}, the convergence order is low 0.5,
because the size of the elements is still far from $\rho_w$ and it cannot capture the singularity at all.

The XFEM behave similarly as in the Test case 1. The error of the enrichment methods is very close to the error $\textrm{FEM}_{reg}$,
except standard XFEM where the error in the blending elements is significant. The ill-conditioning of the linear system again 
disallows computing on finer meshes in case of the standard and ramp function XFEM.
The shifted XFEM and the SGFEM converge optimally and the error is dominated by the error of the regular part.


\paragraph{Test case 3}
The application of the standard and ramp function XFEM suffers from the same weaknesses, as we have shown above, in both Test case 3 and 4.
Due to the fact that these two methods do not perform well in our problems, we do not deal with them any further
and we do not present obtained results.

\begin{table}[!htb]
\begin{center}
\bgroup
\def\arraystretch{1.2}
\setlength\tabcolsep{5pt}
% \begin{tabular}{r|c|c|c|c|c|r|r}
\begin{tabular}{rc|cc|cc|cc}
\toprule
\multicolumn{2}{c|}{} & \multicolumn{2}{c|}{$\textrm{FEM}_{reg}$} & \multicolumn{2}{c|}{shifted XFEM} & \multicolumn{2}{c}{SGFEM}\\ [3pt] %\midrule
i & h & $\|p-p_h\|_{L^2(\Omega_2)}$ & order & $\|p-p_h\|_{L^2(\Omega_2)}$ & order & $\|p-p_h\|_{L^2(\Omega_2)}$ & order \\ [3pt] \midrule
0 & 0.5000 & 2.45e-01 & --   & 2.73e-01 & --   & 2.35e-01 & --   \\ %\hline
1 & 0.2500 & 6.12e-02 & 2.17 & 7.89e-02 & 1.79 & 6.70e-02 & 1.81 \\ %\hline
2 & 0.1250 & 1.53e-02 & 1.95 & 1.60e-02 & 2.30 & 1.60e-02 & 2.07 \\ %\hline
3 & 0.0625 & 3.82e-03 & 1.99 & 4.08e-03 & 1.97 & 4.08e-03 & 1.97 \\ %\hline
4 & 0.0312 & 9.56e-04 & 2.00 & 1.02e-03 & 2.00 & 1.02e-03 & 2.00 \\ %\hline
5 & 0.0156 & 2.39e-04 & 2.00 & 2.58e-04 & 1.98 & 2.58e-04 & 1.98 \\ %\hline
6 & 0.0078 & 5.97e-05 & 2.00 & 6.44e-05 & 2.00 & 6.44e-05 & 2.00 \\ %\hline
7 & 0.0039 & 1.49e-05 & 2.00 & 1.61e-05 & 2.00 & 1.61e-05 & 2.00 \\ %\hline 
\bottomrule
\end{tabular}
\caption{Convergence table of the shifted XFEM and SGFEM in Test case 3.}
\label{tab:convergence_test3}
\egroup
\end{center}
\end{table}
%
Table \ref{tab:convergence_test3} shows the convergence of the shifted XFEM and SGFEM for Test case 3.
In the column $\textrm{FEM}_{reg}$ the optimal convergence with the order 2.0 of the standard FEM on the regular problem is displayed as a~reference.
We see that both shifted XFEM and SGFEM converge also with the optimal convergence order 2.0 and that there is no significant difference in the error 
from the refinement level 2. The error of both enrichment methods is a bit higher than the error of $\textrm{FEM}_{reg}$, we would further diminish this
difference by enlarging the enrichment radius. Looking at the graph in \fig{fig:error_distribution_test3} where the error distribution is plotted,
we see that the error is concentrated outside the enrichment radius circle. It is caused due to the insufficient approximation of the singularity
by the standard FE shape functions. We also see from this figure that the approximation quality of the quadrilateral FEs on structured mesh is direction dependent.
%
\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
  \includegraphics[width=0.5\textwidth]{\results error05_final.pdf}
  \caption[Error distribution in Test case 3]{$L^2$ error distribution in Test case 3 at the refinement level level 4 ($h=0.0312$).
  A green circle represents the enrichment radius $R_w$. There is no visible difference between shifted XFEM and SGFEM, so only SGFEM is plotted.}
  \label{fig:error_distribution_test3}
\end{figure}
%

\paragraph{Test case 4}
The last case of our test series demonstrates the necessity of the averaged terms in the model formulation.
The convergence of the considered methods is shown in Table \ref{tab:convergence_test4}, in the same manner as in Test case 3.
We see that the convergence order of shifted XFEM and SGFEM is optimal up to the refinement level 6 and the error corresponds to
the error of the regular problem in $\textrm{FEM}_{reg}$ column. 
%
\begin{table}[!htb]
\begin{center}
\bgroup
\def\arraystretch{1.2}
\setlength\tabcolsep{5pt}
% \begin{tabular}{r|c|c|c|c|c|r|r}
\begin{tabular}{rc|cc|cc|cc}
\toprule
\multicolumn{2}{c|}{} & \multicolumn{2}{c|}{$\textrm{FEM}_{reg}$} & \multicolumn{2}{c|}{shifted XFEM} & \multicolumn{2}{c}{SGFEM}\\ [3pt] %\midrule
i & h & $\|p-p_h\|_{L^2(\Omega_2)}$ & order & $\|p-p_h\|_{L^2(\Omega_2)}$ & order & $\|p-p_h\|_{L^2(\Omega_2)}$ & order \\ [3pt] \midrule
0 & 0.5000 & 1.01e+01 & --   & 9.30e+00 & --   & 9.92e+00 & --   \\ %\hline
1 & 0.2500 & 2.25e+00 & 2.17 & 2.21e+00 & 2.07 & 2.24e+00 & 2.15 \\ %\hline
2 & 0.1250 & 5.84e-01 & 1.95 & 5.75e-01 & 1.94 & 5.80e-01 & 1.95 \\ %\hline
3 & 0.0625 & 1.47e-01 & 1.99 & 1.46e-01 & 1.98 & 1.47e-01 & 1.98 \\ %\hline
4 & 0.0312 & 3.70e-02 & 2.00 & 3.66e-02 & 2.00 & 3.67e-02 & 2.00 \\ %\hline
5 & 0.0156 & 9.24e-03 & 2.00 & 9.15e-03 & 2.00 & 9.17e-03 & 2.00 \\ %\hline
6 & 0.0078 & 2.31e-03 & 2.00 & 2.41e-03 & 1.93 & 2.39e-03 & 1.94 \\ %\hline
7 & 0.0039 & 5.78e-04 & 2.00 & 1.05e-03 & 1.20 & 1.01e-03 & 1.24 \\ %\hline 
\bottomrule
\end{tabular}
\egroup
\caption{Convergence table of the shifted XFEM and SGFEM in Test case 4.}
\label{tab:convergence_test4}
\end{center}
\end{table}

Then the error of the enrichment methods does not decrease as expected at the refinement level 7 and partially 6. 
To explain this behavior we plot the error distribution in two different refinement levels in \fig{fig:error_distribution_test4}.
On the left side, the error in the regular part is dominating. On the right side, the error of the singular part dominates in the center
and it spreads in $x$ direction. Closer look at the solution on the well edge shows that the pressure on the well edge is incorrect.
The problem has been solved several times for different $\rho_w$ (smaller and larger) and this error always shows up when there is 
an~element of the mesh with all its nodes inside the well-aquifer intersection.
We have a~suspicion that the elimination of the degrees of freedom of such elements from the linear system is done incorrectly
in our implementation. On the finer meshes where $\rho_w$ is larger than the element size,
neglecting the fluctuation term on the well edge \eqref{eqn:well_edge_fluctuation_neglect} might actually increase the error.
Since our model is not describing the pressure in the aquifer inside the well-aquifer intersection
(the pressure is constant and equal $p_1(\bx_w)$ according to the reduced 1d model of the well),
and we do not aim in reality to compute on such fine meshes, we do not pursue solving this error at the moment.

\begin{figure}[!htb]
%   \vspace{0pt}
  \centering
  \subfloat[refinement level 4]{\label{fig:error_distribution_test4a} 
        \includegraphics[width=0.48\textwidth]{\results error07_04_final.pdf} }
  \hfill
  \subfloat[refinement level 7]{\label{fig:error_distribution_test4b} 
        \includegraphics[width=0.48\textwidth]{\results error07_07_final.pdf} }
  \caption[Error distribution in Test case 4]{$L^2$ error distribution in Test case 4 at the refinement level level 4 and 7.
  A green circle represents the enrichment radius $R_w$. Pay attention to the logarithmic scale in the right figure.}
  \label{fig:error_distribution_test4}
\end{figure}
%

% \begin{table}[!htb]
% \begin{center}
% \bgroup
% \def\arraystretch{1.2}
% \setlength\tabcolsep{7pt}
% % \begin{tabular}{r|c|c|c|c|c|r|r}
% \begin{tabular}{rc|cc|cc|rr}
% \toprule
% %\hline
% %&&\multicolumn{2}{c|}{}&&\\[-15pt]
% % i & h & \multicolumn{2}{c|}{$\|p-p_h\|_{L^2(\Omega)}$} & $N^{reg}_{dofs}$ & $N^{enr}_{dofs}$\\ [3pt] \hline
% \multicolumn{2}{c|}{} & \multicolumn{2}{c|}{Test case 3} & \multicolumn{2}{c|}{Test case 4} & \multicolumn{2}{c}{}\\ [3pt] %\midrule
% i & h & $\|p-p_h\|_{L^2(\Omega)}$ & rate & $\|p-p_h\|_{L^2(\Omega)}$ & rate & $N^{reg}_{dofs}$ & $N^{enr}_{dofs}$ \\ [3pt] \midrule
% 0 & 0.5000 & 2.73e-01 & -    & 9.92e+00 & -    & 87 & 6         \\ %\hline
% 1 & 0.2500 & 7.89e-02 & 1.79 & 2.24e+00 & 2.15 & 295 & 6        \\ %\hline
% 2 & 0.1250 & 1.60e-02 & 2.30 & 5.80e-01 & 1.95 & 1110 & 21      \\ %\hline
% 3 & 0.0625 & 4.08e-03 & 1.97 & 1.47e-01 & 1.98 & 4294 & 69      \\ %\hline
% 4 & 0.0312 & 1.02e-03 & 2.00 & 3.67e-02 & 2.00 & 16930 & 289    \\ %\hline
% 5 & 0.0156 & 2.58e-04 & 1.98 & 9.17e-03 & 2.00 & 67206 & 1157   \\ %\hline
% 6 & 0.0078 & 6.44e-05 & 2.00 & 2.39e-03 & 1.94 & 267797 & 4628  \\ %\hline
% 7 & 0.0039 & 1.61e-05 & 2.00 & 1.01e-03 & 1.24 & 1069134 & 18509\\ %\hline 
% \bottomrule
% \end{tabular}
% \egroup
% \label{tab:sgfem_convergence_test34}
% \caption{Convergence table of the SGFEM in Test case 3 and 4.}
% \end{center}
% \end{table}
% 
% \paragraph{Test case 4}
% \begin{table}[!htb]
% \begin{center}
% \bgroup
% \def\arraystretch{1.2}
% \setlength\tabcolsep{7pt}
% % \begin{tabular}{r|c|c|c|c|c|r|r}
% \begin{tabular}{rc|cc|cc|rr}
% \toprule
% %\hline
% %&&\multicolumn{2}{c|}{}&&\\[-15pt]
% % i & h & \multicolumn{2}{c|}{$\|p-p_h\|_{L^2(\Omega)}$} & $N^{reg}_{dofs}$ & $N^{enr}_{dofs}$\\ [3pt] \hline
% \multicolumn{2}{c|}{} & \multicolumn{2}{c|}{Test case 3} & \multicolumn{2}{c|}{Test case 4} & \multicolumn{2}{c}{}\\ [3pt] %\midrule
% i & h & $\|p-p_h\|_{L^2(\Omega)}$ & rate & $\|p-p_h\|_{L^2(\Omega)}$ & rate & $N^{reg}_{dofs}$ & $N^{enr}_{dofs}$ \\ [3pt] \midrule
% 0 & 0.5000 & 2.35e-01 & -    & 9.30e+00 & -    & 103 & 22       \\ %\hline
% 1 & 0.2500 & 6.70e-02 & 1.81 & 2.21e+00 & 2.07 & 311 & 22       \\ %\hline
% 2 & 0.1250 & 1.60e-02 & 2.07 & 5.75e-01 & 1.94 & 1134 & 45      \\ %\hline
% 3 & 0.0625 & 4.08e-03 & 1.97 & 1.46e-01 & 1.98 & 4334 & 109     \\ %\hline
% 4 & 0.0312 & 1.02e-03 & 2.00 & 3.66e-02 & 2.00 & 17010 & 369    \\ %\hline
% 5 & 0.0156 & 2.58e-04 & 1.98 & 9.15e-03 & 2.00 & 67362 & 1313   \\ %\hline
% 6 & 0.0078 & 6.44e-05 & 2.00 & 2.41e-03 & 1.93 & 268105 & 4936  \\ %\hline
% 7 & 0.0039 & 1.61e-05 & 2.00 & 1.05e-03 & 1.20 & 1069750 & 19125\\ %\hline
% \bottomrule
% \end{tabular}
% \egroup
% \label{tab:xfem_convergence_test34}
% \caption{Convergence table of the shifted XFEM in Test case 3 and 4.}
% \end{center}
% \end{table}

\paragraph{Test cases summary}
We solved four single well-aquifer problems with different solutions on the well-aquifer intersection and different source terms.
We showed that the enrichment methods can sufficiently approximate the singularity and that the $L^2$ error of the approximation
can be pushed as low as the error of the regular part of the solution. The optimal convergence order 2.0 has been reached for all
the enrichment methods. The standard XFEM displayed significant error on the blending elements in contrast to the ramp function XFEM.
However, both suffered from ill-conditioning of the linear system. The most promising results were obtained using the shifted XFEM
and SGFEM, which behaved very similarly in our test cases.

Regarding the order convergence 1.8 presented by Gracie and Craig \cite{gracie_modelling_2010}, we obtained similar convergence order 
around 1.7-1.8 in our experiments using the original adaptive quadrature. Although, the order could be lower 
depending on the position of the well to the nodes of the mesh. We do not experience this behavior with our adaptive
quadrature and the convergence order is always close to the optimum of 2.0.

% The error of the shifted XFEM and the SGFEM addressed in \cite{exner_2016} for Test case 4 is suppressed due to two improvements. 
% Firstly the analytic solution has been derived more generally, including the effect of the well permeability $c_w$
% and the averaged terms, which better corresponds to the weak form.
% Secondly the code has been improved and debugged heavily since then and there was apparently a~problem in assembling the averaged terms.



\subsubsection{Conditioning of System Matrix} \label{sec:res_conditioning}
A~problem with ill-conditioning of the linear system coming from the XFEM methods is mentioned in Section \ref{sec:soa_xfem}
and are encountered also in our test cases in the section above. We do not inspect the matrices of the linear system in details, 
but we use some general results on the conjugate gradients method and the Laplace equation to have an insight on this problem.

\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
%   \includegraphics[width=\textwidth]{\results iterations.pdf}
    \includegraphics[width=\textwidth]{\results conditioning05.pdf}
  \caption[CG iterations count in Test case 3]{Graph of dependence of the CG iteration count on the 
  number of degrees of freedom. Measured on both problems with no serious distinction observed.}
  \label{fig:conditioning05}
\end{figure}
%

The condition number for matrices resulting from a~conforming FEM applied to Laplace equation is $O(h^{-2})$, so the iteration count 
for the CG without preconditioning is $O(h^{-1})=O(\sqrt{n})$, where $n=1/h^2$ is number of degrees of freedom in case of linear finite elements in 2d. 
With local preconditioning (Jacobi, SOR, ILU) one can usually achieve the number of iterations $O(h^{-0.5})$, cf. \cite{ern_evaluation_2006}.


Let us use the data from Test case 3 and look at the iteration count needed by the CG solver in \fig{fig:conditioning05}.
The number of iterations of the standard FEM is corresponding to the classic results as mentioned in the paragraph above. 

We can see clearly the enormous growth of the number of iterations in case of the standard XFEM and the ramp 
function XFEM. These problems are generally known and are described for example in the overview of the XFEM in
\cite{fries_xfem_overview_2010}. The usage of enrichment functions can make the approximation space almost linearly 
dependent from which the ill-conditioning of the system arises. 

On the other hand, the SGFEM is proven in \cite{babuska_stable_2012} to overcome this. They state in the conclusion that
the conditioning of the SGFEM system is not worse than that of the standard FEM system.
This is exactly what we see in the graph \fig{fig:conditioning05}, where the trends of the SGFEM and the FEM are nearly the same.
The behavior of the shifted XFEM is similarly good. We explain this by the fact that the difference between the enrichment functions
in shifted XFEM and SGFEM in this particular settings is not that significant.


\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
    \includegraphics[width=\textwidth]{\results moving_xw_error_zero.pdf}
  \caption[Approximation error dependence on singularity position]{Graph of dependence of the approximation error
   on the position of the singularity respective to a~mesh node.}
  \label{fig:moving_xw_error}
\end{figure}
%
Another test is considered based on Test case 3, in which the source term is set zero. The model is solved for different 
positions of the singularity $\bx_w$ and the effects on the solution and the linear system is observed. The mesh is structured and fixed with $h=0.125$,
centered at point $[0,0]$ which is an~element node. The position of the well (the singularity center) is parametrized by $\bx_w = [t,t]$ with 
\[t\in\{0,\, 0.002,\, 0.004,\, 0.01,\, 0.015,\, 0.03,\, 0.06,\, 0.1,\, 0.11,\, 0.12,\, 0.123,\, 0.125\},\]
so the well moves from one node of the element to the opposite one along the element diagonal. 
We see the results in two graphs \fig{fig:moving_xw_error} and \fig{fig:moving_xw_iterations}. The first one displays
the approximation error dependence on the relative position of the singularity and the element. The trend is apparent,
however the magnitude of the change is not significant. The error of the standard XFEM exhibits the same behavior
but it is by one order of magnitude higher, so it does not fit in the figure.

\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
    \includegraphics[width=\textwidth]{\results moving_xw_iterations.pdf}
  \caption[CG iteration count dependence on singularity position]{Graph of dependence of the CG iteration count
   on the position of the singularity respective to a~mesh node.}
  \label{fig:moving_xw_iterations}
\end{figure}
%
The second figure shows the change in the number of iterations of the CG solver. The trend is again apparent:
the CG deals better with the linear system when the singularity closes to an element node, the situation is worse
with the singularity in the middle. We do not understand this behavior completely, although we provide the following explanation.
The approximation of a~singularity by standard FE shape functions is much better when the singularity center is close to a~mesh node
(we observed this in Test case 1) due to the fact that the magnitude of the singularity is captured by the DoF corresponding to the node. 
Therefore when moving the singularity center away from the mesh node, the contribution of the enrichment to the system matrix is larger
(also observed in the experiments).
Since the conditioning (and the number of CG iterations) is sensitive to the enrichment part of the matrix,
we observe this trend in \fig{fig:moving_xw_iterations}.


% \begin{figure}[!htb]
% %   \vspace{0pt}
%   \centering
%   \subfloat[Approximation error]{\label{fig:moving_xw_error} 
%         \includegraphics[width=\textwidth]{\results moving_xw_error.pdf} }
%   \vskip\baselineskip
%   \subfloat[CG iterations]{\label{fig:moving_xw_iterations}
%         \includegraphics[width=\textwidth]{\results moving_xw_iterations.pdf} }
%         
%   \caption[Dependence on position of singularity]{Graph of dependence of the approximation error and the CG iteration count
%   on the position of the singularity respective to a~mesh node.}
%   \label{fig:conditioning05}
% \end{figure}
%

We are satisfied with the results of the shifted XFEM and SGFEM, so we do not investigate the properties of the linear
system any further at this stage. This area of the problem would need deeper investigation, including a~search for a~proper
preconditioner of the system matrix and looking for an~alternative iteration scheme to solve these specific types of linear systems.



\subsection{Enrichment Radius Estimation} \label{sec:enrichemnt_radius}
Up to now, we set the enrichment radius $R_w$ in the experiments to a~fixed value, without providing any explanation of the particular choice.
In this section, we study the dependence of the solution error on the enrichment radius $R_w$.
We look for a~clue for a~particular choice of $R_w$ that is optimal in a~specific sense.
The first part of this section is devoted to a~theoretical analysis, the later part presents a~numerical validation of obtained estimates.

\subsubsection{Derivation of Theoretical Estimate}
Let us consider a~general elliptic problem to find $p\in V$ satisfying
\[
   a(p, q) = l(q), \text{ for } q \in V,
\]
where $a$ is bounded elliptic bilinear form: $\norm{a}\le \alpha_2$, $a(q, q) \ge \alpha_1 \norm{q}_V^2$, $\alpha_1>0$, and $l$ a~bounded linear form, $l\in V'$. 
Suppose, that the problem is to be solved on a~domain $\Omega \subset \Real^2$ with a~single well of radius $\rho_w$ at the origin. 
Let us assume, that the solution can be split into the singular part $p_{sin}(\vc x)= \log |\vc x|$ and the regular part $p_{reg}=p-p_{sin}$.
Let $V^{reg}_h$ be a~polynomial finite element subspace of $V$ on a~regular mesh of elements with a~maximal side length $h$
and let $V_h=V^{reg}_h + V^{enr}_h$ be a~such enriched space that $p_{sin}$ can be approximated exactly on the enriched domain $Z_w$, i.e.
\begin{equation}
   \inf_{q\in V_h} \norm{p_{sin} - q}_V = \inf_{q\in V^{reg}_h} \norm{p_{sin}|_{Z'_w} - q}_V, \quad Z'_w = \Omega\setminus Z_w.
\end{equation}
Using standard error estimate for elliptic PDE (e.g. \cite[Theorem 13.1]{ciarlet_basic_1991}), we get
\begin{equation}
    \label{eq:std_err_estimate}
    \norm{p - p_h}_{V} \le c_a \inf_{q \in V_h} \norm{p - q}_{V} 
    \le c_a \left(\inf_{q \in V^{reg}_h} \norm{p_{reg} - q}_{V} + \inf_{q \in V_h} \norm{p_{sin} - q}_{V} \right)   
\end{equation}
where $c_a=1+\alpha_2/\alpha_1$.
In the following, we consider $V=H^1(\Omega)$, a square grid and $V^{reg}_h$ formed by bilinear finite elements. 
Then \eqref{eq:std_err_estimate} can be further estimated using approximation property of $V^{reg}_h$:
\begin{equation}
    \label{eq:particular_estimate}
    \norm{p - p_h}_{H^1(\Omega)} \le c_a \big(c h \abs{p_{reg}}_{H^2(\Omega)} + \norm{p_{sin} - \pi_h p_{sin}}_{H^1(Z'_w)} \big)
\end{equation}
where $\pi_h p_{sin}$ denotes interpolation of $p_{sin}$ in $V^{reg}_h$. Our next aim is to find tight estimate for the second term.
To this end, we calculate $H^1$ error on a~single square element $S_{h,r}$ with side $h$ and distance $r$ from origin.
Using parametrization $0<s,t<1$,  we get

\begin{align*}
 (p_{sin} - \pi_h p_{sin})(s,t)&=\log\sqrt{(r+hs)^2+(ht)^2} -\Big[(1-s)(1-t)\log r\\
 &\quad+ (1-s)t\log\sqrt{r^2+h^2} + s(1-t) \log(r+h) \\
 &\quad+ st\log\sqrt{(r+h)^2+h^2} \Big]\\
 &=\frac12 \frac{h^2}{r^2}\left(t^2-t - s^2 +s\right) + O\left(\frac{h^3}{r^3}\right)
\end{align*}
and 
\begin{equation}
 \grad(p_{sin} - \pi_h p_{sin})(s,t) = \frac{h}{r^2} \left( \frac12-s, t-\frac12 \right) + O\left(\frac{h^2}{r^2}\right).
\end{equation}
Assuming $h<r$, we can neglect higher order terms. Then, we obtain by direct integration
\begin{align*}
 \norm{p_{sin} - \pi_h p_{sin}}^2_{L^2(S_{h,r})} \approx \frac14 \frac{h^6}{r^4}\int_0^1\int_0^1 \left(t^2-t-s^2+s\right)^2\,\dd s\, \dd t = \frac{1}{360}\frac{h^6}{r^4} 
\end{align*}
and
\begin{equation}
    \label{eq:grad_estimate_on_square}
    \norm{\grad(p_{sin} - \pi_h p_{sin})}^2_{L^2(S_{h,r})} \approx \frac{2h^4}{r^4} \int_0^1 \Big(t-\frac12\Big)^2 \dd t = \frac{1}{6}\frac{h^4}{r^4}.
\end{equation}
Thus for the density of squared error we have
\[
    \frac{1}{\abs{S_{h,r}}} \norm{p_{sin} - \pi_h p_{sin}}^2_{H^1(S_{h,r})} \approx \frac{h^2}{6r^4}
\]
which after integration over the unenriched domain gives final estimate
\begin{equation}
    \label{eq:singular_approx_error}
    \norm{p_{sin} - \pi_h p_{sin}}_{H^1(Z'_w)} \le \left[\int_0^{2\pi} \int_{R_w}^\infty \frac{h^2} {6r^4} r \,\dd r\, \dd \theta\right]^{1/2} = \sqrt\frac{\pi}{6}\frac{h}{R_w}. 
\end{equation}

Recalling the estimate \eqref{eq:std_err_estimate}, we can conclude that optimal choice of the enrichment radius is $h/R_w\approx \norm{p_{reg}-\pi_h p_{reg}}_{H^1(\Omega)}$, 
which balances the error in the regular and the singular part. Larger $R_w$ would not benefit to better overall approximation error and it would lead unnecessarily to
higher amount of enriched DoFs.
In combination with an a~posteriori error analysis, this could give a~rule for an automatic
determination of the enrichment radius.

\subsubsection{Numeric Validation}
Here we provide numerical validation of the results above.
Our aim is twofold: we first validate the estimate \eqref{eq:grad_estimate_on_square}, secondly we simulate 
the dependence of the error in $L^2$ norm on the enrichment radius numerically and compare it with \eqref{eq:singular_approx_error}.

Validity of the estimate \eqref{eq:grad_estimate_on_square} is verified by calculating the ratio
\begin{equation} \label{eqn:log_h1_estimate_ratio}
\frac{h^{3/2} r^{-2} 12^{-1/2}}{\|p_{sin} - \pi_h p_{sin}\|^2_{H^1(T)}},\quad p_{sin}(\vc x) = \log \abs{\vc x}
\end{equation}
on every element $T$ of the sequence of refined meshes using a~$5\times5$ Gaussian quadrature for the estimation of the $H^1$ norm.
%
\begin{table}[!h]
\centering
\begin{tabular}{crr}
\toprule
% \multicolumn{2}{c}{Item} \\
% \cmidrule(r){1-2}
$h$    & min & max \\
\midrule
$\rfrac{10}{8}$   & 0.97 & 7.1  \\% & 1.38 & 10.0  \\ %& 0.7 & 5.3   \\
$\rfrac{10}{16}$  & 0.99 & 16.4  \\% & 1.40 & 23.1  \\ %& 1.0 & 17.4  \\
$\rfrac{10}{32}$  & 1.00 & 34.4  \\% & 1.41 & 48.7  \\ %& 1.5 & 51.8  \\
$\rfrac{10}{64}$  & 1.00 & 70.3  \\% & 1.41 & 99.5  \\ %& 2.1 & 150   \\
$\rfrac{10}{128}$ & 1.00 & 142.0   \\% & 1.41 & 201   \\ %& 3.0 & 427   \\
\bottomrule
\end{tabular}
\caption{Minimal and maximal values of the ratio \eqref{eqn:log_h1_estimate_ratio} for sequence of refined 
meshes with element size $h$. Validation of the estimate \eqref{eq:grad_estimate_on_square}.}
\label{tab:log_h1_estimate}
\end{table}
%
Table \ref{tab:log_h1_estimate} reports the minimum and the maximum values of the ratio over all elements of every mesh.
The minimum values are close to 1 independently of $h$ which is in perfect agreement with \eqref{eq:grad_estimate_on_square}.
Moreover, the minimum value is attained on the majority of
elements, see \fig{fig:log_estimate_b}. Both parts of \fig{fig:log_estimate} demonstrate also higher convergence rate on diagonal elements
where the nonlinear term of the bilinear finite elements allows better approximation of the saddle shaped logarithmic surface.
%
\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
  \subfloat[$\|\log \vc x - p_h\|^2_{H^1(T)}$ in log scale]{\label{fig:log_estimate_a} 
    \includegraphics[width=0.47\textwidth]{\results log_estimate_h1.pdf} }
  \hspace{0pt}
  \subfloat[the ratio \eqref{eqn:log_h1_estimate_ratio}]{\label{fig:log_estimate_b} 
    \includegraphics[width=0.47\textwidth]{\results log_estimate_ratio.pdf} }
  \caption[Log error estimate.]
  {
  Results of the numerical validation of the estimate \eqref{eq:grad_estimate_on_square}. The elements are left out 
  in the center where the $\log$ singularity is situated and where the function is cut off.
  }
  \label{fig:log_estimate}
\end{figure}
%

\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
  \includegraphics[width=0.9\textwidth]{\results radius_convergence_01.pdf}
%   \subfloat[rozdìlený element s vrtem]{\label{fig:adapt_ref_a} 
%     \includegraphics[width=70mm]{\figpath adaptive_ref.pdf} }
%   \hspace{0pt}
%   \subfloat[detail hranice vrtu]{\label{fig:adapt_ref_b} 
%     \includegraphics[width=72mm]{\figpath adaptive_ref_detail.pdf} }
  \caption[Convergence for different enrichment radii.]{Convergence graph for different enrichment radii. The "FEM reg"
  data comes from the problem without the singularity solved by the standard FEM -- it has the optimal convergence order 2.0.}
  \label{fig:radius_conv_1}
\end{figure}
%
Next, we study the influence of the enrichment radius $R_w$ on the global $L^2$ error. To this end, we solve Test case 3
using the SGFEM for different mesh steps and different values of $R_w$.
Let us remind that $O(h^p)$ convergence of the solution in the $H^1$ norm translates to the $O(h^{p+1})$ convergence of the solution in the $L^2$ norm 
for the linear elliptic problems (cf. \cite[Theorem 19.2]{ciarlet_basic_1991}). According to the estimates \eqref{eq:std_err_estimate}
and \eqref{eq:singular_approx_error}, we expect $O(h^2)$ convergence of $L^2$ norm independently of the enrichment radius. This is 
clearly demonstrated in \fig{fig:radius_conv_1}. For comparison, we plot also the error of the regular part $p_{reg}$ of the solution
% \[
%   p_{reg}(x,y) = U(r_w-\rho_w)^2 \sin(\omega x)
% \]
solved by standard FEM showing the $O(h^2)$ convergence.
As predicted, the total error diminishes with $R_w$ but cannot 
drop under the error of $p_{reg}$. We approximate $\norm{p_{reg} - \pi_h p_{reg}}_{H^1(\Omega)}$
using a~fine mesh and then according to \eqref{eq:singular_approx_error},
we get the optimal value of the enrichment radius
\[
    R_o \sim \sqrt{\frac{\pi}{6}} h/\norm{p_{reg} - \pi_h p_{reg}}_{H^1(\Omega)} \sim 0.32
\]
This value roughly matches a~point in the plots of the error as a~function of $R_w$ in
\fig{fig:radius_conv_2}, from which the error is not decreasing any more.



\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
  \includegraphics[width=0.9\textwidth]{\results radius_convergence_02.pdf}
%   \subfloat[rozdìlený element s vrtem]{\label{fig:adapt_ref_a} 
%     \includegraphics[width=70mm]{\figpath adaptive_ref.pdf} }
%   \hspace{0pt}
%   \subfloat[detail hranice vrtu]{\label{fig:adapt_ref_b} 
%     \includegraphics[width=72mm]{\figpath adaptive_ref_detail.pdf} }
  \caption[Optimal enrichment radius.]{Dependence of the error on the enrichment radius for different
  element sizes $h$.}
  \label{fig:radius_conv_2}
\end{figure}


\subsection{Test Cases with Multiple Wells}
In this section, more complex test cases are solved, including more than one well cross-secting the aquifer.
We test the enrichment methods, shifted XFEM and SGFEM in particular, whether they
still have such good convergence properties when the wells influence each other and when the enrichment zones coincide with each other.

%
\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
    \includegraphics[width=0.8\textwidth]{\results test_2w_exact.pdf}
  \caption{Solution of Test case 5 with 2 wells. }
  \label{fig:test_2w_exact}
\end{figure}
\paragraph{Test case 5}
At first we consider two wells intersecting a~square aquifer $\Omega_2 = [0,10]\times[0, 10]$ at points $\bx_1 = [4.1, 4.3]$ and $\bx_2 = [5.7, 5.9]$.
The pressure at the top of the wells is set $g^1_{1D}=150$ and $g^2_{1D}=100$ respectively.
Remaining parameters are set the same for both wells: $\rho_w = 0.003$, $\sigma_w = 100$, $c_w = 10^{10}$ for $w=1,2$.
The hydraulic conductivity of the aquifer is set $K_2=10^{-3}$ and the aquifers thickness is set $\delta_2=1$.
The source term is sinusoidal as in Test case 4, i.e. $f_2 = K_2U\omega^2\sin(\omega x)$, with parameters $\omega=1$, $U=80$.
The solution is shown in \fig{fig:test_2w_exact}.

\begin{figure}[!htb]
%   \vspace{0pt}
  \centering
  \subfloat[enrichment radius $R_w=0.6$]{\label{fig:error_2w_0-6} 
        \includegraphics[width=0.48\textwidth]{\results error_2w_0,6.pdf} }
  \hfill
  \subfloat[enrichment radius $R_w=2.0$]{\label{fig:error_2w_2-0} 
        \includegraphics[width=0.48\textwidth]{\results error_2w_2,0.pdf} }
  \caption[Error distribution in Test case 5]{$L^2$ error distribution in Test case 5 for two different $R_w$,
  represented by green circles.}
  \label{fig:error_distribution_test4}
\end{figure}
%
At first we solve the problem using the enrichment radius $R_w=0.6$ for both wells. The results are as expected:
optimal convergence order is observed and CG iterations count increases reasonably as in Section \ref{sec:res_conditioning}.
Next we enlarge the enrichment radius $R_w=2.0$ such that the two circular enrichment zones overlap and
the elements are enriched from both singularities there. We plot the error distribution in \fig{fig:error_distribution_test4}, 
comparing the difference between $R_w=0.6$ on the left and $R_w=2.0$ on the right. We see a~higher approximation error 
accumulating outside the smaller enrichment zones, in case of larger enrichment radii only the error of the regular part is apparent.
%
\begin{table}[!htb]
\begin{center}
\bgroup
\def\arraystretch{1.2}
\setlength\tabcolsep{5pt}
\begin{tabular}{rc|cc|cc}
\toprule
\multicolumn{2}{c|}{} & \multicolumn{2}{c|}{shifted XFEM} & \multicolumn{2}{c}{SGFEM}\\ [3pt] %\midrule
i & h & $\|p-p_h\|_{L^2(\Omega_2)}$ & order & $\|p-p_h\|_{L^2(\Omega_2)}$ & order \\ [3pt] \midrule
0 & 0.5000 & 1.01e+02 & --   & 1.06e+02 & --   \\ %\hline
1 & 0.2500 & 1.66e+01 & 2.61 & 1.78e+01 & 2.57 \\ %\hline
2 & 0.1250 & 4.22e+00 & 1.97 & 4.45e+00 & 2.00 \\ %\hline
3 & 0.0625 & 1.07e+00 & 1.99 & 1.11e+00 & 2.00 \\ %\hline
4 & 0.0312 & 2.67e-01 & 1.99 & 2.78e-01 & 2.00 \\ %\hline
5 & 0.0156 & 6.72e-02 & 1.99 & 6.93e-02 & 2.00 \\ %\hline
6 & 0.0078 & --       & --   & 1.72e-02 & 2.01 \\ %\hline
\bottomrule
\end{tabular}
\caption{Convergence table of the shifted XFEM and SGFEM in Test case 5, using enrichment radius $R_w=2.0$.}
\label{tab:convergence_test5}
\egroup
\end{center}
\end{table}

Table \ref{tab:convergence_test5} displays the optimal convergence order of both shifted XFEM and SGFEM for $R_w=2.0$.
The computation on the most refined mesh is failing in case of the shifted XFEM due to the non-converging CG solver.
The number of CG iterations for both enrichment methods and standard FEM is plotted in the graph in \fig{fig:test_2w_conditioning}.
The SGFEM performs as expected, on the other hand the CG iterations for shifted XFEM increase rapidly.
This is due to the enrichment of elements by multiple enrichment functions causing worse conditioning of the resulting linear system.
%
\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
    \includegraphics[width=0.8\textwidth]{\results test_2w_conditioning.pdf}
  \caption[CG iterations count in Test case 3]{Graph of dependence of the CG iteration count on the 
  number of degrees of freedom. Measured on both problems with no serious distinction observed.}
  \label{fig:test_2w_conditioning}
\end{figure}



\paragraph{Test case 6}
In this test case, five wells are cross-secting the aquifer $\Omega_2 = [0,10]\times[0, 10]$.
The well specific data are gathered in Table \ref{tab:test_case6_wells_data}.
The wells 3 and 5 can be seen as injection wells with a~positive flux to the aquifer, the others as pumping wells with a~positive flux from the aquifer.
The common well parameters are $\rho_w = 0.003$, $c_w = 10^{7}$.
The hydraulic conductivity of the aquifer is set $K_2=10^{-3}$ and the aquifers thickness is set $\delta_2=1$.
The source term is similar to the one in Test case 5, using parameters $\omega=1$, $U=-8$.
The solution is shown in \fig{fig:test_5w_exact}.
%
\begin{table}
\begin{center}
\begin{tabular}{c|ccccc}
\toprule
% \multicolumn{2}{c}{Item} \\
% \cmidrule(r){1-2}
well $w$ & 1 & 2 & 3 & 4 & 5 \\
\midrule
$\bx_w$     & [2.8,2.5]  & [4.9,5.4]  & [2.9,7.4]  & [7.3,7.8] & [7.4, 2.8] \\
$\sigma_w$  & 20   & 10  & 10  & 10  & 20 \\
$g^w_{1D}$  & -150 & -30 & 120 & -50 & 100 \\
\bottomrule
\end{tabular}
\caption{Input data for the wells in Test case 6.}
\label{tab:test_case6_wells_data}
\end{center}
\end{table}

%
\begin{figure}[!htb]
%   \vspace{0pt}
  \centering    
    \includegraphics[width=0.8\textwidth]{\results test_5w_exact.pdf}
  \caption{Solution of Test case 6 with 6 wells. }
  \label{fig:test_5w_exact}
\end{figure}
%

We show the convergence results of the SGFEM in Table \ref{tab:convergence_test6}. The problem is solved with
two different enrichment radii $R_w$, the smaller one assures non-overlapping enrichment zones.
The convergence order is still satisfying, although in case of the larger $R_w$ the error did not decreased enough
in the last refinement level for an unknown reason.
\begin{table}[!htb]
\begin{center}
\bgroup
\def\arraystretch{1.2}
\setlength\tabcolsep{5pt}
\begin{tabular}{rc|cc|cc}
\toprule
\multicolumn{2}{c|}{} & \multicolumn{2}{c|}{$R_w=0.8$} & \multicolumn{2}{c}{$R_w=2.0$}\\ [3pt] %\midrule
i & h & $\|p-p_h\|_{L^2(\Omega_2)}$ & order & $\|p-p_h\|_{L^2(\Omega_2)}$ & order \\ [3pt] \midrule
0 & 0.5000 & 5.09e+01 & --   & 5.08e+01 & --   \\ %\hline
1 & 0.2500 & 2.30e+00 & 4.46 & 1.66e+00 & 4.93 \\ %\hline
2 & 0.1250 & 5.66e-01 & 2.03 & 4.05e-01 & 2.04 \\ %\hline
3 & 0.0625 & 1.44e-01 & 1.98 & 1.03e-01 & 1.98 \\ %\hline
4 & 0.0312 & 3.61e-02 & 1.99 & 2.47e-02 & 2.06 \\ %\hline
5 & 0.0156 & 9.22e-03 & 1.97 & 6.36e-03 & 1.96 \\ %\hline
6 & 0.0078 & 2.41e-03 & 1.94 & 1.77e-03 & 1.85 \\ %\hline
\bottomrule
\end{tabular}
\caption{Convergence table of the SGFEM in Test case 6, using two different enrichment radii.}
\label{tab:convergence_test6}
\egroup
\end{center}
\end{table}

We do not mention the results of shifted XFEM explicitly since it performs nearly the same as SGFEM with the smaller enrichment radius.
In case of overlapping enrichment zones, the shifted XFEM suffers with ill-conditioning as in the previous test case.
On the other hand, the iteration count for the SGFEM increases still with the same rate independently of the chosen $R_w$.



\section{Summary}
\label{sec:summary}

In this first part of our work we provided the research on the XFEM and the adjacent topics relevant to our main theme, in Section \ref{sec:soa_xfem}.
We described the fundamentals of the usage of the XFEM and got into details in several implementation aspects such as
the choice of the local enrichment functions, the accurate integration or enrichment zone size.

The aim of the later part in Section \ref{sec:model_aquifer} was the investigation of four different enrichment methods
-- the XFEM, the Corrected XFEM with the ramp function and shifting, and the SGFEM. 
The problem setting was inspired by the work \cite{gracie_modelling_2010,craig_using_2011} 
of R.~Gracie and J.R.~Craig but our effort was aimed more in understanding the details of enrichment methods and their comparison
rather than in computation of complex problems. Resolving a~point singularity in a~2d domain was addressed.

The well-aquifer model was defined in the beginning and its weak form was derived, including the analysis of the weak solution existence.
In addition to our article \cite{exner_2016}, the model was formulated correctly using the averaged term on the well-aquifer
cross-section. Then the discretization by means of the XFEM was thoroughly described.
The range of the numerical tests was narrowed to problems with a~single aquifer for which the pseudo-analytic solution was derived.

All the implemented methods were compared in \ref{sec:res_comparison}. Regarding the XFEM, we saw that at 
least the ramp function must be used in order to optimize the error on the blending elements. 
The shifted XFEM and the SGFEM converged optimally and did not show any difference in the solution precision.
For the last two methods we also showed that the precision is not dependent on the relative position of a~singularity to a~node.

The issue of a~suboptimal convergence order reported in \cite{gracie_modelling_2010} was investigated. 
We revealed the problem and we suggested a~better strategy for the adaptive quadrature. 
The improvement was confirmed by the numerical tests in \ref{sec:res_comparison} where we obtained the optimal 
order of convergence in $L^2$ norm.
An alternative quadrature for integration of enriched functions in polar coordinates was also suggested.
% The quadrature was implemented but the numerical results were not satisfying. This would need a~deeper 
% investigation on the parameters that are needed to be set and a~possible bug in a~code is not excluded.

A proper size of the enrichment zone, defined by the enrichment radius, was studied. The error estimate dependent
on the enrichment radius was derived and it was numerically validated. Furthermore, the optimal enrichment radius was predicted 
for the test problem and it corresponded with the computed data.

The ill-conditioning of the system matrix was observed through the increasing iteration count of conjugate gradients solver.
The standard XFEM and the ramp function XFEM suffered from ill-conditioning even in the simplest test cases.
The shifted XFEM performed well when there was only one singular enrichment per element. Otherwise, when the enrichment
zones from multiple singularities were overlapping, only the SGFEM behaved well in terms of system matrix conditioning.


Regarding the three conditions \ref{enum:sgfem_conditions_a}-\ref{enum:sgfem_conditions_c} in Section \ref{sec:stable_gfem}
for an XFEM to be called the SGFEM, we conclude that our implementation of the SGFEM indeed appears to have these properties,
although we do not provide a~theoretical proof. The SGFEM yields the optimal convergence rate and its conditioning is not worse
than that of the FEM in all presented test cases, both the approximation error and the conditioning is robust with respect to the relative position
of the singularity to the mesh nodes.
The local orthogonalization technique has not been implemented, but it might be beneficial in case of overlapping enrichment zones.
Particularly in Test case 6, it is worth of further experimenting to resolve the slightly suboptimal error decrease at the last refinement level.





% \begin{figure}[!htb]
% %   \vspace{0pt}
%   \centering    
%     \includegraphics[width=0.6\textwidth]{\figpath 2_aquifers-5_wells_mesh_whitebg_crop.pdf}
%   \caption{0D-2D coupling example from my previous work. Distribution of pressure in 2 aquifers (horizontal planes) with 5 wells 
%           (vertical lines). The XFEM is used on a~coarse mesh (at the bottom). }
%   \label{fig:aquifers}
% \end{figure}
