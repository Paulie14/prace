

% Now we apply the XFEM on the well-aquifer pressure model and we study different enrichment methods and singular enrichments.
% Several important numerical aspects are inspected, mainly an adaptive quadrature and
% a~choice of an enrichment radius with respect to the convergence of the methods.
% 
% At first the problem for the primary unknown is defined and its weak form is derived. Then
% XFEM discretizations for several enrichment methods are described for this particular singular problem.
% Later several numerical experiments are computed and the results are investigated in detail.
% The results presented here are partially covered in our article \cite{exner_2016}.

In this chapter, the XFEM with different enrichment techniques is applied on a~pressure well-aquifer model
in 1d-2d case. The problem for the primary unknown is defined, its weak form is derived and
the existence of a~unique discrete solution is proved.
Several important numerical aspects are inspected, mainly an adaptive quadrature and
a~choice of an enrichment radius with respect to the convergence of the methods.

\section{Coupled 1d-2d Model (Primary Weak Form)}
\label{sec:primary_form}

Problem \ref{thm:problem_2d} is rearranged, velocity $\vc u_d$ is substituted from the Darcy's law and the problem is solved
with pressure $p_d$ as the primary unknown quantity.

Considering standard Sobolev space $H^1_0(\Omega_d)=\big\{q_d\in H^1(\Omega_d); q_d|_{\Gamma_{dD}}=0\big\}$,
and taking the Dirichlet boundary condition into account,
the trial space $V$ and the test space $V_0$ are defined
\begin{eqnarray}
  V &=& H^1(\Omega_1)\times H^1(\Omega_2), \label{eqn:prim_weak_space_V}\\
  V_0 &=& H^1_0(\Omega_1)\times V^1_0(\Omega^1_2) \times\cdots\times V^M_0(\Omega^M_2), \label{eqn:prim_weak_space_V0}
\end{eqnarray}
with
% \textrm{with }
\begin{equation}
  V^m_0(\Omega^m_2) = \big\{q_2\in H^1_0(\Omega^m_2):\, \fluct{q_2}^m_w=0,\,\forall w\in\mathcal{W}\big\}
  \quad \forall m\in\mathcal{M}. \label{eqn:prim_weak_space_Vm0}
\end{equation}
%
% The spaces $V,\,V_0$ are equipped with the norm
% \begin{equation}
%     \norm{q}_V = \big( \norm{q_1}^2_{H^1(\Omega_1)} + \norm{q_2}^2_{H^1(\Omega_2)} \big)^{1/2}.
% \end{equation}
The weak solution $p=[p_1,p_2]\in V$ and the test functions $q=[q_1,q_2]\in V_0$ are denoted
and the weak problem is defined
\thmproblem{ \label{thm:problem_2d_prim_weak}
Find $p=p_0 + p_w + p_D \;\in V$ such that
\begin{align}
a(p_0, q) &= l(q) - a(p_w, q) - a(p_D, q) && \forall q\in V_0
\end{align}
where
\begin{multline}
  a(p,q) =
  \int_{\Omega_2} \delta_2 \vc K_2 \grad p_2 \cdot \grad q_2 \dd\bx
  + \int_{\Omega_1} \delta_1 \vc K_1 \grad p_1 \cdot \grad q_1 \dd\bx \\
  + \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \abs{\Gamma^m_w} \delta_2 \sigma^m_w (\avg{p_2}^m_w - p_1(\vc x^m_w)) (\avg{q_2}^m_w - q_1(\vc x^m_w))
\end{multline}
\vspace{-10pt}
\begin{multline}
  l(q) = \int_{\Omega_2} \delta_2 f_2 q_2 \dd\bx + \int_{\Omega_1} \delta_1 f_1 q_1 \dd\bx
  + \int_{\Gamma_{2N}} g_{2N}q_2 \dd s + \int_{\Gamma_{1N}} g_{1N}q_1 \dd s
\end{multline}
for $p_0\in V_0$ and given $f_d\in L_2(\Omega_d)$ and $g_{dN}\in L_2(\Gamma_{dN})$, $d=1,2$,
while $p_w, p_D\in V$ are functions chosen such that they satisfy Dirichlet boundary conditions.
\vspace{5pt}
}

For the solution $p$ of Problem \ref{thm:problem_2d_prim_weak} to be unique it is shown,
that it is enough to fix the pressure at the top of a single well (e.g. a pumping well
where the pressure can be measured), possibly with Neumann boundary condition
at the rest of the boundary.

% We rearrange Problem \ref{thm:problem_2d} and we substitute for $\vc u_d$ from the Darcy's law and solve the problem
% with pressure $p_d$ as the primary unknown quantity. Thus we obtain the following
% 
% \thmproblem{ \label{thm:problem_2d_prim}
% Find $[p_1,\,p_2]$ satisfying
% \begin{subequations}
% \begin{align}
% \div \left( -\delta_2 \vc K_2 \grad p_2 \right) &= \delta_2 f_2 && \textrm{in } \Omega_2,\;  \label{eqn:prim_problem_2d_2d} \\
% \div \left( -\delta_1 \vc K_1 \grad p_1 \right) &= \delta_1 f_1 + {\color{blue}\sum_{m\in\mathcal{M}}\abs{\Gamma^m_w}\Sigma^m_w\delta_t(t - t^m)} && \textrm{in }
% \Omega^w_1,\;\forall w\in\mathcal{W}, \label{eqn:prim_problem_2d_1d_source}\\
% \color{blue}\avg{-\delta_2 \vc K_2 \grad p_2 \cdot \vc n}^m_w &= \color{blue}\Sigma^m_w && \forall w\in\mathcal{W},\; \forall m\in\mathcal{M}, \label{eqn:prim_problem_2d_flux}\\
% \fluct{p_2}^m_w &= g^m_w && \forall w\in\mathcal{W},\; \forall m\in\mathcal{M}, \label{eqn:prim_problem_2d_press_fluct}\\
% p_d &= g_{dD} && \textrm{on } \Gamma_{dD},\; d=1,2, \label{eqn:prim_problem_2d_dirichlet}\\
% \delta_d \vc K_d \grad p_d \cdot \vc n &= g_{dN} && \textrm{on } \Gamma_{dN},\; d=1,2 \label{eqn:prim_problem_2d_neumann}
% \end{align}
% \end{subequations}
% where
% \[ 
% {\color{blue}
%     \Sigma^m_w = \delta_2(\vc x^m_w)\sigma^m_w\big(\avg{p_2}^m_w-p_1(\vc x^m_w)\big).
% } 
% \label{eqn:prim_1d_2d_sigma_source}
% \]
% }
% 
% We add the following assumptions and notation. We consider the hydraulic conductivity tensor $\vc K_d$
% to be an invertible positive definite $d\times d$ matrix, for which we denote
% \begin{equation}
%     \underline{k_d} = \inf\limits_{\bx\in\Omega_d}\lambda_{\min}(\vc K_d), \quad
%     \overbar{k_d}   = \sup\limits_{\bx\in\Omega_d}\lambda_{\max}(\vc K_d), \qquad
%      0 < \underline{k_d} \leq \overbar{k_d}.
% \end{equation}
% We denote the minimal and maximal cross-section $\delta_d$ of the domains $\Omega_d$
% \begin{eqnarray}
%     \underline{\delta_2} = \inf\limits_{\bx\in\Omega_2} \delta_2(\vc x), \quad
%     \overbar{\delta_2}   = \sup\limits_{\bx\in\Omega_2} \delta_2(\vc x), \qquad
%      0 < \underline{\delta_2} \leq \overbar{\delta_2},\\
%      \underline{\delta_1} = \min\limits_{w\in\mathcal{W}} (\pi\rho_w^2), \quad
%     \overbar{\delta_1}    = \max\limits_{w\in\mathcal{W}} (\pi\rho_w^2), \qquad
%      0 < \underline{\delta_1} \leq \overbar{\delta_1}.
% \end{eqnarray}
% 
% We consider the standard Sobolev spaces $H^1(\Omega_d)$, $d=1,2$ and
% \[ H^1_0(\Omega_d)=\big\{q_d\in H^1(\Omega_d); q_d|_{\Gamma_{dD}}=0\big\}.
% \]
% which takes into account the Dirichlet boundary condition.
% Next we define the trial space $V$ and the test space $V_0$:
% \begin{eqnarray}
%   V &=& H^1(\Omega_1)\times H^1(\Omega_2), \label{eqn:prim_weak_space_V}\\
%   V_0 &=& H^1_0(\Omega_1)\times V^1_0(\Omega^1_2) \times\cdots\times V^M_0(\Omega^M_2), \label{eqn:prim_weak_space_V0}
% \end{eqnarray}
% with
% \begin{eqnarray}
%   \textrm{with } V^m_0(\Omega^m_2) &=& \big\{q_2\in H^1_0(\Omega^m_2):\, \fluct{q_2}^m_w=0,\,\forall w\in\mathcal{W}\big\}
%   \quad \forall m\in\mathcal{M}. \label{eqn:prim_weak_space_Vm0}
% \end{eqnarray}
% %
% The spaces $V,\,V_0$ are equipped with the norm
% \begin{equation}
%     \norm{q}_V = \big( \norm{q_1}^2_{H^1(\Omega_1)} + \norm{q_2}^2_{H^1(\Omega_2)} \big)^{1/2}.
% \end{equation}
% We denote the weak solution $p=[p_1,p_2]\in V$ and the test functions $q=[q_1,q_2]\in V_0$.
% 
% 
% Below the weak form of Problem \ref{thm:problem_2d_prim} is derived.
% Due to the choice of $V^m_0$ in \eqref{eqn:prim_weak_space_Vm0},
% the well edge integral is simplified:
% \begin{equation} \label{eqn:prim_avg_assumption}
%     \int_{\Gamma^m_w} p_2q_2 \dd s %= \int_{\Gamma^m_w} \big(\avg{p}\avg{q} + \avg{p}\fluct{q} + \fluct{p}\avg{q} + \fluct{p}\fluct{q} \big)\dd s
%     =  \int_{\Gamma^m_w} \avg{p_2}^m_w\avg{q_2}^m_w \dd s + \int_{\Gamma^m_w} \fluct{p_2}^m_w\fluct{q_2}^m_w \dd s = \abs{\Gamma^m_w} \avg{p_2}^m_w\avg{q_2}^m_w \dd s.
% \end{equation}
% We now apply the standard Galerkin method. We multiply the equations \eqref{eqn:prim_problem_2d_2d} and \eqref{eqn:prim_problem_2d_1d_source}
% by test functions $q_d$, integrate by parts over $\Omega_d$ using \eqref{eqn:prim_problem_2d_flux}-\eqref{eqn:prim_problem_2d_neumann} and the assumption \eqref{eqn:prim_avg_assumption}, 
% then we sum up the two equations together to get
% \begin{multline} \label{eqn:prim_weak_form}
%   a(p,q) =
%   \int_{\Omega_2} \delta_2 \vc K_2 \grad p_2 \cdot \grad q_2 \dd\bx
%   + \int_{\Omega_1} \delta_1 \vc K_1 \grad p_1 \cdot \grad q_1 \dd\bx \\
%   + \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \abs{\Gamma^m_w} \delta_2 \sigma^m_w (\avg{p_2}^m_w - p_1(\vc x^m_w)) (\avg{q_2}^m_w - q_1(\vc x^m_w)) \\
%   = \int_{\Omega_2} \delta_2 f_2 q_2 \dd\bx + \int_{\Omega_1} \delta_1 f_1 q_1 \dd\bx
%   + \int_{\Gamma_{2N}} g_{2N}q_2 \dd s + \int_{\Gamma_{1N}} g_{1N}q_1 \dd s \\
%   = l(q).
% \end{multline}
% 
% 
% Considering the Dirichlet boundary conditions, we split the solution into three parts $p=p_0 + p_w + p_D$, while
% $p_0\in V_0$ and $p_w, p_D\in V$ are functions chosen such that they satisfy \eqref{eqn:prim_problem_2d_press_fluct} on the wells edges and
% \eqref{eqn:prim_problem_2d_dirichlet} on the exterior boundary, respectively.
% Finally, we define the weak problem
% \thmproblem{ \label{thm:problem_2d_prim_weak}
% Find $p\in V$ such that
% \begin{align}
% a(p_0, q) &= l(q) - a(p_w, q) - a(p_D, q) && \forall q\in V_0.
% \end{align}
% for given $f_d\in L_2(\Omega_d)$ and $g_{dN}\in L_2(\Gamma_{dN})$, $d=1,2$, and $p_w, p_D\in V$ fixed.
% \vspace{10pt}
% }
% 
% 
% Next we discuss some properties of the defined problem and provide several results
% to show the existence of a~unique solution eventually.
% To this end we shall need two following results about compact mappings from \cite{necas_direct_2012}, p. 103, Corollary 6.3 and Theorem 6.2:
% \begin{lemma} \label{lem:compact_1}
%     Let $\Omega_1$ be a~closed interval in $\mathbb R^1$.
%     The identity mapping $I:H^1(\Omega_1)\rightarrow C(\overbar\Omega_1)$ is compact.
% \end{lemma}
% 
% \begin{lemma} \label{lem:compact_2}
%     Let $\Omega_2 \subset \mathbb R^2$ be a~domain with Lipschitz boundary.
%     The mapping $Z\in[H^1(\Omega_2)\rightarrow L_2(\partial\Omega_2)]$, which define traces, is compact.
% \end{lemma}
% 
% \vspace{10pt}
% At first we bound the bilinear form of Problem \ref{thm:problem_2d_prim_weak}.
% \begin{lemma} \label{lem:prim_form_a_continuous}
%     The bilinear form $a$, defined in \eqref{eqn:prim_weak_form}, is continuous on $V_0$:
%     \begin{equation} \label{eqn:prim_form_a_bound}
%         \abs{a(p,q)} \leq \alpha_2 \norm{p}_V \norm{q}_V \quad \forall p,q\in V_0,
%     \end{equation}
% \end{lemma}
% 
% \begin{proof}
% To bound the average terms in the form $a$,
% we define an auxiliary smooth function $\psi\in C^{\infty}(\overbar\Omega)$ such that
% \begin{equation*}
%   \grad\psi\cdot\vc n =
%   \begin{cases}
%     1 & \textrm{ on } \Gamma_{int}\\
%     0 & \textrm{ on } \Gamma_{ext}.
%   \end{cases} \nonumber
% \end{equation*}
% Then we have the upper bound
% \begin{eqnarray}
%   \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \avg{q}^m_w
%     &=& \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \int_{\Gamma^m_w} q (\grad\psi\cdot\vc n) \dd s
%     = \int_{\partial\Omega_2} q (\grad\psi\cdot\vc n) \dd s
%     = \int_{\Omega} \big(q \Lapl\psi + \grad q \cdot\grad\psi \big) \dd\bx \nonumber\\
%     &\leq& \norm{q}_{L_2(\Omega)}\norm{\Delta\psi}_{L_2(\Omega)} + \norm{\grad q}_{L_2(\Omega)} \norm{\grad\psi}_{L_2(\Omega)} \nonumber\\
%     &\leq& C_{avg}(\prtl\Omega_2, \Omega_2) \Big(\norm{q}_{L_2(\Omega)} + \norm{\grad q}_{L_2(\Omega)}\Big)
% \end{eqnarray}
% 
% Further, due to Lemma \ref{lem:compact_1}, $q_1\in H^1_0(\Omega_1)$ is continuous and bounded on $\Omega_1$,
% and therefore $\abs{q_1(\vc x^m_w)}\leq \norm{q}_{H^1(\Omega_1)}$.
% Then we obtain the final bound
% \begin{align} \label{eqn:prim_form_a_bound_proof}
%     \abs{a(p,q)} &\leq \overbar{\delta_2}\overbar{k_2}\, \norm{\grad p_2}_{L_2(\Omega_2)} \norm{\grad q_2}_{L_2(\Omega_2)}
%         + \overbar{\delta_1}\overbar{k_1}\, \norm{\grad p_1}_{L_2(\Omega_1)} \norm{\grad q_1}_{L_2(\Omega_1)} \nonumber\\
%         &\quad + \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}} \overbar{\delta_2} \abs{\Gamma^m_w} \sigma^m_w
%             \abs{\avg{p_2}^m_w - p_1(\vc x^m_w)}\abs{\avg{q_2}^m_w - q_1(\vc x^m_w)} \nonumber\\
%     &\leq C \Big( \norm{p_2}_{H^1(\Omega_2)} + \norm{p_1}_{H^1(\Omega_1)} \Big) \Big( \norm{q_2}_{H^1(\Omega_2)} + \norm{q_1}_{H^1(\Omega_1)} \Big) \nonumber\\
%     &\leq \alpha_2 \norm{p}_V \norm{q}_V \quad \forall p,q\in V_0,
% \end{align}
% 
% with a~constant $\alpha_2(\overbar{\delta_2},\overbar{k_2},\overbar{\delta_1},\overbar{k_1},\sigma^m_w,\abs{\Gamma^m_w},C_{avg})$.
% \end{proof}
% 
% 
% Next we want to show that the bilinear form $a$ is coercive on $V_0$.
% We state the following lemma
% \begin{lemma} \label{lem:prim_form_a_coercivity_V0}
%     Let there be a~Dirichlet boundary condition prescribed on any non\-empty subset of $\Gamma_{dD}$, $d=1,2$.
%     Then the bilinear form $a$, defined in \eqref{eqn:prim_weak_form}, is coercive on $V_0$:
%     \begin{equation} \label{eqn:prim_form_a_coercivity_V0}
%         a(q,q) \geq \alpha_1\norm{q}^2_V \quad \forall q\in V_0.
%     \end{equation}
% \end{lemma}
% 
% % https://en.wikipedia.org/wiki/Reflexive_space
% % https://en.wikipedia.org/wiki/Semi-continuity
% \begin{proof}
% We take similar steps as in the proof of the Poincar{\'e}'s inequality by contradiction in \cite{evans_partial_2010}, p. 290,
% (also in \cite{necas_direct_2012}, p. 9).
% Suppose that \eqref{eqn:prim_form_a_coercivity_V0} does not hold.
% Then $\forall n\in\mathbb N$ exists a~function $q^n\in V_0$ satisfying
% \begin{equation} \label{eqn:prim_coercivity_proof1}
%     \norm{q^n}^2_V > n\cdot a(q^n, q^n).
% \end{equation}
% Without loss of generality, let us consider $\norm{q^n}_V=1$.
% Then \eqref{eqn:prim_coercivity_proof1} implies 
% \begin{equation} \label{eqn:prim_coercivity_proof2}
%     a(q^{n}, q^{n}) < \frac{1}{n} \norm{q^{n}}^2_V = \frac{1}{n}.
% \end{equation}
% Space $V_0$ is a~Hilbert space which is reflexive, then there exists a~weakly convergent subsequence
% $\{q^{n_k}\}^{\infty}_{k=1}\subset\{q^{n}\}^{\infty}_{n=1}$ and a~function $q\in V_0$ such that
% \begin{equation} \label{eqn:prim_coercivity_proof3}
%     q^{n_k} \rightharpoonup q \quad \textrm{in } V_0.
% \end{equation}
% %
% Next the bilinear form $a$ can be bounded below
% \begin{align} 
%     a(q^{n_k},q^{n_k}) &\geq
%           \underline{\delta_2}\,\underline{k_2} \norm{\grad q^{n_k}_2}^2_{L_2(\Omega_2)}
%         + \underline{\delta_1}\,\underline{k_1} \norm{\grad q^{n_k}_1}^2_{L_2(\Omega_1)} \nonumber\\
%         & \qquad + \sum_{\substack{w\in \mathcal{W} \\ m\in \mathcal{M}}}\abs{\Gamma^m_w} \underline{\delta_2}
%             \sigma^m_w (\avg{q^{n_k}_2}^m_w - q^{n_k}_1(\vc x^m_w))^2.  \label{eqn:prim_coercivity_proof4}
% \end{align}
% Since all terms on the right hand side of \eqref{eqn:prim_coercivity_proof4} are non-negative,
% each term must converge to zero to satisfy \eqref{eqn:prim_coercivity_proof2}.
% The weak lower semi-continuity
% \begin{equation}
%     \norm{\grad q}_{L_2(\Omega_d)} \leq \liminf \limits_{k \to \infty} \norm{\grad q^{n_k}}_{L_2(\Omega_d)}, \qquad d=1,2
% \end{equation}
% and \eqref{eqn:prim_coercivity_proof4} with $k\rightarrow\infty$ then implies that
% \begin{equation}
%     \grad q_1 = \grad q_2 = 0.
% \end{equation}
% As a~consequence of \eqref{eqn:prim_coercivity_proof3} and Lemma \ref{lem:compact_1}, we have a~point convergence
% \begin{equation} \label{eqn:prim_coercivity_proof5}
%     q^{n_k}_1(\bx^m_w) \rightarrow q_1(\bx^m_w)
%     \qquad \forall w\in\mathcal{W}, \forall m\in\mathcal{M}.
% \end{equation}
% As a~consequence of \eqref{eqn:prim_coercivity_proof3} and Lemma \ref{lem:compact_2}, we have a~strong convergence
% \begin{equation} \label{eqn:prim_coercivity_proof7}
%     q^{n_k}_2|_{\Gamma^m_w} \rightarrow q_2|_{\Gamma^m_w} \implies \avg{q^{n_k}_2}^m_w \rightarrow \avg{q_2}^m_w
%     \qquad \forall w\in\mathcal{W}, \forall m\in\mathcal{M}
% \end{equation}
% Finally for the coupling term, we have the following pressure equality, reminding that $\sigma^m_w>0$,
% \begin{equation} \label{eqn:prim_coercivity_proof8}
%     q_2|_{\Gamma^m_w} = \avg{q_2}^m_w = q_1(\bx^m_w)
%     \qquad \forall w\in\mathcal{W}, \forall m\in\mathcal{M}.
% \end{equation}
% 
% We see that pressure is constant in each aquifer and in each well.
% Due to the coupling term, pressure must be equal between each pair well-aquifer and thus pressure is identical everywhere.
% Finally, if we prescribe Dirichlet boundary condition on any nonempty subset of $\Gamma_{dD}$, we have $q=0$, since $q\in V_0$,
% and $\norm{q}_V=0$ which is in contradiction with the assumption.
% \end{proof}
% 
% 
% The existence and uniqueness of the solution can be shown via the Lax-Milgram theorem (e.g. in \cite{necas_direct_2012}, p. 29) due to the ellipticity
% of the bilinear form $a$ and the boundedness of the problem, using the results of Lemmas \ref{lem:prim_form_a_continuous}
% and \ref{lem:prim_form_a_coercivity_V0}:
% \begin{theorem} \label{thm:prim_lax_milgram_theorem}
% Let $a: V\times V \rightarrow \R$ be a~continuous coercive bilinear form on $V_0$, i.e.
% \begin{align}
%     \abs{a(p_0,q)} &\leq \alpha_2 \norm{p_0}_V \norm{q}_V && \forall p_0,q \in V_0,\\
%     a(q,q) &\geq \alpha_1 \norm{q}^2_V && \forall q\in V_0,
% \end{align}
% with the constants $\alpha_2$ from \eqref{eqn:prim_form_a_bound_proof} and $\alpha_1$ from \eqref{eqn:prim_form_a_coercivity_V0}.\\
% Then there exists a~unique solution $p\in V$ to Problem \eqref{thm:problem_2d_prim_weak} for any
% % $f_2\in L_2(\Omega_2)$, $f_1\in L_2(\Omega_1)$ and $g_{2N}\in L_2(\Gamma_{2N})$, $g_{1N}\in L_2(\Gamma_{1N})$
% $f_d\in L_2(\Omega_d)$ and $g_{dN}\in L_2(\Gamma_{dN})$, $d=1,2$ and $p_w, p_D\in V$ fixed, such that
% \begin{equation}
% %     \norm{p}_V \leq \frac{1}{\alpha_1} \norm{l}_{V'}.
%     \norm{p_0}_V \leq \frac{1}{\alpha_1} \norm{l}_{V'} + \frac{\alpha_2}{\alpha_1}\big( \norm{p_w}_V+\norm{p_D}_V \big).
% \end{equation}
% \end{theorem}
% 
% %
% We point out a~practical consequence of Theorem \ref{thm:prim_lax_milgram_theorem} and the argumentation in the proof of coercivity of $a$.
% One can observe that the uniqueness of the solution can be attained by fixing the pressure at the top of a~single well
% (e.g. a~pumping well where the pressure can be measured), possibly with Neumann boundary condition at the rest of the boundary.
% This might be useful when there is limiting amount of data on aquifer and no flow boundary condition is considered.
% 
% Eventually, we add a~practical assumption and we approximate the pressure fluctuation $g^m_w\approx 0$.
% This assumption is based on the wells being very small in diameter, $\rho_w << |\Omega^m_2|$,
% and so that pressure is changing minimally along $\Gamma^m_w$.
% Then we put $a(p_w,q)\approx 0$ in Problem \eqref{thm:problem_2d_prim_weak}
% and thus we effectively neglect the given boundary condition for the pressure fluctuation in \eqref{eqn:prim_problem_2d_press_fluct}.
% The practical impact of this assumption is the reduction of input data, since in real cases
% it is apparently impossible to measure $g^m_w$.
% %
% In \cite{koppl_vidotto_2018}, a~similar assumption is taken and the fluctuation term in the weak form is neglected
% \begin{equation} \label{eqn:well_edge_fluctuation_neglect}
%     \int_{\Gamma^m_w} \fluct{p_2}^m_w\fluct{q_2}^m_w \dd s \simeq 0.
% \end{equation}
% Effects of this assumption are studied in details there and an error estimate is provided.


% \newpage
\section{Discretization}
\label{sec:prim_discretization}

Problem \ref{thm:problem_2d_prim_weak} is discretized using linear FE and XFEM enrichment
in the aquifers domains in the vicinity of the singularities.
The 2d part of the discrete solution is searched in the form
\begin{equation} \label{eqn:prim_xfem_standard_form}
  p_{2h}(\bx) = \sum_{\alpha\in\mathcal{I}_{2N}}a_\alpha N_{2\alpha}(\bx)
    + \sum_{w\in\mathcal{W}} \sum_{\alpha\in\mathcal{J}^w_{2N}} b_{\alpha w} N_{2\alpha}(\bx) L_{\alpha w}(\bx)
\end{equation}
where $\mathcal{J}^w_{2N}\subset\mathcal{I}_{2N}$ denotes the indices of enriched nodes in $\mathcal{T}_2$ 
by the well $w$, and the functions $N_{2\alpha}L_{\alpha w}$ are the local enrichment functions,
while $N_{2\alpha}$, the linear FE shape functions, are playing the role of PU.

The local enrichment is chosen according to particular choice of the enrichment type in Section \ref{sec:enrichment_methods}.
The singular global enrichment function is defined below.

% We now choose a~particular XFEM discretization, using the methods described in Section \ref{sec:enrichment_methods},
% and apply it to the weak form \eqref{eqn:prim_weak_form}.
% 
% We omit the upper index $m$, denoting aquifer, till the end of this section for the sake of the simplicity of notation.
% Extension to the multi-aquifer system is straightforward. In fact in case of the pressure model, we suppose the aquifers
% to be parallel 2d planes, defined in the $xy$ axes at different levels of $z$-axis. 
% The wells are considered perpendicular to the aquifers (i.e. in $z$-axis) and all have a~constant radius.
% Therefore we use the same triangulation for every aquifer in our implementation and therefore the discrete spaces are also identical.
% This simplification is of solely technical nature and does not mean any loss of generality of the used discretization schemes.
% The XFEM is used to couple the 1d and 2d domains and to better approximate the singular solution in the aquifer,
% so only the finite element space of the 2d domain is extended.
% 
% Now we look for the finite dimensional space $V_h$ of the continuous space $V$ introduced in the weak form \eqref{eqn:prim_weak_form},
% so that $V_h\subset V$. We build the discrete space on domains of each dimension
% \begin{equation}
%     V_h = V_{1h} \times V_{2h}, \qquad V_{2h} = V_{2h}^{reg} \oplus V_{2h}^{enr}
% \end{equation}
% where $V_{2h}$ consists of the regular part and the enriched part which we define later below.
% 
% We denote a~patch $\omega_{d\alpha}$ which is the union of elements sharing a node $\bx_\alpha\in\mathcal{T}_d$
% \[
%     \omega_{d\alpha} = \{ T_d^i: \bx_\alpha \in T_d^i, i\in\mathcal{I}_{dE}\}, \quad \alpha\in\mathcal{I}_{dN}.
% \]
% Next, let $N_{d \alpha}(\vc x)$ be the standard linear finite element shape functions associated with
% nodes $\bx_\alpha$, having support on $\overbar\omega_{d,\alpha}$ and satisfying the Kronecker delta property
% $N_{d \alpha}(\bx_\beta)=\delta_{\alpha\beta},\, \alpha,\beta\in\mathcal{I}_{dN}$.
% Then we can define
% \begin{equation}
%     V_{dh}^{reg} = \spn\{N_\alpha\}, \quad \alpha\in\mathcal{I}_{dN},\, d=1,2,
% \end{equation}
% understanding that $V_{1h} = V_{1h}^{reg}$ in our problem.
% Similarly we define the enriched space
% \begin{equation}
%     V_{2h}^{enr} = \spn\{N_{2\alpha} L_{\alpha w}\}, \quad \alpha\in\mathcal{J}^w_{2N},\, w\in\mathcal{W},
% \end{equation}
% where $\mathcal{J}^w_{2N}\subset\mathcal{I}_{2N}$ denotes the indices of enriched nodes in $\mathcal{T}_2$ 
% by the well $w$, and
% the functions $N_{2\alpha}L_{\alpha w}$ are the local enrichment functions as in \eqref{eqn:soa_xfem_standard_form_mult2},
% while $N_{2\alpha}$ are playing the role of PU.
% Thus we can write the enriched solution in the form
% \begin{equation} \label{eqn:prim_xfem_standard_form}
%   p_{2h}(\bx) = \sum_{\alpha\in\mathcal{I}_{2N}}a_\alpha N_{2\alpha}(\bx)
%     + \sum_{w\in\mathcal{W}} \sum_{\alpha\in\mathcal{J}^w_{2N}} b_{\alpha w} N_{2\alpha}(\bx) L_{\alpha w}(\bx),
% \end{equation}
% where $a_\alpha$ are the standard degrees of freedom and $b_{\alpha w}$ are the degrees of freedom coming from
% the enrichment of the well $w$.
% 
% We point out that the selected discrete space $V^{reg}_{2h} \not\subset V$ and thus $V_{2h} \not\subset V$.
% This is due to the fact that the linear shape functions cannot have zero fluctuations on $\Gamma^m_w$,
% which contradicts the property of the continuous test space in \eqref{eqn:prim_weak_space_Vm0}.
% In this view, our discretization is non-conforming.
% 
% From the physical perspective, the pressure in the vicinity of the well is above all governed by the large difference between the pressure inside the well and in the aquifer.
% Then the fluctuations of the linear shape functions will be small, influenced mainly by the regular part of the solution and the size of elements.
% If the elements intersecting the well are large, then the fluctuations will be even less significant.
% The fluctuations might increase when element size closes up to the scale of the well, but then this is not the case
% we are the most interested in and the singular XFEM enrichment is unnecessary.
% As it will be observed later in the numerical experiments, the non-conformity does not corrupt
% the convergence of the method and does not increase the approximation error in the problems of our interest.
% 
% We now look at the choice of the enrichment function $L_{\alpha w}$ in our particular case.
% Below we select a~proper global enrichment function and then define $L_{\alpha w}$ according
% to one of the XFEM.


% \subsection{Enrichment Function}
% \label{sec:enrichment_func}
 The global enrichment function can be obtained from the solution of a~local problem on the neighborhood of the well.
 In this case, it is a~logarithmic function radially symmetric around the well cross-section $\bx_w=[x_w, y_w]$:
\begin{equation} \label{eqn:enrich_func}
s_w(\bx) = 
  \begin{cases}
  \log(r_w(\bx)) & r_w > \rho_w,\\
  \log(\rho_w) & r_w \le \rho_w,\\
  \end{cases}
\end{equation}
where $r_w(\bx) = \|\bx - \bx_w\|= \sqrt{(x-x_w)^2+(y-y_w)^2}$ is the distance function.

The XFEM and the SGFEM apply the enrichment functions only locally. 
Due to the radial character, it is natural to consider a~circular enriched domain $Z_w = B_{R_w}(\vc x_w)$
of the well $w$ given by the enrichment radius $R_w$.
Four different enrichments are defined according to Section Section \ref{sec:enrichment_methods}:
\emph{standard XFEM}, \emph{ramp function XFEM}, \emph{shifted XFEM} and \emph{SGFEM}; which are later compared.

% The index sets $\mathcal{J}^w_{2N}$, $\mathcal{J}^w_{2E}$ denotes enriched nodes (all nodes in $Z_w$) and enriched elements
% (having one or more enriched nodes), respectively.

% Thus for each well $w$ all the nodes of $\mathcal{T}_2$
% in $Z_w$ are enriched and we denote the enriched element indices by
% \begin{equation} \label{eqn:prim_enriched_nodes}
%     \mathcal{J}^w_{2N} = \{\alpha\in\mathcal{I}_{2N}:\, \bx_\alpha\in Z_w, \, w\in\mathcal{W}\}.
% \end{equation}
% We also define the index set of enriched elements, i.e. elements in which at least one node is enriched
% \begin{equation} \label{eqn:prim_enriched_elements}
%     \mathcal{J}^w_{2E} = \{i\in\mathcal{I}_{2E}:\, \bx_\alpha\in T^i_2,\, \alpha\in\mathcal{J}^w_{2N},\, w\in\mathcal{W} \}.
% \end{equation}
% on elements $T_2^i$ with enriched nodes $\bx_\alpha\in{T_2^i},\, i\in\mathcal{I}_{2E}$,

% We define the following enrichment schemes, according to the section \ref{sec:enrichment_methods}, for $w\in\mathcal{W}$:
% \begin{align} 
%     L_{\alpha w} =& s_{w}(\bx), && \alpha\in\mathcal{J}^w_{2N} \label{eqn:prim_standard_xfem} \\
%     L_{\alpha w} =& G_w(\bx) s_{w}(\bx), && \alpha\in\mathcal{J}^{*w}_{2N}, \label{eqn:prim_xfem_ramp}\\
%     L_{\alpha w} =& G_w(\bx) \left[s_w(\bx) - s_w(\bx_\alpha)\right], && \alpha\in\mathcal{J}^{*w}_{2N}, \label{eqn:prim_xfem_shift}\\
%     L_{\alpha w}|_{T_2^j} =& \left[s_w(\bx) - \pi_{T_2^j} (s_w)(\bx)\right],
%         && \alpha\in\mathcal{J}^w_{2N},\, j\in\mathcal{J}^w_{2E}. \label{eqn:prim_sgfem_enrich}
% \end{align}



% The enrichment function can be obtained from the solution of a~local problem on the neighborhood of the well $w$.
% Let $\Omega$ be an annulus with center $\vc x_w$, inner radius $\rho_w$ and arbitrary outer radius $D \gg \rho_w$.
% The solution of the Laplace equation $-\Delta p = 0$ on $\Omega$ with any radially symmetric boundary conditions
% (e.g. in \cite{evans_partial_2010}, Section 2.2.1) has a~form
% %
% \begin{equation} \label{eqn:solution_form}
%   p = a \log(r_w)+b, %\quad \textrm{where }
% \end{equation}
% where $r_w$ is a~distance function
% \begin{equation} \label{eqn:distance}
% r_w(\bx) = \|\bx - \bx_w\|= \sqrt{(x-x_w)^2+(y-y_w)^2}.
% \end{equation}
% %
% Thus the pressure head would go to infinity while closing to the center of the well.
% Keeping in mind the radius of the well $\rho_w$ and the local solution \eqref{eqn:solution_form}, 
% we introduce a~(global) enrichment function
% %
% \begin{equation}
% \label{eqn:enrich_func}
% s_w(\bx) = 
%   \begin{cases}
%   \log(r_w(\bx)) & r_w > \rho_w,\\
%   \log(\rho_w) & r_w \le \rho_w,\\
%   \end{cases}
% \end{equation}
% see \fig{fig:enrich_func}, and its gradient
% \begin{equation} \label{eqn:enrich_grad}
% \grad s_w(\bx) = 
%   \begin{cases}  
%     \frac{1}{r_w^2(\bx)}(\bx - \bx_w) & r_w > \rho_w, \\
%     0 & r_w \leq \rho_w.
%   \end{cases}
% \end{equation}
% In case of more aquifers in the model, it is natural to use the same $s_w$ on each aquifer 
% since it depends only on $r_w(x,y)$ and the wells have constant center $\bx_w=[x_w, y_w]$ and radius $\rho_w$ along the $z$-axis.
% 
% \begin{figure}[!htb]
%   %\vspace{-15pt}
%   \begin{center}         
%     \def\svgwidth{0.5\textwidth}
%     \input{\figpath enrich_func.pdf_tex}
%   \end{center}
%   \caption{The logarithmic enrichment function.}
%   \label{fig:enrich_func}
% \end{figure}
% 
% 
% In contrast to global enrichment methods, the XFEM and the SGFEM apply the enrichment functions only locally. 
% Since the enrichment function is radial, it is natural to consider the enriched domain $Z_w = B_{R_w}(\vc x_w)$
% of the well $w$ given by the enrichment radius $R_w$. Thus for each well $w$ all the nodes of $\mathcal{T}_2$
% in $Z_w$ are enriched and we denote the enriched element indices by
% \begin{equation} \label{eqn:prim_enriched_nodes}
%     \mathcal{J}^w_{2N} = \{\alpha\in\mathcal{I}_{2N}:\, \bx_\alpha\in Z_w, \, w\in\mathcal{W}\}.
% \end{equation}
% We also define the index set of enriched elements, i.e. elements in which at least one node is enriched
% \begin{equation} \label{eqn:prim_enriched_elements}
%     \mathcal{J}^w_{2E} = \{i\in\mathcal{I}_{2E}:\, \bx_\alpha\in T^i_2,\, \alpha\in\mathcal{J}^w_{2N},\, w\in\mathcal{W} \}.
% \end{equation}
% on elements $T_2^i$ with enriched nodes $\bx_\alpha\in{T_2^i},\, i\in\mathcal{I}_{2E}$,
% 
% We define the following enrichment schemes, according to the section \ref{sec:enrichment_methods},
% which we later compare in numerical tests. At first we use the simplest scheme
% \begin{equation} \label{eqn:prim_standard_xfem}
%     L_{\alpha w} = s_{w}(\bx), \quad \alpha\in\mathcal{J}^w_{2N}, w\in\mathcal{W}.
% \end{equation}
% which we refer to as \textbf{standard XFEM} later in this section.
% %
% For the Corrected XFEM, we start with the ramp function $G$, see \eqref{eqn:xfem_ramp},
% having the local enrichment function in the form
% \begin{equation} \label{eqn:prim_xfem_ramp}
%     L_{\alpha w} = G_w(\bx) s_{w}(\bx), \quad \alpha\in\mathcal{J}^{*w}_{2N}, w\in\mathcal{W}.
% \end{equation}
% We call this scheme \textbf{ramp function XFEM}.
% Next the Corrected XFEM can also include the shifting, see \eqref{eqn:xfem_shift},
% \begin{equation} \label{eqn:prim_xfem_shift}
%     L_{\alpha w} = G_w(\bx) \left[s_w(\bx) - s_w(\bx_\alpha)\right],
%     \quad \alpha\in\mathcal{J}^{*w}_{2N}, w\in\mathcal{W},
% \end{equation} 
% which we refer to as the \textbf{shifted XFEM}.
% We remind that in the Corrected XFEM, the index set of the enriched nodes is extended due to the ramp function
% such that every node of elements that have non-zero intersection with the area $Z_w$ is enriched:
% \begin{equation} \label{eqn:prim_enriched_nodes_corr}
%     \mathcal{J}^{*w}_{2N} = \{\alpha\in\mathcal{I}_{2N}: \bx_\alpha\in T^j_2,\, j\in\mathcal{J}^w_{2E},\, w\in\mathcal{W}\},
% %     \mathcal{J}^{*w}_{2N} = \{\bx_\alpha: \bx_\alpha\in T^i_2,\, T^i_2\cap Z_w \neq \emptyset, \, i\in\mathcal{I}_{2E},\, \alpha\in\mathcal{I}_{2N} \} \quad \forall w\in\mathcal{W}.
% \end{equation}
% see \fig{fig:enrichment_zone_radial} above. Finally, we have the \textbf{SGFEM} scheme, see \eqref{eqn:sgfem_enrich},
% \begin{equation} \label{eqn:prim_sgfem_enrich}
%     L_{\alpha w}|_{T_2^j} = \left[s_w(\bx) - \pi_{T_2^j} (s_w)(\bx)\right],
%     \quad \alpha\in\mathcal{J}^w_{2N},\, j\in\mathcal{J}^w_{2E},\, w\in\mathcal{W},
% \end{equation}
% on enriched elements $T_2^j$,
% with the interpolation operator
% \begin{equation} \label{eqn:prim_sgfem_interpolation}
%     \pi_{T_2^j} (s_w)(\bx) = \sum_{\beta\in\mathcal{I}_N(T_2^j)} s_w(\bx_\beta) N_\beta(\bx).
% \end{equation}


% \subsection{Integration on Enriched Elements}
% \label{sec:integration}
In order to compute the entries of the system matrix, %\eqref{eqn:s_entry} and \eqref{eqn:r_entry} 
the expressions containing the enrichment functions have to be integrated accurately. 
% These of course can be non-polynomial, like they are 
% in our case. The standard quadrature rules are not appropriate any more, for they are constructed to integrate 
% precisely only polynomials up to a~given degree. The higher requirements on the integration precision
% are the price for using enrichment functions and a~coarse mesh.
% 
There are two aspects which the integration must handle properly:
\begin{itemize}
  \item the steep gradient of enrichment shape functions in the vicinity of the singularity,
  \item the singularity cut-off edge geometry.
\end{itemize}

The instability in the intergration in \cite{gracie_modelling_2010} is investigated.
An asymptotic analysis of the integration error is presented and new adaptive quadrature rules are defined.
Additionally, an~adaptive quadrature in polar coordinates is suggested.

% 
% One of the approaches to deal with these requirements is an adaptive quadrature. The element is further subdivided 
% to split the integration area into much smaller pieces (subelements), which better align with the well edge.
% On the subelements, standard quadrature rules are applied, possibly of higher order.
% This way the integration is more accurate, increasing the number of quadrature points per element, but not bringing
% any more degrees of freedom into the linear system. In this section we discuss the adaptivity rules for the element subdivision, 
% suggest an improvement and compare our strategy to the original one from which we have started, developed in \cite{gracie_modelling_2010}.
% 
% \subsubsection{Instability of Adaptive Quadrature}
% \label{sec:refinement_element}
% Gracie and Craig in \cite{gracie_modelling_2010} refine only subelements that cross the boundary of the well, using at most 12 refinements.
% This catches nicely the well edge but it works only when the well is placed at the node of an element or near the center of an element. 
% When the well is placed near the edge of an element, there can be
% a large difference in the size of neighboring subelements, see \fig{fig:adapt_ref_a}. Although
% the integrand is computed precisely enough on the element with the well inside, the quadrature points on the
% neighboring elements (where the integrand has still large derivatives) are placed very sparsely 
% and the integration error is large.
% 
% \begin{figure}[!htb]
% %   \vspace{0pt}
%   \centering    
%   \subfloat[refinement due to Gracie and Craig]{\label{fig:adapt_ref_a} 
%     \includegraphics[width=0.45\textwidth]{\figpath adaptive_refinement_3_old.pdf} }
%   \hspace{0pt}
%   \subfloat[improved refinement]{\label{fig:adapt_ref_b} 
%     \includegraphics[width=0.45\textwidth]{\figpath adaptive_refinement_3_new.pdf} }
%   \caption[Adaptive refinement comparison.]
%   {Comparison of the original and improved refinement techniques.
%    Black lines denote enriched elements edges, red lines denote adaptive refinement (subelements edges) and the well
%    edge is blue.
%   }
%   \label{fig:adapt_refinement}
% \end{figure}
% In order to overcome this instability of the adaptive quadrature, we have made an asymptotic analysis of the integration error presented 
% in the next section.
% 
% \subsubsection{Estimate of Quadrature Error}
% 
% Let us assume only one well of radius $\rho_w$ situated at the origin. In the case of elliptic equation, the term with the strongest singularity is 
% \begin{equation}
%     \label{eq:term-of-interest}
%     f(r_w)=(\nabla \log r_w )^2 \approx r_w^{-2}
% \end{equation}
% which is also the worst term to integrate independently of the particular XFEM enrichment variant.
% Consider a~square subelement $S$ with a~side $\delta$ and 
% let us denote $r_{S}$ its distance from the origin.
% We want to estimate the error of the 2d tensor product Gauss quadrature rule of order $n$ ($n$ times $n$ points) on the square $S$. 
% Let us denote 
% $\Pi^n f$ the projection of the integrand $f$ to the space of polynomials that are integrated exactly.
% We were not able to find error estimates for 2d quadratures in the literature and deriving them would be extremely technical.
% However, we can make an observation that among the squares of the same $r_{S}$, the quadrature error is the highest for the squares lying on one of the axis.
% Assume without loss of generality a~square on the $X$-axis. Since $\abs{y}<\delta \ll \abs{x}$, the monomials of $\Pi^n f$ containing $y$ 
% are negligible and we get the quadrature
% of order $n$ in the radial ($X$-axis) direction. On the other hand for the square on the diagonal of the axes, the bilinear terms of 
% a 2d quadrature effectively enhance its order to $2n$ in the radial (diagonal) direction. Due to the radial nature of the integrand,
% we can estimate the quadrature error on the square $S$ by the error on the square $S'$ with the same $r_S$ laying on the $X$-axis, then we can 
% neglect $y$~monomials and use the error estimates for the 1d quadrature:
% \begin{equation}
%   \int_S \abs{f-\Pi^n f} \dd\bx \le \int_{S'}\abs{f-\Pi^n f} \dd\bx \le \delta E^n((r_{S}, r_{S}+\delta)).
% \end{equation}
% The $E_n$ is the error of 1d Gauss quadrature of the order $n$ ($n$ quadrature points) over the interval $(r_w,r_w+\delta)$
% \begin{equation}
%   E_n = \frac{\delta^{2n+1} (n!)^4}{(2n+1)((2n)!)^3} f^{(2n)}(\xi_n) 
% \end{equation}
% for some $\xi_n \in (r_w, r_w+\delta)$, see e.g. \cite{kahaner_numerical_1989}. 
% The expression $f^{(2n)}$ denotes a~derivative of order $2n$ of a~function $f$.
% Regarding the integrand \eqref{eq:term-of-interest}, we have 
% \begin{equation}
%   \abs{f^{(2n)}(r_w)} = (2n+1)! r_w^{-(2n+2)}.
% \end{equation}
% Finally, we get an estimate for the quadrature error on a~single subelement:
% \begin{equation}
%     \int_S \abs{f-\Pi^n f}  \dd\bx \le  \alpha_n \left( \frac{\delta}{r_{S}} \right)^{2n+2}, 
%   \qquad \alpha_n = \left( \frac{(n!)^2}{(2n)!} \right)^2.
% \end{equation}
% This estimate implies that we have to ensure $\delta < r_S$ in order to get a~decent quadrature error 
% and possibly to employ a~higher order quadrature. 
% 
% 
% \subsubsection{A Priori Adaptive Quadrature Rules} \label{sec:adaptive_quad_rules}
% Let us denote $r_{min}$ the minimum and $r_{max}$ the maximum distance from a~particular subelement $S$ to the singularity center. 
% Based on the analysis presented above, we propose following adaptive quadrature rules:
% \begin{enumerate}
%  \item If $r_{max} < \rho_w$, the subelement is not refined and the quadrature is zero.
%  \item If $r_{min} < \rho_w < r_{max}$ and $\delta > 2^{-10}h$, the subelement is refined.
%  \item If $r_{min} < \rho_w < r_{max}$ and $\delta \le 2^{-10}h$, $3\times3$ Gauss quadrature is used.\\
%  The weights at quadrature points lying inside the well are set to zero.
%  \item If $r_{min} > \rho_w$ and $\delta > r_{min} / 2$, the subelement is refined.
%  \item If $r_{min} > \rho_w$ and $\delta \le r_{min} / 2$, $3\times3$ Gauss quadrature is used.
% \end{enumerate}
% 
% 
% These rules ensure $\delta < r_{min}/2$ outside the well, where the integrand is smooth. Subelements intersecting 
% the well's boundary are refined using at most $10$ refinement levels, since the integrand is discontinuous there and we cannot employ 
% estimates from the previous section. The maximum number of levels is chosen so that we get the similar total number of quadrature points 
% as in the quadrature used by Gracie and Craig in \cite{gracie_modelling_2010}. Using the proposed rules, the elements that do not contain the well are refined as well,
% see \fig{fig:adapt_ref_b}. 
% 
% By implementing this approach, all the variants of the XFEM enrichment methods converge with optimal order.
% as the results of the numerical tests will show in section \ref{sec:pressure_results}.
% 
% \subsubsection{Quadrature in Polar Coordinates}
% 
% The idea for the usage of the quadrature in polar coordinates originates from the radial character of the terms
% that are integrated. 
% The motivation is to reduce the number of quadrature points (refinement levels) of the previously described quadrature due to
% precise representation of the well edge and/or increase of accuracy.
% 
% We define a~circular neighborhood of a~well, i.e. a~band of width $\gamma$ (see \fig{fig:well_band}),
% \begin{equation}
%     \mathcal{P} = \{\vc{x}: \rho_w < \abs{\vc{x} - \vc{x}_w} < \rho_w + \gamma \}.
% \end{equation} 
% Next we define a~smooth step function (see \fig{fig:smooth_step})
% \begin{equation}
%     \mu(z) = -2 z^3 +3 z^2,\quad z=\frac{r_w-\rho_w}{\gamma}.
% \end{equation} 
% %
% \begin{figure}[!htb]
%   \vspace{-35pt}
%   \centering    
%   \subfloat[well neighborhood $\mathcal{P}$]{\label{fig:well_band} 
%           \def\svgwidth{0.35\textwidth}
%           \input{\figpath well_band.pdf_tex}
%   }
%   \hspace{0pt}
%   \subfloat[smooth step function]{\label{fig:smooth_step} 
%           \def\svgwidth{0.5\textwidth}
%           \input{\figpath smooth_step.pdf_tex}
%   }
%   \caption[Smooth step function in polar quadrature.]
%   {Smooth step function $\mu$ on the well neighborhood $\mathcal{P}$.
%   }
%   \label{fig:smooth_step_well_band}
% \end{figure}    
% 
% We use $\mu$ as a~partition of unity to divide an integral into 2 parts
% \begin{eqnarray} 
%       \int\limits_S v(\mathbf{x}) \dd \mathbf{x} &=& \int\limits_S \mu(r_w) v(\mathbf{x}) \dd \mathbf{x} + \int\limits_S (1-\mu(r_w)) v(\mathbf{x}) \dd \mathbf{x} \nonumber\\
%       &=& \int\limits_S \mu(r_w) v(\mathbf{x}) \dd \mathbf{x} + \int\limits_0^{2\pi} \int\limits_{\rho_w}^{\rho_w+\gamma} (1-\mu(r_w)) v(\mathbf{x}) r_w \dd r \dd \phi.
% \end{eqnarray}
% %
% \begin{figure}[!b]
% %   \vspace{0pt}
%   \centering    
%   \subfloat[$\int\limits_\Omega \mu(r_w) v(\mathbf{x}) \dd \mathbf{x}$]{\label{fig:adapt_ref_polar_a} 
%          \includegraphics[width=0.47\textwidth]{\figpath adaptive_refinement_well.pdf}
%   }
%   \hspace{0pt}
%   \subfloat[$\int\limits_0^{2\pi} \int\limits_{\rho_w}^{\rho_w+\gamma} (1-\mu(r_w)) v(\mathbf{x}) r_w \dd r \dd \phi $]{\label{fig:adapt_ref_polar_b} 
%           \includegraphics[width=0.47\textwidth]{\figpath polar_band_refinement.pdf}
%   }
%   \caption[Polar quadrature points.]
%   {Distribution of quadrature points of the two integral parts.
%   }
%   \label{fig:polar_quad_points}
% \end{figure} 
% 
% We see that the first integral vanishes when closing to the well edge, while the second grows. This corresponds
% to the character of the solution which is more radial in the vicinity of the well rather than far away from it.
% Therefore we transform the second integral into polar coordinates $\mathbf{x} \longleftrightarrow (r_w,\phi)$. 
% The first integral is computed using the previously described quadrature, but with much less refinement
% levels, since the well edge is now represented precisely (see \fig{fig:polar_quad_points} with
% an example of quadrature points distribution).
% 
% The adaptive integration in polar coordinates has been implemented and tested.
% However, the results of are not satisfying as expected. The quadrature accuracy is very dependent on the choice of
% the band width around the well, position of the well relative to nodes of the mesh and also to the size of nearby elements.
% When playing long enough with the setting, an optimal convergence rate can be reached, but no general and robust 
% setting has been found. The quadrature points generated in the band also demand more efficient mapping onto elements and a~reference element
% for the shape functions to be evaluated.
% The problem would need a~deeper investigation and we leave it open for now.
% The previously described quadrature is stable and accurate enough and that is sufficient for our purposes. 

\section{Single Aquifer Analytic Solution} \label{sec:prim_analytic_solution}
A~pseudo-analytic solution is defined in this section. Considering multiple singularities in the domain,
the solution can be obtained using the superposition principle.
The solution is split into singular and regular part and searched in the form
\begin{equation}
p_2 = p_{sin} + p_{reg} = \sum\limits_{j\in\mathcal{W}} a_j\log r_j + p_{reg}. \label{eqn:2d_press_sol_mult}\\
\end{equation}
The averages $\avg{\cdot}_w$ are evaluated numerically.

% using simple composite midpoint rule integration with 1000 equidistant intervals on $\Gamma_i$.

% We define a~simple problem where analytical solution is available and 
% on which we later test and compare the enrichment methods.
% To this end, we restrict ourselves to a~single aquifer model.
% In contrast to our article \cite{exner_2016}, the set of problems with analytical solution 
% has been broaden to include multiple wells and to support arbitrary regular function in the source term.
% 
% We rewrite Problem \ref{thm:problem_2d_prim}, considering a~single aquifer and wells having one end point
% at the cross-section with the aquifer $\bx_w$ and the other end point at the surface level denoted $\bx^w_D$.
% Let us suppose the parameters of the model $\delta_2, \vc K_2, \vc K_1$ to be constants, and
% the hydraulic conductivity $\vc K_2 = K_2,\, \vc K_1 = K_1$ to be scalars.
% Zero source term $f_1=0$ is considered in the wells, so the flux there is governed only by the Dirichlet
% boundary condition at $\bx^w_D$ and the flux to/from aquifer which forms the Neumann boundary condition at $\bx_w$.
% Therefore the flux is constant and the pressure is linear in the wells:
% \begin{equation} \label{eqn:linear_pressure_in_1d}
%     -\delta^w_1 K^w_1 \grad p_1 = -\frac{\delta^w_1 K^w_1}{\bx^w_D-\bx_w} \big( g^w_{1D} - p_1(\bx_w) \big) \qquad \textrm{in } \Omega^w_1,\,\forall w\in\mathcal{W}
% \end{equation}
% The denominator $(\bx^w_D-\bx_w)$ is in fact the length of the well $\abs{\Omega^w_1}$.
% The constant ${\delta^w_1 K^w_1}/\abs{\Omega^w_1}$ can be seen as the permeability of the well $c_w$ between aquitards
% in the original work \cite{exner_2016}.
% 
% Then we have a~simplified problem:
% \begin{thmproblem} \label{thm:prim_simple_problem}
% Find $[p_1,\,p_2]$ satisfying
% \begin{subequations}
% \begin{align}
% -K_2 \Lapl p_2 &= f_2 && \textrm{ in } \Omega_2 \label{eqn:prim_simple_poisson}\\
% -K_2\avg{\grad p_2 \cdot \vc n}_w &= \sigma_w\big( \avg{p_2}_w - p_1(\bx_w)\big)
%     && \forall w\in\mathcal{W} \label{eqn:prim_simple_well_edge_bc} \\
% p_2 &= g_{2D} && \textrm{ on } \Gamma_{ext} = \Gamma_{2D}, \label{eqn:prim_simple_dirichlet} \\
% p_1(\bx^w_D) &= g^w_{1D} && \forall w\in\mathcal{W} \label{eqn:prim_simple_well_top_bc} \\
% -\frac{\delta^w_1 K^w_1}{\abs{\Omega^w_1}} \big(g^w_{1D} - p_1(\bx_w)\big) &=  \abs{\Gamma_w} \delta_2 \sigma_w\big( \avg{p_2}_w - p_1(\bx_w)\big) 
%     && \forall w\in\mathcal{W}\label{eqn:prim_simple_well_flow}
% \end{align}
% \end{subequations}
% \end{thmproblem}
% 
% We now look for the analytic solution $[p_1, p_2]$ of Problem \ref{thm:prim_simple_problem}.
% Well pressure is fully determined by finding the value $p_1(\bx_w)$.
% 
% Considering multiple singularities in the domain, we can obtain the solution using the superposition principle.
% The solution is searched in the form
% \begin{equation}
% p_2 = p_{sin} + p_{reg} = \sum\limits_{j\in\mathcal{W}} a_j\log r_j + p_{reg}, \label{eqn:2d_press_sol_mult}\\
% \end{equation}
% where we split $p_2$ into a~singular and a~regular part. Function $p_{reg}$ is considered to be a~smooth function
% which can be well approximated by standard finite elements (with optimal convergence rate).
% Having the pressure in \eqref{eqn:2d_press_sol_mult}, we also derive its gradient and average terms
% \begin{eqnarray}
% \grad p_2 &=& \sum\limits_{j\in\mathcal{W}} a_j\frac{\vc r_j}{r_j^2} + \grad p_{reg}, \label{eqn:2d_press_grad_sol_mult}\\
% \avg{p_2}_i &=& a_i\log\rho_i + \sum\limits_{\substack{j\in\mathcal{W}\\ j\neq i}} a_j \avg{\log r_j}_i + \avg{p_{reg}}_i, \label{eqn:2d_avg_press_sol_mult}\\
% \avg{\grad p_2 \cdot \vc n_i}_i &=& -a_i\frac{1}{\rho_i} + \sum\limits_{\substack{j\in\mathcal{W}\\ j\neq i}} 
%         a_j \avg{\frac{\vc r_j \cdot \vc n_i}{r_j^2}}_i + \avg{\grad p_{reg} \cdot \vc n_i}_i, \label{eqn:2d_avg_press_grad_sol_mult}
% \end{eqnarray}
% 
% The singular part $p_{sin}$ solves \eqref{eqn:prim_simple_poisson} with zero right hand side since logarithm is a~harmonic function.
% The source $f_2$ is sought such that the chosen regular part $p_{reg}$ is the solution of \eqref{eqn:prim_simple_poisson}, i.e.
% \begin{equation}
%     f_2 = -K_2 \Lapl p_{reg}.
% \end{equation}
% To find the unknowns $a_w$ and $p_1(\bx_w)$, we need to solve a~system of linear equations
% which we obtain by substituting \eqref{eqn:2d_press_sol_mult}-\eqref{eqn:2d_avg_press_grad_sol_mult}
% into the two conditions \eqref{eqn:prim_simple_well_edge_bc} and \eqref{eqn:prim_simple_well_flow}.
% We then assemble the $2W\times 2W$ linear system $\vc M\vc a = \vc b$ where
% \begin{subequations}
% \label{eqn:2d_press_linear_system}
% \begin{align}
% M_{ij} &= \delta_{ij} K_2\avg{\frac{\vc r_j \cdot \vc n_i}{r_j^2}}_i - \sigma_i\avg{\log r_j}_i && i,j=1\ldots W, \\
% %
% M_{ii} &= \abs{\Gamma_i}\delta_2\sigma_i + \frac{\delta^i_1 K^i_1}{\bx^i_D-\bx_i} && i=W+1 \ldots 2W,\\
% %
% M_{ij} &= \sigma_i && i=1\ldots W,\\
%     &&& j=W+1 \ldots 2W,\\
% M_{ij} &= -\abs{\Gamma_i}\delta_2\sigma_i \avg{\log r_j} && i=W+1 \ldots 2W,\\
%     &&& j=1 \ldots W,\\
% b_{i} &= K_2 \avg{\grad p_{reg}\cdot \vc n_i}_i + \sigma_i\avg{p_{reg}}_i && i=1 \ldots W,\\
% b_{i} &= \abs{\Gamma_i}\delta_2\sigma_i \avg{p_{reg}}_i + \frac{\delta^i_1 K^i_1}{\bx^i_D-\bx_i}g^i_{1D} && i=W+1\ldots 2W.
% \end{align}
% \end{subequations}
% We evaluate all the averages $\avg{\cdot}_i$ in the linear system numerically,
% using simple composite midpoint rule integration with 1000 equidistant intervals on $\Gamma_i$.
% This way we obtain pseudo-analytic solution of the multi well problem, which is accurate enough
% to be used for measuring the error of our model.
% The analytical solution \eqref{eqn:2d_press_sol_mult} is then used 
% to define the boundary function $g_{2D} = p_2|_{\Gamma_D}$ in \eqref{eqn:prim_simple_dirichlet}.
